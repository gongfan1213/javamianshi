# ZooKeeper æ•°æ®æ¨¡å‹

## ğŸŒ³ å±‚æ¬¡å‘½åç©ºé—´

ZooKeeperçš„æ•°æ®æ¨¡å‹ç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•æ ‘ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç§°ä¸ºZNodeï¼ˆZooKeeper Nodeï¼‰ã€‚

```
/
â”œâ”€â”€ app1/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ database.properties
â”‚   â”‚   â””â”€â”€ redis.properties
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ user-service
â”‚   â”‚   â””â”€â”€ order-service
â”‚   â””â”€â”€ locks/
â”‚       â””â”€â”€ distributed-lock
â”œâ”€â”€ app2/
â”‚   â””â”€â”€ config/
â””â”€â”€ global/
    â”œâ”€â”€ cluster-info
    â””â”€â”€ system-status
```

## ğŸ“ ZNodeç»“æ„è¯¦è§£

### 1. ZNodeç»„æˆ
æ¯ä¸ªZNodeåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
- **æ•°æ®å†…å®¹**ï¼šå­—èŠ‚æ•°ç»„ï¼Œæœ€å¤§1MB
- **å…ƒæ•°æ®**ï¼šç‰ˆæœ¬å·ã€åˆ›å»ºæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ç­‰
- **å­èŠ‚ç‚¹åˆ—è¡¨**ï¼šæŒ‡å‘å­èŠ‚ç‚¹çš„å¼•ç”¨

### 2. ZNodeç±»å‹

#### æŒä¹…èŠ‚ç‚¹ï¼ˆPersistentï¼‰
```bash
# åˆ›å»ºæŒä¹…èŠ‚ç‚¹
create /app/config "database.properties"

# ç‰¹ç‚¹ï¼š
# - åˆ›å»ºåæ°¸ä¹…å­˜åœ¨
# - é™¤éæ‰‹åŠ¨åˆ é™¤
# - é€‚åˆå­˜å‚¨é…ç½®ä¿¡æ¯
```

#### ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEphemeralï¼‰
```bash
# åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
create -e /app/services/user-service "192.168.1.100:8080"

# ç‰¹ç‚¹ï¼š
# - ä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨åˆ é™¤
# - é€‚åˆæœåŠ¡æ³¨å†Œ
# - ç”¨äºæ•…éšœæ£€æµ‹
```

#### é¡ºåºèŠ‚ç‚¹ï¼ˆSequentialï¼‰
```bash
# åˆ›å»ºé¡ºåºèŠ‚ç‚¹
create -s /app/locks/lock- "lock-data"

# ç»“æœï¼š/app/locks/lock-0000000001
# ç‰¹ç‚¹ï¼š
# - è‡ªåŠ¨æ·»åŠ é€’å¢åºå·
# - ä¿è¯åˆ›å»ºé¡ºåº
# - é€‚åˆå®ç°åˆ†å¸ƒå¼é”
```

#### ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEphemeral Sequentialï¼‰
```bash
# åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
create -e -s /app/locks/lock- "lock-data"

# ç‰¹ç‚¹ï¼š
# - ä¸´æ—¶èŠ‚ç‚¹ + é¡ºåºèŠ‚ç‚¹
# - ä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨åˆ é™¤
# - é€‚åˆå®ç°å…¬å¹³çš„åˆ†å¸ƒå¼é”
```

## ğŸ” èŠ‚ç‚¹å±æ€§è¯¦è§£

### 1. æŸ¥çœ‹èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
```bash
# è·å–èŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
stat /app/config

# è¾“å‡ºç¤ºä¾‹ï¼š
cZxid = 0x100000001
ctime = Mon Jan 01 00:00:00 CST 2024
mZxid = 0x100000001
mtime = Mon Jan 01 00:00:00 CST 2024
pZxid = 0x100000001
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 20
numChildren = 0
```

### 2. å±æ€§å­—æ®µè¯´æ˜
- **cZxid**ï¼šåˆ›å»ºèŠ‚ç‚¹çš„äº‹åŠ¡ID
- **ctime**ï¼šåˆ›å»ºæ—¶é—´
- **mZxid**ï¼šæœ€åä¿®æ”¹çš„äº‹åŠ¡ID
- **mtime**ï¼šæœ€åä¿®æ”¹æ—¶é—´
- **pZxid**ï¼šæœ€åä¿®æ”¹å­èŠ‚ç‚¹çš„äº‹åŠ¡ID
- **cversion**ï¼šå­èŠ‚ç‚¹ç‰ˆæœ¬å·
- **dataVersion**ï¼šæ•°æ®ç‰ˆæœ¬å·
- **aclVersion**ï¼šACLç‰ˆæœ¬å·
- **ephemeralOwner**ï¼šä¸´æ—¶èŠ‚ç‚¹æ‰€æœ‰è€…ä¼šè¯ID
- **dataLength**ï¼šæ•°æ®é•¿åº¦
- **numChildren**ï¼šå­èŠ‚ç‚¹æ•°é‡

## ğŸš€ æ•°æ®æ“ä½œAPI

### 1. åˆ›å»ºèŠ‚ç‚¹
```java
// åˆ›å»ºæŒä¹…èŠ‚ç‚¹
String path = zk.create("/app/config", "database.properties".getBytes(), 
                       ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);

// åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
String path = zk.create("/app/services/user-service", "192.168.1.100:8080".getBytes(),
                       ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);

// åˆ›å»ºé¡ºåºèŠ‚ç‚¹
String path = zk.create("/app/locks/lock-", "lock-data".getBytes(),
                       ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
```

### 2. è¯»å–èŠ‚ç‚¹
```java
// è·å–èŠ‚ç‚¹æ•°æ®
byte[] data = zk.getData("/app/config", false, null);
String content = new String(data);

// è·å–èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯
Stat stat = new Stat();
byte[] data = zk.getData("/app/config", false, stat);
System.out.println("æ•°æ®ç‰ˆæœ¬: " + stat.getVersion());
System.out.println("å­èŠ‚ç‚¹æ•°é‡: " + stat.getNumChildren());
```

### 3. æ›´æ–°èŠ‚ç‚¹
```java
// æ›´æ–°èŠ‚ç‚¹æ•°æ®
Stat stat = zk.setData("/app/config", "updated-config".getBytes(), -1);

// æ¡ä»¶æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰
Stat stat = zk.setData("/app/config", "new-config".getBytes(), stat.getVersion());
```

### 4. åˆ é™¤èŠ‚ç‚¹
```java
// åˆ é™¤èŠ‚ç‚¹ï¼ˆåªèƒ½åˆ é™¤æ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼‰
zk.delete("/app/config", -1);

// æ¡ä»¶åˆ é™¤
zk.delete("/app/config", stat.getVersion());
```

### 5. åˆ—å‡ºå­èŠ‚ç‚¹
```java
// è·å–å­èŠ‚ç‚¹åˆ—è¡¨
List<String> children = zk.getChildren("/app", false);
for (String child : children) {
    System.out.println("å­èŠ‚ç‚¹: " + child);
}
```

## ğŸ‘€ ç›‘å¬æœºåˆ¶ï¼ˆWatcherï¼‰

### 1. ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
```java
// ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
Watcher dataWatcher = new Watcher() {
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDataChanged) {
            System.out.println("èŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–: " + event.getPath());
            // é‡æ–°æ³¨å†Œç›‘å¬å™¨
            try {
                zk.getData(event.getPath(), this, null);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
};

// æ³¨å†Œç›‘å¬å™¨
zk.getData("/app/config", dataWatcher, null);
```

### 2. ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
```java
// ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
Watcher childrenWatcher = new Watcher() {
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeChildrenChanged) {
            System.out.println("å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–: " + event.getPath());
            // é‡æ–°æ³¨å†Œç›‘å¬å™¨
            try {
                zk.getChildren(event.getPath(), this);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
};

// æ³¨å†Œç›‘å¬å™¨
zk.getChildren("/app", childrenWatcher);
```

### 3. ç›‘å¬èŠ‚ç‚¹åˆ›å»º/åˆ é™¤
```java
// ç›‘å¬èŠ‚ç‚¹åˆ›å»º/åˆ é™¤
Watcher existsWatcher = new Watcher() {
    public void process(WatchedEvent event) {
        switch (event.getType()) {
            case NodeCreated:
                System.out.println("èŠ‚ç‚¹åˆ›å»º: " + event.getPath());
                break;
            case NodeDeleted:
                System.out.println("èŠ‚ç‚¹åˆ é™¤: " + event.getPath());
                break;
        }
    }
};

// æ³¨å†Œç›‘å¬å™¨
zk.exists("/app/new-node", existsWatcher);
```

## ğŸ” è®¿é—®æ§åˆ¶ï¼ˆACLï¼‰

### 1. ACLæƒé™ç±»å‹
- **READ**ï¼šè¯»å–èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨
- **WRITE**ï¼šè®¾ç½®èŠ‚ç‚¹æ•°æ®
- **CREATE**ï¼šåˆ›å»ºå­èŠ‚ç‚¹
- **DELETE**ï¼šåˆ é™¤å­èŠ‚ç‚¹
- **ADMIN**ï¼šè®¾ç½®ACLæƒé™

### 2. ACLç¤ºä¾‹
```java
// åˆ›å»ºåªè¯»æƒé™çš„èŠ‚ç‚¹
List<ACL> acls = Arrays.asList(new ACL(ZooDefs.Perms.READ, 
                                       new Id("world", "anyone")));
zk.create("/app/readonly", "readonly-data".getBytes(), acls, CreateMode.PERSISTENT);

// åˆ›å»ºå¸¦å¯†ç çš„èŠ‚ç‚¹
List<ACL> acls = Arrays.asList(new ACL(ZooDefs.Perms.ALL, 
                                       new Id("digest", "user:password")));
zk.create("/app/secure", "secure-data".getBytes(), acls, CreateMode.PERSISTENT);
```

## ğŸ’¡ æ•°æ®æ¨¡å‹æœ€ä½³å®è·µ

### 1. èŠ‚ç‚¹è®¾è®¡åŸåˆ™
- **å±‚æ¬¡æ¸…æ™°**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„è·¯å¾„ç»“æ„
- **å‘½åè§„èŒƒ**ï¼šéµå¾ªç»Ÿä¸€çš„å‘½åçº¦å®š
- **æ•°æ®å¤§å°**ï¼šå•ä¸ªèŠ‚ç‚¹æ•°æ®ä¸è¶…è¿‡1MB
- **èŠ‚ç‚¹ç±»å‹**ï¼šæ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹ç±»å‹

### 2. ç›‘å¬å™¨ä½¿ç”¨å»ºè®®
- **åŠæ—¶é‡æ–°æ³¨å†Œ**ï¼šç›‘å¬å™¨è§¦å‘åéœ€è¦é‡æ–°æ³¨å†Œ
- **é¿å…ç›‘å¬è¿‡å¤š**ï¼šç›‘å¬å™¨è¿‡å¤šä¼šå½±å“æ€§èƒ½
- **å¤„ç†å¼‚å¸¸æƒ…å†µ**ï¼šç›‘å¬å™¨å¯èƒ½å› ä¸ºç½‘ç»œé—®é¢˜å¤±æ•ˆ

### 3. ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥
- **ä¹è§‚é”**ï¼šä½¿ç”¨ç‰ˆæœ¬å·è¿›è¡Œæ¡ä»¶æ›´æ–°
- **ç‰ˆæœ¬æ£€æŸ¥**ï¼šæ›´æ–°å‰æ£€æŸ¥ç‰ˆæœ¬å·
- **å†²çªå¤„ç†**ï¼šç‰ˆæœ¬å†²çªæ—¶çš„é‡è¯•ç­–ç•¥

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [ZooKeeperæ ¸å¿ƒç‰¹æ€§](./04.ZooKeeperæ ¸å¿ƒç‰¹æ€§.md) - å­¦ä¹ æ ¸å¿ƒåŠŸèƒ½
- [Javaå®¢æˆ·ç«¯ä½¿ç”¨](./06.Javaå®¢æˆ·ç«¯ä½¿ç”¨.md) - å¼€å§‹Javaç¼–ç¨‹
- [åˆ†å¸ƒå¼é”å®ç°](./07.åˆ†å¸ƒå¼é”å®ç°.md) - å®è·µåº”ç”¨

---

**è®°ä½ï¼šZNodeæ˜¯ZooKeeperçš„æ ¸å¿ƒæ¦‚å¿µï¼Œç†è§£å®ƒå°±èƒ½æŒæ¡æ•°æ®æ“ä½œï¼** ğŸ¯
