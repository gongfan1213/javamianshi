# ZooKeeper å®æˆ˜é¡¹ç›®

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬å®æˆ˜é¡¹ç›®å°†å¸¦ä½ å®ç°ä¸€ä¸ªå®Œæ•´çš„åŸºäºZooKeeperçš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒåŒ…å«é…ç½®ä¸­å¿ƒã€æœåŠ¡å‘ç°ã€åˆ†å¸ƒå¼é”ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### é¡¹ç›®æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  ç”¨æˆ·æœåŠ¡   â”‚  â”‚  è®¢å•æœåŠ¡   â”‚  â”‚  æ”¯ä»˜æœåŠ¡   â”‚        â”‚
â”‚  â”‚ UserServiceâ”‚  â”‚OrderService â”‚  â”‚PaymentServiceâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                    â”‚                    â”‚        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                    â”‚   ZooKeeperé›†ç¾¤   â”‚                  â”‚
â”‚                    â”‚   (é…ç½®+æœåŠ¡å‘ç°)  â”‚                  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

### 1. Mavené¡¹ç›®ç»“æ„
```
zookeeper-demo/
â”œâ”€â”€ pom.xml
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/
â”‚   â”‚   â”‚   â””â”€â”€ com/
â”‚   â”‚   â”‚       â””â”€â”€ example/
â”‚   â”‚   â”‚           â”œâ”€â”€ config/
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ ConfigurationManager.java
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ ConfigurationChangeListener.java
â”‚   â”‚   â”‚           â”œâ”€â”€ discovery/
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ ServiceRegistry.java
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ ServiceDiscovery.java
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ ServiceInstance.java
â”‚   â”‚   â”‚           â”œâ”€â”€ lock/
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ DistributedLock.java
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ LockManager.java
â”‚   â”‚   â”‚           â”œâ”€â”€ service/
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ UserService.java
â”‚   â”‚   â”‚           â”‚   â”œâ”€â”€ OrderService.java
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ PaymentService.java
â”‚   â”‚   â”‚           â”œâ”€â”€ client/
â”‚   â”‚   â”‚           â”‚   â””â”€â”€ ZooKeeperClient.java
â”‚   â”‚   â”‚           â””â”€â”€ Main.java
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ application.properties
â”‚   â””â”€â”€ test/
â”‚       â””â”€â”€ java/
â”‚           â””â”€â”€ com/
â”‚               â””â”€â”€ example/
â”‚                   â””â”€â”€ ZooKeeperDemoTest.java
```

### 2. Mavenä¾èµ–é…ç½®
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.example</groupId>
    <artifactId>zookeeper-demo</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>
    
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
    
    <dependencies>
        <!-- ZooKeeperå®¢æˆ·ç«¯ -->
        <dependency>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
            <version>3.8.0</version>
        </dependency>
        
        <!-- JSONå¤„ç† -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.13.0</version>
        </dependency>
        
        <!-- æ—¥å¿—æ¡†æ¶ -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.32</version>
        </dependency>
        
        <!-- æµ‹è¯•æ¡†æ¶ -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <source>8</source>
                    <target>8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶å®ç°

### 1. ZooKeeperå®¢æˆ·ç«¯å°è£…
```java
package com.example.client;

import org.apache.zookeeper.*;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

public class ZooKeeperClient {
    private ZooKeeper zk;
    private CountDownLatch connectedSignal = new CountDownLatch(1);
    private volatile boolean isConnected = false;
    
    public ZooKeeperClient(String connectString, int sessionTimeout) throws Exception {
        connect(connectString, sessionTimeout);
    }
    
    private void connect(String connectString, int sessionTimeout) throws Exception {
        zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                System.out.println("æ”¶åˆ°äº‹ä»¶: " + event.getType() + " - " + event.getState());
                
                switch (event.getState()) {
                    case SyncConnected:
                        System.out.println("è¿æ¥å»ºç«‹æˆåŠŸ");
                        isConnected = true;
                        connectedSignal.countDown();
                        break;
                    case Disconnected:
                        System.out.println("è¿æ¥æ–­å¼€");
                        isConnected = false;
                        break;
                    case Expired:
                        System.out.println("ä¼šè¯è¿‡æœŸ");
                        isConnected = false;
                        reconnect(connectString, sessionTimeout);
                        break;
                }
            }
        });
        
        // ç­‰å¾…è¿æ¥å»ºç«‹
        if (!connectedSignal.await(10, TimeUnit.SECONDS)) {
            throw new RuntimeException("è¿æ¥è¶…æ—¶");
        }
    }
    
    private void reconnect(String connectString, int sessionTimeout) {
        try {
            Thread.sleep(1000);
            connect(connectString, sessionTimeout);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public ZooKeeper getZooKeeper() {
        return zk;
    }
    
    public boolean isConnected() {
        return isConnected && zk != null && zk.getState() == ZooKeeper.States.CONNECTED;
    }
    
    public void close() throws InterruptedException {
        if (zk != null) {
            zk.close();
        }
    }
}
```

### 2. é…ç½®ç®¡ç†å™¨
```java
package com.example.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.zookeeper.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.List;
import java.util.ArrayList;

public class ConfigurationManager {
    private ZooKeeper zk;
    private String configRootPath;
    private ConcurrentHashMap<String, String> localCache = new ConcurrentHashMap<>();
    private ConcurrentHashMap<String, List<ConfigurationChangeListener>> listeners = new ConcurrentHashMap<>();
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public ConfigurationManager(ZooKeeper zk, String configRootPath) {
        this.zk = zk;
        this.configRootPath = configRootPath;
        initializeConfigRoot();
    }
    
    private void initializeConfigRoot() {
        try {
            if (zk.exists(configRootPath, false) == null) {
                zk.create(configRootPath, "config-root".getBytes(),
                          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public void setConfig(String appName, String configName, String value) throws Exception {
        String path = configRootPath + "/" + appName + "/" + configName;
        
        // ç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨
        ensureParentExists(path);
        
        // åˆ›å»ºæˆ–æ›´æ–°é…ç½®èŠ‚ç‚¹
        if (zk.exists(path, false) == null) {
            zk.create(path, value.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        } else {
            zk.setData(path, value.getBytes(), -1);
        }
        
        // æ›´æ–°æœ¬åœ°ç¼“å­˜
        localCache.put(path, value);
        
        // é€šçŸ¥ç›‘å¬å™¨
        notifyListeners(path, value);
    }
    
    public String getConfig(String appName, String configName) throws Exception {
        String path = configRootPath + "/" + appName + "/" + configName;
        
        // å…ˆä»æœ¬åœ°ç¼“å­˜è·å–
        String cachedValue = localCache.get(path);
        if (cachedValue != null) {
            return cachedValue;
        }
        
        // ä»ZooKeeperè·å–
        try {
            byte[] data = zk.getData(path, false, null);
            String value = new String(data);
            
            // æ›´æ–°æœ¬åœ°ç¼“å­˜
            localCache.put(path, value);
            
            // æ³¨å†Œç›‘å¬å™¨
            registerWatcher(path);
            
            return value;
        } catch (KeeperException.NoNodeException e) {
            return null; // é…ç½®ä¸å­˜åœ¨
        }
    }
    
    public void addListener(String appName, String configName, ConfigurationChangeListener listener) {
        String path = configRootPath + "/" + appName + "/" + configName;
        listeners.computeIfAbsent(path, k -> new ArrayList<>()).add(listener);
    }
    
    private void ensureParentExists(String path) throws Exception {
        String parentPath = path.substring(0, path.lastIndexOf("/"));
        
        if (zk.exists(parentPath, false) == null) {
            ensureParentExists(parentPath);
            zk.create(parentPath, "".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
    }
    
    private void registerWatcher(String path) throws Exception {
        zk.getData(path, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeDataChanged) {
                    try {
                        // é‡æ–°è·å–æ•°æ®
                        byte[] data = zk.getData(path, this, null);
                        String newValue = new String(data);
                        
                        // æ›´æ–°æœ¬åœ°ç¼“å­˜
                        localCache.put(path, newValue);
                        
                        // é€šçŸ¥ç›‘å¬å™¨
                        notifyListeners(path, newValue);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        }, null);
    }
    
    private void notifyListeners(String path, String newValue) {
        List<ConfigurationChangeListener> listenerList = listeners.get(path);
        if (listenerList != null) {
            for (ConfigurationChangeListener listener : listenerList) {
                try {
                    listener.onConfigurationChange(path, newValue);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

interface ConfigurationChangeListener {
    void onConfigurationChange(String path, String newValue);
}
```

### 3. æœåŠ¡æ³¨å†Œä¸å‘ç°
```java
package com.example.discovery;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.zookeeper.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class ServiceRegistry {
    private ZooKeeper zk;
    private String serviceRootPath;
    private String serviceName;
    private String instancePath;
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public ServiceRegistry(ZooKeeper zk, String serviceRootPath, String serviceName) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
        this.serviceName = serviceName;
        initializeServiceRoot();
    }
    
    private void initializeServiceRoot() {
        try {
            if (zk.exists(serviceRootPath, false) == null) {
                zk.create(serviceRootPath, "services-root".getBytes(),
                          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public void registerService(String host, int port, Map<String, String> metadata) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // ç¡®ä¿æœåŠ¡ç›®å½•å­˜åœ¨
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, "service".getBytes(),
                      ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
        
        // åˆ›å»ºæœåŠ¡å®ä¾‹èŠ‚ç‚¹
        String instancePath = servicePath + "/" + UUID.randomUUID().toString();
        
        // æ„å»ºå®ä¾‹ä¿¡æ¯
        ServiceInstance instance = new ServiceInstance();
        instance.setHost(host);
        instance.setPort(port);
        instance.setStatus("UP");
        instance.setMetadata(metadata);
        instance.setRegisterTime(System.currentTimeMillis());
        
        // åºåˆ—åŒ–å®ä¾‹ä¿¡æ¯
        String instanceData = objectMapper.writeValueAsString(instance);
        
        // åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨åˆ é™¤
        this.instancePath = zk.create(instancePath, instanceData.getBytes(),
                                     ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
        
        System.out.println("æœåŠ¡æ³¨å†ŒæˆåŠŸ: " + this.instancePath);
    }
    
    public void unregisterService() throws Exception {
        if (instancePath != null) {
            try {
                zk.delete(instancePath, -1);
                System.out.println("æœåŠ¡æ³¨é”€æˆåŠŸ: " + instancePath);
            } catch (KeeperException.NoNodeException e) {
                // èŠ‚ç‚¹å·²è¢«åˆ é™¤ï¼Œå¿½ç•¥å¼‚å¸¸
            }
        }
    }
}

public class ServiceDiscovery {
    private ZooKeeper zk;
    private String serviceRootPath;
    private ConcurrentHashMap<String, List<ServiceInstance>> serviceCache = new ConcurrentHashMap<>();
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public ServiceDiscovery(ZooKeeper zk, String serviceRootPath) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
    }
    
    public List<ServiceInstance> discoverService(String serviceName) throws Exception {
        // å…ˆä»ç¼“å­˜è·å–
        List<ServiceInstance> cachedInstances = serviceCache.get(serviceName);
        if (cachedInstances != null) {
            return new ArrayList<>(cachedInstances);
        }
        
        // ä»ZooKeeperè·å–
        List<ServiceInstance> instances = loadServiceInstances(serviceName);
        
        // æ›´æ–°ç¼“å­˜
        serviceCache.put(serviceName, instances);
        
        // æ³¨å†Œç›‘å¬å™¨
        registerServiceWatcher(serviceName);
        
        return instances;
    }
    
    private List<ServiceInstance> loadServiceInstances(String serviceName) throws Exception {
        List<ServiceInstance> instances = new ArrayList<>();
        String servicePath = serviceRootPath + "/" + serviceName;
        
        try {
            List<String> instanceNames = zk.getChildren(servicePath, false);
            
            for (String instanceName : instanceNames) {
                try {
                    String instancePath = servicePath + "/" + instanceName;
                    byte[] data = zk.getData(instancePath, false, null);
                    
                    ServiceInstance instance = objectMapper.readValue(new String(data), ServiceInstance.class);
                    instances.add(instance);
                } catch (Exception e) {
                    System.out.println("åŠ è½½æœåŠ¡å®ä¾‹å¤±è´¥: " + instanceName + ", é”™è¯¯: " + e.getMessage());
                }
            }
        } catch (KeeperException.NoNodeException e) {
            // æœåŠ¡ä¸å­˜åœ¨
        }
        
        return instances;
    }
    
    private void registerServiceWatcher(String serviceName) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
        zk.getChildren(servicePath, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeChildrenChanged) {
                    try {
                        // é‡æ–°åŠ è½½æœåŠ¡å®ä¾‹
                        List<ServiceInstance> newInstances = loadServiceInstances(serviceName);
                        
                        // æ›´æ–°ç¼“å­˜
                        serviceCache.put(serviceName, newInstances);
                        
                        // é‡æ–°æ³¨å†Œç›‘å¬å™¨
                        registerServiceWatcher(serviceName);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        }, null);
    }
}

public class ServiceInstance {
    private String host;
    private int port;
    private String status;
    private Map<String, String> metadata;
    private long registerTime;
    private long updateTime;
    
    // æ„é€ å‡½æ•°ã€getterã€setter...
    public ServiceInstance() {}
    
    public String getHost() { return host; }
    public void setHost(String host) { this.host = host; }
    
    public int getPort() { return port; }
    public void setPort(int port) { this.port = port; }
    
    public String getStatus() { return status; }
    public void setStatus(String status) { this.status = status; }
    
    public Map<String, String> getMetadata() { return metadata; }
    public void setMetadata(Map<String, String> metadata) { this.metadata = metadata; }
    
    public long getRegisterTime() { return registerTime; }
    public void setRegisterTime(long registerTime) { this.registerTime = registerTime; }
    
    public long getUpdateTime() { return updateTime; }
    public void setUpdateTime(long updateTime) { this.updateTime = updateTime; }
}
```

### 4. åˆ†å¸ƒå¼é”å®ç°
```java
package com.example.lock;

import org.apache.zookeeper.*;
import java.util.*;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

public class DistributedLock {
    private ZooKeeper zk;
    private String lockPath;
    private String lockNode;
    private boolean isLocked = false;
    
    public DistributedLock(ZooKeeper zk, String lockPath) {
        this.zk = zk;
        this.lockPath = lockPath;
    }
    
    public boolean acquireLock(long timeout) throws Exception {
        long startTime = System.currentTimeMillis();
        
        try {
            // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
            lockNode = zk.create(lockPath + "/lock-", "locked".getBytes(),
                               ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
            
            // æ£€æŸ¥æ˜¯å¦è·å¾—é”
            if (checkLockAcquired(lockNode)) {
                isLocked = true;
                System.out.println("æˆåŠŸè·å–é”: " + lockNode);
                return true;
            }
            
            // ç­‰å¾…é”é‡Šæ”¾
            if (waitForLock(lockNode, timeout - (System.currentTimeMillis() - startTime))) {
                isLocked = true;
                System.out.println("æˆåŠŸè·å–é”: " + lockNode);
                return true;
            }
            
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        System.out.println("è·å–é”è¶…æ—¶");
        return false;
    }
    
    private boolean checkLockAcquired(String lockNode) throws Exception {
        List<String> children = zk.getChildren(lockPath, false);
        Collections.sort(children);
        
        String nodeName = lockNode.substring(lockNode.lastIndexOf("/") + 1);
        return children.get(0).equals(nodeName);
    }
    
    private boolean waitForLock(String lockNode, long waitTime) throws Exception {
        if (waitTime <= 0) {
            return false;
        }
        
        List<String> children = zk.getChildren(lockPath, false);
        Collections.sort(children);
        
        String nodeName = lockNode.substring(lockNode.lastIndexOf("/") + 1);
        int index = children.indexOf(nodeName);
        
        if (index <= 0) {
            return true; // å·²ç»æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
        }
        
        // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ é™¤äº‹ä»¶
        String previousNode = lockPath + "/" + children.get(index - 1);
        
        CountDownLatch nodeDeletedSignal = new CountDownLatch(1);
        Watcher watcher = new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeDeleted) {
                    nodeDeletedSignal.countDown();
                }
            }
        };
        
        // æ£€æŸ¥å‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦è¿˜å­˜åœ¨
        if (zk.exists(previousNode, watcher) == null) {
            return true; // å‰ä¸€ä¸ªèŠ‚ç‚¹å·²è¢«åˆ é™¤
        }
        
        // ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤
        return nodeDeletedSignal.await(waitTime, TimeUnit.MILLISECONDS);
    }
    
    public void releaseLock() throws Exception {
        if (isLocked && lockNode != null) {
            try {
                zk.delete(lockNode, -1);
                isLocked = false;
                lockNode = null;
                System.out.println("é”å·²é‡Šæ”¾");
            } catch (KeeperException.NoNodeException e) {
                // èŠ‚ç‚¹å·²è¢«åˆ é™¤ï¼Œå¿½ç•¥å¼‚å¸¸
            }
        }
    }
    
    public boolean isLocked() {
        return isLocked;
    }
}
```

## ğŸš€ ä¸šåŠ¡æœåŠ¡å®ç°

### 1. ç”¨æˆ·æœåŠ¡
```java
package com.example.service;

import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import java.util.HashMap;
import java.util.Map;

public class UserService {
    private ConfigurationManager configManager;
    private ServiceRegistry serviceRegistry;
    private String databaseUrl;
    private String redisHost;
    
    public UserService(ConfigurationManager configManager, ServiceRegistry serviceRegistry) {
        this.configManager = configManager;
        this.serviceRegistry = serviceRegistry;
        loadConfig();
        registerService();
        setupConfigListener();
    }
    
    private void loadConfig() {
        try {
            databaseUrl = configManager.getConfig("user-service", "database.url");
            redisHost = configManager.getConfig("user-service", "redis.host");
            
            System.out.println("ç”¨æˆ·æœåŠ¡é…ç½®åŠ è½½å®Œæˆ:");
            System.out.println("æ•°æ®åº“URL: " + databaseUrl);
            System.out.println("Redisä¸»æœº: " + redisHost);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void registerService() {
        try {
            Map<String, String> metadata = new HashMap<>();
            metadata.put("version", "1.0");
            metadata.put("weight", "1");
            metadata.put("region", "us-east-1");
            
            serviceRegistry.registerService("192.168.1.100", 8080, metadata);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void setupConfigListener() {
        try {
            configManager.addListener("user-service", "database.url", (path, newValue) -> {
                System.out.println("æ•°æ®åº“é…ç½®å‘ç”Ÿå˜åŒ–: " + newValue);
                this.databaseUrl = newValue;
                // é‡æ–°åŠ è½½æ•°æ®åº“è¿æ¥
                reloadDatabaseConnection(newValue);
            });
            
            configManager.addListener("user-service", "redis.host", (path, newValue) -> {
                System.out.println("Redisé…ç½®å‘ç”Ÿå˜åŒ–: " + newValue);
                this.redisHost = newValue;
                // é‡æ–°åŠ è½½Redisè¿æ¥
                reloadRedisConnection(newValue);
            });
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public String getUserInfo(String userId) {
        // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
        return "ç”¨æˆ·ä¿¡æ¯: " + userId + ", æ•°æ®åº“: " + databaseUrl + ", Redis: " + redisHost;
    }
    
    private void reloadDatabaseConnection(String newUrl) {
        System.out.println("é‡æ–°åŠ è½½æ•°æ®åº“è¿æ¥: " + newUrl);
        // å®ç°æ•°æ®åº“è¿æ¥é‡è½½é€»è¾‘
    }
    
    private void reloadRedisConnection(String newHost) {
        System.out.println("é‡æ–°åŠ è½½Redisè¿æ¥: " + newHost);
        // å®ç°Redisè¿æ¥é‡è½½é€»è¾‘
    }
    
    public void shutdown() {
        try {
            serviceRegistry.unregisterService();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 2. è®¢å•æœåŠ¡
```java
package com.example.service;

import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import com.example.discovery.ServiceDiscovery;
import com.example.lock.DistributedLock;
import java.util.HashMap;
import java.util.Map;

public class OrderService {
    private ConfigurationManager configManager;
    private ServiceRegistry serviceRegistry;
    private ServiceDiscovery serviceDiscovery;
    private DistributedLock orderLock;
    
    public OrderService(ConfigurationManager configManager, ServiceRegistry serviceRegistry, 
                       ServiceDiscovery serviceDiscovery) {
        this.configManager = configManager;
        this.serviceRegistry = serviceRegistry;
        this.serviceDiscovery = serviceDiscovery;
        this.orderLock = new DistributedLock(configManager.getZooKeeper(), "/locks/order");
        
        loadConfig();
        registerService();
    }
    
    private void loadConfig() {
        try {
            String databaseUrl = configManager.getConfig("order-service", "database.url");
            System.out.println("è®¢å•æœåŠ¡é…ç½®åŠ è½½å®Œæˆ: æ•°æ®åº“URL: " + databaseUrl);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void registerService() {
        try {
            Map<String, String> metadata = new HashMap<>();
            metadata.put("version", "1.0");
            metadata.put("weight", "1");
            
            serviceRegistry.registerService("192.168.1.101", 8081, metadata);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public String createOrder(String userId, String productId) {
        try {
            // è·å–åˆ†å¸ƒå¼é”
            if (orderLock.acquireLock(5000)) {
                try {
                    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                    System.out.println("åˆ›å»ºè®¢å•: ç”¨æˆ·=" + userId + ", äº§å“=" + productId);
                    
                    // è°ƒç”¨ç”¨æˆ·æœåŠ¡
                    String userInfo = callUserService(userId);
                    System.out.println("ç”¨æˆ·ä¿¡æ¯: " + userInfo);
                    
                    return "è®¢å•åˆ›å»ºæˆåŠŸ: " + userId + "-" + productId;
                } finally {
                    // é‡Šæ”¾é”
                    orderLock.releaseLock();
                }
            } else {
                return "è·å–é”å¤±è´¥ï¼Œæ— æ³•åˆ›å»ºè®¢å•";
            }
        } catch (Exception e) {
            e.printStackTrace();
            return "è®¢å•åˆ›å»ºå¤±è´¥: " + e.getMessage();
        }
    }
    
    private String callUserService(String userId) {
        try {
            // å‘ç°ç”¨æˆ·æœåŠ¡
            List<ServiceInstance> instances = serviceDiscovery.discoverService("user-service");
            
            if (instances != null && !instances.isEmpty()) {
                // é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨å®ä¾‹
                ServiceInstance instance = instances.get(0);
                String url = "http://" + instance.getHost() + ":" + instance.getPort() + "/user/" + userId;
                
                // è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„HTTPè°ƒç”¨
                // ä¸ºäº†ç®€åŒ–ï¼Œè¿”å›æ¨¡æ‹Ÿå“åº”
                return "æ¨¡æ‹Ÿè°ƒç”¨ç”¨æˆ·æœåŠ¡: " + url;
            } else {
                return "ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨";
            }
        } catch (Exception e) {
            e.printStackTrace();
            return "è°ƒç”¨ç”¨æˆ·æœåŠ¡å¤±è´¥: " + e.getMessage();
        }
    }
    
    public void shutdown() {
        try {
            serviceRegistry.unregisterService();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## ğŸ® ä¸»ç¨‹åºå®ç°

### 1. ä¸»ç¨‹åº
```java
package com.example;

import com.example.client.ZooKeeperClient;
import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import com.example.discovery.ServiceDiscovery;
import com.example.service.UserService;
import com.example.service.OrderService;
import com.example.service.PaymentService;

public class Main {
    public static void main(String[] args) {
        try {
            System.out.println("=== ZooKeeper åˆ†å¸ƒå¼ç³»ç»Ÿå¯åŠ¨ ===");
            
            // åˆ›å»ºZooKeeperå®¢æˆ·ç«¯
            ZooKeeperClient zkClient = new ZooKeeperClient("localhost:2181", 5000);
            
            // åˆ›å»ºé…ç½®ç®¡ç†å™¨
            ConfigurationManager configManager = new ConfigurationManager(zkClient.getZooKeeper(), "/config");
            
            // åˆ›å»ºæœåŠ¡å‘ç°å™¨
            ServiceDiscovery serviceDiscovery = new ServiceDiscovery(zkClient.getZooKeeper(), "/services");
            
            // åˆå§‹åŒ–é…ç½®
            initializeConfig(configManager);
            
            // åˆ›å»ºæœåŠ¡æ³¨å†Œå™¨
            ServiceRegistry userServiceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/services", "user-service");
            ServiceRegistry orderServiceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/services", "order-service");
            ServiceRegistry paymentServiceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/services", "payment-service");
            
            // åˆ›å»ºä¸šåŠ¡æœåŠ¡
            UserService userService = new UserService(configManager, userServiceRegistry);
            OrderService orderService = new OrderService(configManager, orderServiceRegistry, serviceDiscovery);
            PaymentService paymentService = new PaymentService(configManager, paymentServiceRegistry);
            
            // æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ
            simulateBusinessOperations(userService, orderService, paymentService);
            
            // ä¿æŒæœåŠ¡è¿è¡Œ
            Thread.sleep(60000); // è¿è¡Œ1åˆ†é’Ÿ
            
            // å…³é—­æœåŠ¡
            shutdownServices(userService, orderService, paymentService);
            
            // å…³é—­ZooKeeperå®¢æˆ·ç«¯
            zkClient.close();
            
            System.out.println("=== ç³»ç»Ÿå·²å…³é—­ ===");
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private static void initializeConfig(ConfigurationManager configManager) throws Exception {
        System.out.println("åˆå§‹åŒ–é…ç½®...");
        
        // ç”¨æˆ·æœåŠ¡é…ç½®
        configManager.setConfig("user-service", "database.url", "jdbc:mysql://localhost:3306/userdb");
        configManager.setConfig("user-service", "redis.host", "localhost:6379");
        
        // è®¢å•æœåŠ¡é…ç½®
        configManager.setConfig("order-service", "database.url", "jdbc:mysql://localhost:3306/orderdb");
        
        // æ”¯ä»˜æœåŠ¡é…ç½®
        configManager.setConfig("payment-service", "database.url", "jdbc:mysql://localhost:3306/paymentdb");
        configManager.setConfig("payment-service", "payment.gateway", "https://api.payment.com");
        
        System.out.println("é…ç½®åˆå§‹åŒ–å®Œæˆ");
    }
    
    private static void simulateBusinessOperations(UserService userService, OrderService orderService, 
                                                 PaymentService paymentService) {
        System.out.println("\n=== æ¨¡æ‹Ÿä¸šåŠ¡æ“ä½œ ===");
        
        // æ¨¡æ‹Ÿç”¨æˆ·æŸ¥è¯¢
        System.out.println("\n1. ç”¨æˆ·æŸ¥è¯¢æ“ä½œ:");
        String userInfo = userService.getUserInfo("user123");
        System.out.println(userInfo);
        
        // æ¨¡æ‹Ÿè®¢å•åˆ›å»º
        System.out.println("\n2. è®¢å•åˆ›å»ºæ“ä½œ:");
        String orderResult = orderService.createOrder("user123", "product456");
        System.out.println(orderResult);
        
        // æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
        System.out.println("\n3. æ”¯ä»˜å¤„ç†æ“ä½œ:");
        String paymentResult = paymentService.processPayment("order789", 100.0);
        System.out.println(paymentResult);
        
        // æ¨¡æ‹Ÿé…ç½®æ›´æ–°
        System.out.println("\n4. é…ç½®æ›´æ–°æ“ä½œ:");
        try {
            ConfigurationManager configManager = userService.getConfigManager();
            configManager.setConfig("user-service", "database.url", "jdbc:mysql://newhost:3306/userdb");
            System.out.println("æ•°æ®åº“é…ç½®å·²æ›´æ–°");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private static void shutdownServices(UserService userService, OrderService orderService, 
                                       PaymentService paymentService) {
        System.out.println("\n=== å…³é—­æœåŠ¡ ===");
        
        userService.shutdown();
        orderService.shutdown();
        paymentService.shutdown();
        
        System.out.println("æ‰€æœ‰æœåŠ¡å·²å…³é—­");
    }
}
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### 1. å•å…ƒæµ‹è¯•
```java
package com.example;

import com.example.client.ZooKeeperClient;
import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import com.example.discovery.ServiceDiscovery;
import com.example.lock.DistributedLock;
import org.junit.Test;
import org.junit.Before;
import org.junit.After;
import static org.junit.Assert.*;

public class ZooKeeperDemoTest {
    private ZooKeeperClient zkClient;
    private ConfigurationManager configManager;
    private ServiceRegistry serviceRegistry;
    private ServiceDiscovery serviceDiscovery;
    
    @Before
    public void setUp() throws Exception {
        // å¯åŠ¨ZooKeeperå®¢æˆ·ç«¯
        zkClient = new ZooKeeperClient("localhost:2181", 5000);
        
        // åˆ›å»ºé…ç½®ç®¡ç†å™¨
        configManager = new ConfigurationManager(zkClient.getZooKeeper(), "/test-config");
        
        // åˆ›å»ºæœåŠ¡æ³¨å†Œå™¨
        serviceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/test-services", "test-service");
        
        // åˆ›å»ºæœåŠ¡å‘ç°å™¨
        serviceDiscovery = new ServiceDiscovery(zkClient.getZooKeeper(), "/test-services");
    }
    
    @Test
    public void testConfigurationManager() throws Exception {
        System.out.println("æµ‹è¯•é…ç½®ç®¡ç†å™¨...");
        
        // è®¾ç½®é…ç½®
        configManager.setConfig("test-app", "test-key", "test-value");
        
        // è·å–é…ç½®
        String value = configManager.getConfig("test-app", "test-key");
        assertEquals("test-value", value);
        
        System.out.println("é…ç½®ç®¡ç†å™¨æµ‹è¯•é€šè¿‡");
    }
    
    @Test
    public void testServiceRegistry() throws Exception {
        System.out.println("æµ‹è¯•æœåŠ¡æ³¨å†Œ...");
        
        // æ³¨å†ŒæœåŠ¡
        Map<String, String> metadata = new HashMap<>();
        metadata.put("version", "1.0");
        metadata.put("weight", "1");
        
        serviceRegistry.registerService("localhost", 8080, metadata);
        
        // å‘ç°æœåŠ¡
        List<ServiceInstance> instances = serviceDiscovery.discoverService("test-service");
        assertNotNull(instances);
        assertTrue(instances.size() > 0);
        
        ServiceInstance instance = instances.get(0);
        assertEquals("localhost", instance.getHost());
        assertEquals(8080, instance.getPort());
        assertEquals("UP", instance.getStatus());
        
        System.out.println("æœåŠ¡æ³¨å†Œæµ‹è¯•é€šè¿‡");
    }
    
    @Test
    public void testDistributedLock() throws Exception {
        System.out.println("æµ‹è¯•åˆ†å¸ƒå¼é”...");
        
        DistributedLock lock = new DistributedLock(zkClient.getZooKeeper(), "/test-locks");
        
        // è·å–é”
        boolean acquired = lock.acquireLock(5000);
        assertTrue(acquired);
        assertTrue(lock.isLocked());
        
        // é‡Šæ”¾é”
        lock.releaseLock();
        assertFalse(lock.isLocked());
        
        System.out.println("åˆ†å¸ƒå¼é”æµ‹è¯•é€šè¿‡");
    }
    
    @After
    public void tearDown() throws Exception {
        // æ¸…ç†æµ‹è¯•æ•°æ®
        try {
            serviceRegistry.unregisterService();
        } catch (Exception e) {
            // å¿½ç•¥æ¸…ç†å¼‚å¸¸
        }
        
        // å…³é—­ZooKeeperå®¢æˆ·ç«¯
        if (zkClient != null) {
            zkClient.close();
        }
    }
}
```

## ğŸš€ è¿è¡Œè¯´æ˜

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# 1. ç¡®ä¿ZooKeeperæœåŠ¡å·²å¯åŠ¨
zkServer.sh start

# 2. æ£€æŸ¥ZooKeeperçŠ¶æ€
zkServer.sh status

# 3. æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep :2181
```

### 2. ç¼–è¯‘è¿è¡Œ
```bash
# 1. ç¼–è¯‘é¡¹ç›®
mvn clean compile

# 2. è¿è¡Œä¸»ç¨‹åº
mvn exec:java -Dexec.mainClass="com.example.Main"

# 3. è¿è¡Œæµ‹è¯•
mvn test
```

### 3. éªŒè¯åŠŸèƒ½
```bash
# 1. è¿æ¥ZooKeeperå®¢æˆ·ç«¯
zkCli.sh -server localhost:2181

# 2. æŸ¥çœ‹é…ç½®èŠ‚ç‚¹
ls /config
get /config/user-service/database.url

# 3. æŸ¥çœ‹æœåŠ¡èŠ‚ç‚¹
ls /services
ls /services/user-service

# 4. æŸ¥çœ‹é”èŠ‚ç‚¹
ls /locks
```

## ğŸ”— æ€»ç»“

è¿™ä¸ªå®æˆ˜é¡¹ç›®å±•ç¤ºäº†ZooKeeperåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å…¸å‹åº”ç”¨ï¼š

1. **é…ç½®ä¸­å¿ƒ**ï¼šå®ç°é…ç½®çš„åŠ¨æ€ç®¡ç†å’Œå®æ—¶åŒæ­¥
2. **æœåŠ¡å‘ç°**ï¼šå®ç°æœåŠ¡çš„è‡ªåŠ¨æ³¨å†Œå’Œå‘ç°
3. **åˆ†å¸ƒå¼é”**ï¼šå®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„äº’æ–¥è®¿é—®
4. **ä¸šåŠ¡é›†æˆ**ï¼šå±•ç¤ºå¦‚ä½•åœ¨å®é™…ä¸šåŠ¡ä¸­ä½¿ç”¨è¿™äº›åŠŸèƒ½

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œä½ å¯ä»¥ï¼š
- æ·±å…¥ç†è§£ZooKeeperçš„æ ¸å¿ƒæ¦‚å¿µ
- æŒæ¡ZooKeeperçš„Java APIä½¿ç”¨
- å­¦ä¼šè®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„
- ä¸ºå®é™…é¡¹ç›®å¼€å‘æ‰“ä¸‹åŸºç¡€

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼** ğŸ¯
