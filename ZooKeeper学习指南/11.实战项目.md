# ZooKeeper 实战项目

## 🎯 项目概述

本实战项目将带你实现一个完整的基于ZooKeeper的分布式系统，包含配置中心、服务发现、分布式锁等核心功能。

### 项目架构
```
┌─────────────────────────────────────────────────────────────┐
│                    分布式系统架构                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  用户服务   │  │  订单服务   │  │  支付服务   │        │
│  │ UserService│  │OrderService │  │PaymentService│        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
│         │                    │                    │        │
│         └────────────────────┼────────────────────┘        │
│                              │                             │
│                    ┌─────────┴─────────┐                  │
│                    │   ZooKeeper集群   │                  │
│                    │   (配置+服务发现)  │                  │
│                    └───────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

## 🏗️ 项目结构

### 1. Maven项目结构
```
zookeeper-demo/
├── pom.xml
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/
│   │   │       └── example/
│   │   │           ├── config/
│   │   │           │   ├── ConfigurationManager.java
│   │   │           │   └── ConfigurationChangeListener.java
│   │   │           ├── discovery/
│   │   │           │   ├── ServiceRegistry.java
│   │   │           │   ├── ServiceDiscovery.java
│   │   │           │   └── ServiceInstance.java
│   │   │           ├── lock/
│   │   │           │   ├── DistributedLock.java
│   │   │           │   └── LockManager.java
│   │   │           ├── service/
│   │   │           │   ├── UserService.java
│   │   │           │   ├── OrderService.java
│   │   │           │   └── PaymentService.java
│   │   │           ├── client/
│   │   │           │   └── ZooKeeperClient.java
│   │   │           └── Main.java
│   │   └── resources/
│   │       └── application.properties
│   └── test/
│       └── java/
│           └── com/
│               └── example/
│                   └── ZooKeeperDemoTest.java
```

### 2. Maven依赖配置
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <groupId>com.example</groupId>
    <artifactId>zookeeper-demo</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>
    
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
    
    <dependencies>
        <!-- ZooKeeper客户端 -->
        <dependency>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
            <version>3.8.0</version>
        </dependency>
        
        <!-- JSON处理 -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
            <version>2.13.0</version>
        </dependency>
        
        <!-- 日志框架 -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.32</version>
        </dependency>
        
        <!-- 测试框架 -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <source>8</source>
                    <target>8</target>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

## 🔧 核心组件实现

### 1. ZooKeeper客户端封装
```java
package com.example.client;

import org.apache.zookeeper.*;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

public class ZooKeeperClient {
    private ZooKeeper zk;
    private CountDownLatch connectedSignal = new CountDownLatch(1);
    private volatile boolean isConnected = false;
    
    public ZooKeeperClient(String connectString, int sessionTimeout) throws Exception {
        connect(connectString, sessionTimeout);
    }
    
    private void connect(String connectString, int sessionTimeout) throws Exception {
        zk = new ZooKeeper(connectString, sessionTimeout, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                System.out.println("收到事件: " + event.getType() + " - " + event.getState());
                
                switch (event.getState()) {
                    case SyncConnected:
                        System.out.println("连接建立成功");
                        isConnected = true;
                        connectedSignal.countDown();
                        break;
                    case Disconnected:
                        System.out.println("连接断开");
                        isConnected = false;
                        break;
                    case Expired:
                        System.out.println("会话过期");
                        isConnected = false;
                        reconnect(connectString, sessionTimeout);
                        break;
                }
            }
        });
        
        // 等待连接建立
        if (!connectedSignal.await(10, TimeUnit.SECONDS)) {
            throw new RuntimeException("连接超时");
        }
    }
    
    private void reconnect(String connectString, int sessionTimeout) {
        try {
            Thread.sleep(1000);
            connect(connectString, sessionTimeout);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public ZooKeeper getZooKeeper() {
        return zk;
    }
    
    public boolean isConnected() {
        return isConnected && zk != null && zk.getState() == ZooKeeper.States.CONNECTED;
    }
    
    public void close() throws InterruptedException {
        if (zk != null) {
            zk.close();
        }
    }
}
```

### 2. 配置管理器
```java
package com.example.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.zookeeper.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.List;
import java.util.ArrayList;

public class ConfigurationManager {
    private ZooKeeper zk;
    private String configRootPath;
    private ConcurrentHashMap<String, String> localCache = new ConcurrentHashMap<>();
    private ConcurrentHashMap<String, List<ConfigurationChangeListener>> listeners = new ConcurrentHashMap<>();
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public ConfigurationManager(ZooKeeper zk, String configRootPath) {
        this.zk = zk;
        this.configRootPath = configRootPath;
        initializeConfigRoot();
    }
    
    private void initializeConfigRoot() {
        try {
            if (zk.exists(configRootPath, false) == null) {
                zk.create(configRootPath, "config-root".getBytes(),
                          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public void setConfig(String appName, String configName, String value) throws Exception {
        String path = configRootPath + "/" + appName + "/" + configName;
        
        // 确保父目录存在
        ensureParentExists(path);
        
        // 创建或更新配置节点
        if (zk.exists(path, false) == null) {
            zk.create(path, value.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        } else {
            zk.setData(path, value.getBytes(), -1);
        }
        
        // 更新本地缓存
        localCache.put(path, value);
        
        // 通知监听器
        notifyListeners(path, value);
    }
    
    public String getConfig(String appName, String configName) throws Exception {
        String path = configRootPath + "/" + appName + "/" + configName;
        
        // 先从本地缓存获取
        String cachedValue = localCache.get(path);
        if (cachedValue != null) {
            return cachedValue;
        }
        
        // 从ZooKeeper获取
        try {
            byte[] data = zk.getData(path, false, null);
            String value = new String(data);
            
            // 更新本地缓存
            localCache.put(path, value);
            
            // 注册监听器
            registerWatcher(path);
            
            return value;
        } catch (KeeperException.NoNodeException e) {
            return null; // 配置不存在
        }
    }
    
    public void addListener(String appName, String configName, ConfigurationChangeListener listener) {
        String path = configRootPath + "/" + appName + "/" + configName;
        listeners.computeIfAbsent(path, k -> new ArrayList<>()).add(listener);
    }
    
    private void ensureParentExists(String path) throws Exception {
        String parentPath = path.substring(0, path.lastIndexOf("/"));
        
        if (zk.exists(parentPath, false) == null) {
            ensureParentExists(parentPath);
            zk.create(parentPath, "".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
    }
    
    private void registerWatcher(String path) throws Exception {
        zk.getData(path, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeDataChanged) {
                    try {
                        // 重新获取数据
                        byte[] data = zk.getData(path, this, null);
                        String newValue = new String(data);
                        
                        // 更新本地缓存
                        localCache.put(path, newValue);
                        
                        // 通知监听器
                        notifyListeners(path, newValue);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        }, null);
    }
    
    private void notifyListeners(String path, String newValue) {
        List<ConfigurationChangeListener> listenerList = listeners.get(path);
        if (listenerList != null) {
            for (ConfigurationChangeListener listener : listenerList) {
                try {
                    listener.onConfigurationChange(path, newValue);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

interface ConfigurationChangeListener {
    void onConfigurationChange(String path, String newValue);
}
```

### 3. 服务注册与发现
```java
package com.example.discovery;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.zookeeper.*;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class ServiceRegistry {
    private ZooKeeper zk;
    private String serviceRootPath;
    private String serviceName;
    private String instancePath;
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public ServiceRegistry(ZooKeeper zk, String serviceRootPath, String serviceName) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
        this.serviceName = serviceName;
        initializeServiceRoot();
    }
    
    private void initializeServiceRoot() {
        try {
            if (zk.exists(serviceRootPath, false) == null) {
                zk.create(serviceRootPath, "services-root".getBytes(),
                          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public void registerService(String host, int port, Map<String, String> metadata) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // 确保服务目录存在
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, "service".getBytes(),
                      ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
        
        // 创建服务实例节点
        String instancePath = servicePath + "/" + UUID.randomUUID().toString();
        
        // 构建实例信息
        ServiceInstance instance = new ServiceInstance();
        instance.setHost(host);
        instance.setPort(port);
        instance.setStatus("UP");
        instance.setMetadata(metadata);
        instance.setRegisterTime(System.currentTimeMillis());
        
        // 序列化实例信息
        String instanceData = objectMapper.writeValueAsString(instance);
        
        // 创建临时节点，会话结束时自动删除
        this.instancePath = zk.create(instancePath, instanceData.getBytes(),
                                     ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
        
        System.out.println("服务注册成功: " + this.instancePath);
    }
    
    public void unregisterService() throws Exception {
        if (instancePath != null) {
            try {
                zk.delete(instancePath, -1);
                System.out.println("服务注销成功: " + instancePath);
            } catch (KeeperException.NoNodeException e) {
                // 节点已被删除，忽略异常
            }
        }
    }
}

public class ServiceDiscovery {
    private ZooKeeper zk;
    private String serviceRootPath;
    private ConcurrentHashMap<String, List<ServiceInstance>> serviceCache = new ConcurrentHashMap<>();
    private ObjectMapper objectMapper = new ObjectMapper();
    
    public ServiceDiscovery(ZooKeeper zk, String serviceRootPath) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
    }
    
    public List<ServiceInstance> discoverService(String serviceName) throws Exception {
        // 先从缓存获取
        List<ServiceInstance> cachedInstances = serviceCache.get(serviceName);
        if (cachedInstances != null) {
            return new ArrayList<>(cachedInstances);
        }
        
        // 从ZooKeeper获取
        List<ServiceInstance> instances = loadServiceInstances(serviceName);
        
        // 更新缓存
        serviceCache.put(serviceName, instances);
        
        // 注册监听器
        registerServiceWatcher(serviceName);
        
        return instances;
    }
    
    private List<ServiceInstance> loadServiceInstances(String serviceName) throws Exception {
        List<ServiceInstance> instances = new ArrayList<>();
        String servicePath = serviceRootPath + "/" + serviceName;
        
        try {
            List<String> instanceNames = zk.getChildren(servicePath, false);
            
            for (String instanceName : instanceNames) {
                try {
                    String instancePath = servicePath + "/" + instanceName;
                    byte[] data = zk.getData(instancePath, false, null);
                    
                    ServiceInstance instance = objectMapper.readValue(new String(data), ServiceInstance.class);
                    instances.add(instance);
                } catch (Exception e) {
                    System.out.println("加载服务实例失败: " + instanceName + ", 错误: " + e.getMessage());
                }
            }
        } catch (KeeperException.NoNodeException e) {
            // 服务不存在
        }
        
        return instances;
    }
    
    private void registerServiceWatcher(String serviceName) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // 监听子节点变化
        zk.getChildren(servicePath, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeChildrenChanged) {
                    try {
                        // 重新加载服务实例
                        List<ServiceInstance> newInstances = loadServiceInstances(serviceName);
                        
                        // 更新缓存
                        serviceCache.put(serviceName, newInstances);
                        
                        // 重新注册监听器
                        registerServiceWatcher(serviceName);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        }, null);
    }
}

public class ServiceInstance {
    private String host;
    private int port;
    private String status;
    private Map<String, String> metadata;
    private long registerTime;
    private long updateTime;
    
    // 构造函数、getter、setter...
    public ServiceInstance() {}
    
    public String getHost() { return host; }
    public void setHost(String host) { this.host = host; }
    
    public int getPort() { return port; }
    public void setPort(int port) { this.port = port; }
    
    public String getStatus() { return status; }
    public void setStatus(String status) { this.status = status; }
    
    public Map<String, String> getMetadata() { return metadata; }
    public void setMetadata(Map<String, String> metadata) { this.metadata = metadata; }
    
    public long getRegisterTime() { return registerTime; }
    public void setRegisterTime(long registerTime) { this.registerTime = registerTime; }
    
    public long getUpdateTime() { return updateTime; }
    public void setUpdateTime(long updateTime) { this.updateTime = updateTime; }
}
```

### 4. 分布式锁实现
```java
package com.example.lock;

import org.apache.zookeeper.*;
import java.util.*;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;

public class DistributedLock {
    private ZooKeeper zk;
    private String lockPath;
    private String lockNode;
    private boolean isLocked = false;
    
    public DistributedLock(ZooKeeper zk, String lockPath) {
        this.zk = zk;
        this.lockPath = lockPath;
    }
    
    public boolean acquireLock(long timeout) throws Exception {
        long startTime = System.currentTimeMillis();
        
        try {
            // 创建临时顺序节点
            lockNode = zk.create(lockPath + "/lock-", "locked".getBytes(),
                               ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
            
            // 检查是否获得锁
            if (checkLockAcquired(lockNode)) {
                isLocked = true;
                System.out.println("成功获取锁: " + lockNode);
                return true;
            }
            
            // 等待锁释放
            if (waitForLock(lockNode, timeout - (System.currentTimeMillis() - startTime))) {
                isLocked = true;
                System.out.println("成功获取锁: " + lockNode);
                return true;
            }
            
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        System.out.println("获取锁超时");
        return false;
    }
    
    private boolean checkLockAcquired(String lockNode) throws Exception {
        List<String> children = zk.getChildren(lockPath, false);
        Collections.sort(children);
        
        String nodeName = lockNode.substring(lockNode.lastIndexOf("/") + 1);
        return children.get(0).equals(nodeName);
    }
    
    private boolean waitForLock(String lockNode, long waitTime) throws Exception {
        if (waitTime <= 0) {
            return false;
        }
        
        List<String> children = zk.getChildren(lockPath, false);
        Collections.sort(children);
        
        String nodeName = lockNode.substring(lockNode.lastIndexOf("/") + 1);
        int index = children.indexOf(nodeName);
        
        if (index <= 0) {
            return true; // 已经是第一个节点
        }
        
        // 监听前一个节点的删除事件
        String previousNode = lockPath + "/" + children.get(index - 1);
        
        CountDownLatch nodeDeletedSignal = new CountDownLatch(1);
        Watcher watcher = new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeDeleted) {
                    nodeDeletedSignal.countDown();
                }
            }
        };
        
        // 检查前一个节点是否还存在
        if (zk.exists(previousNode, watcher) == null) {
            return true; // 前一个节点已被删除
        }
        
        // 等待前一个节点被删除
        return nodeDeletedSignal.await(waitTime, TimeUnit.MILLISECONDS);
    }
    
    public void releaseLock() throws Exception {
        if (isLocked && lockNode != null) {
            try {
                zk.delete(lockNode, -1);
                isLocked = false;
                lockNode = null;
                System.out.println("锁已释放");
            } catch (KeeperException.NoNodeException e) {
                // 节点已被删除，忽略异常
            }
        }
    }
    
    public boolean isLocked() {
        return isLocked;
    }
}
```

## 🚀 业务服务实现

### 1. 用户服务
```java
package com.example.service;

import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import java.util.HashMap;
import java.util.Map;

public class UserService {
    private ConfigurationManager configManager;
    private ServiceRegistry serviceRegistry;
    private String databaseUrl;
    private String redisHost;
    
    public UserService(ConfigurationManager configManager, ServiceRegistry serviceRegistry) {
        this.configManager = configManager;
        this.serviceRegistry = serviceRegistry;
        loadConfig();
        registerService();
        setupConfigListener();
    }
    
    private void loadConfig() {
        try {
            databaseUrl = configManager.getConfig("user-service", "database.url");
            redisHost = configManager.getConfig("user-service", "redis.host");
            
            System.out.println("用户服务配置加载完成:");
            System.out.println("数据库URL: " + databaseUrl);
            System.out.println("Redis主机: " + redisHost);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void registerService() {
        try {
            Map<String, String> metadata = new HashMap<>();
            metadata.put("version", "1.0");
            metadata.put("weight", "1");
            metadata.put("region", "us-east-1");
            
            serviceRegistry.registerService("192.168.1.100", 8080, metadata);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void setupConfigListener() {
        try {
            configManager.addListener("user-service", "database.url", (path, newValue) -> {
                System.out.println("数据库配置发生变化: " + newValue);
                this.databaseUrl = newValue;
                // 重新加载数据库连接
                reloadDatabaseConnection(newValue);
            });
            
            configManager.addListener("user-service", "redis.host", (path, newValue) -> {
                System.out.println("Redis配置发生变化: " + newValue);
                this.redisHost = newValue;
                // 重新加载Redis连接
                reloadRedisConnection(newValue);
            });
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public String getUserInfo(String userId) {
        // 模拟业务逻辑
        return "用户信息: " + userId + ", 数据库: " + databaseUrl + ", Redis: " + redisHost;
    }
    
    private void reloadDatabaseConnection(String newUrl) {
        System.out.println("重新加载数据库连接: " + newUrl);
        // 实现数据库连接重载逻辑
    }
    
    private void reloadRedisConnection(String newHost) {
        System.out.println("重新加载Redis连接: " + newHost);
        // 实现Redis连接重载逻辑
    }
    
    public void shutdown() {
        try {
            serviceRegistry.unregisterService();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 2. 订单服务
```java
package com.example.service;

import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import com.example.discovery.ServiceDiscovery;
import com.example.lock.DistributedLock;
import java.util.HashMap;
import java.util.Map;

public class OrderService {
    private ConfigurationManager configManager;
    private ServiceRegistry serviceRegistry;
    private ServiceDiscovery serviceDiscovery;
    private DistributedLock orderLock;
    
    public OrderService(ConfigurationManager configManager, ServiceRegistry serviceRegistry, 
                       ServiceDiscovery serviceDiscovery) {
        this.configManager = configManager;
        this.serviceRegistry = serviceRegistry;
        this.serviceDiscovery = serviceDiscovery;
        this.orderLock = new DistributedLock(configManager.getZooKeeper(), "/locks/order");
        
        loadConfig();
        registerService();
    }
    
    private void loadConfig() {
        try {
            String databaseUrl = configManager.getConfig("order-service", "database.url");
            System.out.println("订单服务配置加载完成: 数据库URL: " + databaseUrl);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void registerService() {
        try {
            Map<String, String> metadata = new HashMap<>();
            metadata.put("version", "1.0");
            metadata.put("weight", "1");
            
            serviceRegistry.registerService("192.168.1.101", 8081, metadata);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public String createOrder(String userId, String productId) {
        try {
            // 获取分布式锁
            if (orderLock.acquireLock(5000)) {
                try {
                    // 执行业务逻辑
                    System.out.println("创建订单: 用户=" + userId + ", 产品=" + productId);
                    
                    // 调用用户服务
                    String userInfo = callUserService(userId);
                    System.out.println("用户信息: " + userInfo);
                    
                    return "订单创建成功: " + userId + "-" + productId;
                } finally {
                    // 释放锁
                    orderLock.releaseLock();
                }
            } else {
                return "获取锁失败，无法创建订单";
            }
        } catch (Exception e) {
            e.printStackTrace();
            return "订单创建失败: " + e.getMessage();
        }
    }
    
    private String callUserService(String userId) {
        try {
            // 发现用户服务
            List<ServiceInstance> instances = serviceDiscovery.discoverService("user-service");
            
            if (instances != null && !instances.isEmpty()) {
                // 选择第一个可用实例
                ServiceInstance instance = instances.get(0);
                String url = "http://" + instance.getHost() + ":" + instance.getPort() + "/user/" + userId;
                
                // 这里应该实现实际的HTTP调用
                // 为了简化，返回模拟响应
                return "模拟调用用户服务: " + url;
            } else {
                return "用户服务不可用";
            }
        } catch (Exception e) {
            e.printStackTrace();
            return "调用用户服务失败: " + e.getMessage();
        }
    }
    
    public void shutdown() {
        try {
            serviceRegistry.unregisterService();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 🎮 主程序实现

### 1. 主程序
```java
package com.example;

import com.example.client.ZooKeeperClient;
import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import com.example.discovery.ServiceDiscovery;
import com.example.service.UserService;
import com.example.service.OrderService;
import com.example.service.PaymentService;

public class Main {
    public static void main(String[] args) {
        try {
            System.out.println("=== ZooKeeper 分布式系统启动 ===");
            
            // 创建ZooKeeper客户端
            ZooKeeperClient zkClient = new ZooKeeperClient("localhost:2181", 5000);
            
            // 创建配置管理器
            ConfigurationManager configManager = new ConfigurationManager(zkClient.getZooKeeper(), "/config");
            
            // 创建服务发现器
            ServiceDiscovery serviceDiscovery = new ServiceDiscovery(zkClient.getZooKeeper(), "/services");
            
            // 初始化配置
            initializeConfig(configManager);
            
            // 创建服务注册器
            ServiceRegistry userServiceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/services", "user-service");
            ServiceRegistry orderServiceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/services", "order-service");
            ServiceRegistry paymentServiceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/services", "payment-service");
            
            // 创建业务服务
            UserService userService = new UserService(configManager, userServiceRegistry);
            OrderService orderService = new OrderService(configManager, orderServiceRegistry, serviceDiscovery);
            PaymentService paymentService = new PaymentService(configManager, paymentServiceRegistry);
            
            // 模拟业务操作
            simulateBusinessOperations(userService, orderService, paymentService);
            
            // 保持服务运行
            Thread.sleep(60000); // 运行1分钟
            
            // 关闭服务
            shutdownServices(userService, orderService, paymentService);
            
            // 关闭ZooKeeper客户端
            zkClient.close();
            
            System.out.println("=== 系统已关闭 ===");
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private static void initializeConfig(ConfigurationManager configManager) throws Exception {
        System.out.println("初始化配置...");
        
        // 用户服务配置
        configManager.setConfig("user-service", "database.url", "jdbc:mysql://localhost:3306/userdb");
        configManager.setConfig("user-service", "redis.host", "localhost:6379");
        
        // 订单服务配置
        configManager.setConfig("order-service", "database.url", "jdbc:mysql://localhost:3306/orderdb");
        
        // 支付服务配置
        configManager.setConfig("payment-service", "database.url", "jdbc:mysql://localhost:3306/paymentdb");
        configManager.setConfig("payment-service", "payment.gateway", "https://api.payment.com");
        
        System.out.println("配置初始化完成");
    }
    
    private static void simulateBusinessOperations(UserService userService, OrderService orderService, 
                                                 PaymentService paymentService) {
        System.out.println("\n=== 模拟业务操作 ===");
        
        // 模拟用户查询
        System.out.println("\n1. 用户查询操作:");
        String userInfo = userService.getUserInfo("user123");
        System.out.println(userInfo);
        
        // 模拟订单创建
        System.out.println("\n2. 订单创建操作:");
        String orderResult = orderService.createOrder("user123", "product456");
        System.out.println(orderResult);
        
        // 模拟支付处理
        System.out.println("\n3. 支付处理操作:");
        String paymentResult = paymentService.processPayment("order789", 100.0);
        System.out.println(paymentResult);
        
        // 模拟配置更新
        System.out.println("\n4. 配置更新操作:");
        try {
            ConfigurationManager configManager = userService.getConfigManager();
            configManager.setConfig("user-service", "database.url", "jdbc:mysql://newhost:3306/userdb");
            System.out.println("数据库配置已更新");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private static void shutdownServices(UserService userService, OrderService orderService, 
                                       PaymentService paymentService) {
        System.out.println("\n=== 关闭服务 ===");
        
        userService.shutdown();
        orderService.shutdown();
        paymentService.shutdown();
        
        System.out.println("所有服务已关闭");
    }
}
```

## 🧪 测试用例

### 1. 单元测试
```java
package com.example;

import com.example.client.ZooKeeperClient;
import com.example.config.ConfigurationManager;
import com.example.discovery.ServiceRegistry;
import com.example.discovery.ServiceDiscovery;
import com.example.lock.DistributedLock;
import org.junit.Test;
import org.junit.Before;
import org.junit.After;
import static org.junit.Assert.*;

public class ZooKeeperDemoTest {
    private ZooKeeperClient zkClient;
    private ConfigurationManager configManager;
    private ServiceRegistry serviceRegistry;
    private ServiceDiscovery serviceDiscovery;
    
    @Before
    public void setUp() throws Exception {
        // 启动ZooKeeper客户端
        zkClient = new ZooKeeperClient("localhost:2181", 5000);
        
        // 创建配置管理器
        configManager = new ConfigurationManager(zkClient.getZooKeeper(), "/test-config");
        
        // 创建服务注册器
        serviceRegistry = new ServiceRegistry(zkClient.getZooKeeper(), "/test-services", "test-service");
        
        // 创建服务发现器
        serviceDiscovery = new ServiceDiscovery(zkClient.getZooKeeper(), "/test-services");
    }
    
    @Test
    public void testConfigurationManager() throws Exception {
        System.out.println("测试配置管理器...");
        
        // 设置配置
        configManager.setConfig("test-app", "test-key", "test-value");
        
        // 获取配置
        String value = configManager.getConfig("test-app", "test-key");
        assertEquals("test-value", value);
        
        System.out.println("配置管理器测试通过");
    }
    
    @Test
    public void testServiceRegistry() throws Exception {
        System.out.println("测试服务注册...");
        
        // 注册服务
        Map<String, String> metadata = new HashMap<>();
        metadata.put("version", "1.0");
        metadata.put("weight", "1");
        
        serviceRegistry.registerService("localhost", 8080, metadata);
        
        // 发现服务
        List<ServiceInstance> instances = serviceDiscovery.discoverService("test-service");
        assertNotNull(instances);
        assertTrue(instances.size() > 0);
        
        ServiceInstance instance = instances.get(0);
        assertEquals("localhost", instance.getHost());
        assertEquals(8080, instance.getPort());
        assertEquals("UP", instance.getStatus());
        
        System.out.println("服务注册测试通过");
    }
    
    @Test
    public void testDistributedLock() throws Exception {
        System.out.println("测试分布式锁...");
        
        DistributedLock lock = new DistributedLock(zkClient.getZooKeeper(), "/test-locks");
        
        // 获取锁
        boolean acquired = lock.acquireLock(5000);
        assertTrue(acquired);
        assertTrue(lock.isLocked());
        
        // 释放锁
        lock.releaseLock();
        assertFalse(lock.isLocked());
        
        System.out.println("分布式锁测试通过");
    }
    
    @After
    public void tearDown() throws Exception {
        // 清理测试数据
        try {
            serviceRegistry.unregisterService();
        } catch (Exception e) {
            // 忽略清理异常
        }
        
        // 关闭ZooKeeper客户端
        if (zkClient != null) {
            zkClient.close();
        }
    }
}
```

## 🚀 运行说明

### 1. 环境准备
```bash
# 1. 确保ZooKeeper服务已启动
zkServer.sh start

# 2. 检查ZooKeeper状态
zkServer.sh status

# 3. 检查端口监听
netstat -tlnp | grep :2181
```

### 2. 编译运行
```bash
# 1. 编译项目
mvn clean compile

# 2. 运行主程序
mvn exec:java -Dexec.mainClass="com.example.Main"

# 3. 运行测试
mvn test
```

### 3. 验证功能
```bash
# 1. 连接ZooKeeper客户端
zkCli.sh -server localhost:2181

# 2. 查看配置节点
ls /config
get /config/user-service/database.url

# 3. 查看服务节点
ls /services
ls /services/user-service

# 4. 查看锁节点
ls /locks
```

## 🔗 总结

这个实战项目展示了ZooKeeper在分布式系统中的典型应用：

1. **配置中心**：实现配置的动态管理和实时同步
2. **服务发现**：实现服务的自动注册和发现
3. **分布式锁**：实现分布式环境下的互斥访问
4. **业务集成**：展示如何在实际业务中使用这些功能

通过这个项目，你可以：
- 深入理解ZooKeeper的核心概念
- 掌握ZooKeeper的Java API使用
- 学会设计分布式系统架构
- 为实际项目开发打下基础

**祝你学习愉快！** 🎯
