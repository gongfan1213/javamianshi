# ZooKeeper æ ¸å¿ƒç‰¹æ€§

## ğŸ¯ ä¸€è‡´æ€§ä¿è¯

ZooKeeperæä¾›å¼ºä¸€è‡´æ€§ä¿è¯ï¼Œè¿™æ˜¯å…¶æœ€æ ¸å¿ƒçš„ç‰¹æ€§ã€‚

### 1. é¡ºåºä¸€è‡´æ€§ï¼ˆSequential Consistencyï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¡ºåºä¸€è‡´æ€§ä¿è¯                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®¢æˆ·ç«¯A: create /app/config â†’ æˆåŠŸ                        â”‚
â”‚  å®¢æˆ·ç«¯B: get /app/config â†’ èƒ½çœ‹åˆ°Aåˆ›å»ºçš„æ•°æ®               â”‚
â”‚  å®¢æˆ·ç«¯C: set /app/config â†’ åŸºäºAçš„æ•°æ®è¿›è¡Œæ›´æ–°             â”‚
â”‚  æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°çš„æ“ä½œé¡ºåºä¸€è‡´                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°åŸç†**ï¼š
- å…¨å±€å•è°ƒé€’å¢çš„äº‹åŠ¡IDï¼ˆzxidï¼‰
- æ‰€æœ‰å†™æ“ä½œæŒ‰é¡ºåºæ‰§è¡Œ
- è¯»æ“ä½œèƒ½çœ‹åˆ°ä¹‹å‰æ‰€æœ‰å†™æ“ä½œçš„ç»“æœ

### 2. åŸå­æ€§ï¼ˆAtomicityï¼‰
```java
// äº‹åŠ¡è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
try {
    // åˆ›å»ºé…ç½®èŠ‚ç‚¹
    zk.create("/app/config", "config-data".getBytes(), 
               ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    
    // åˆ›å»ºå­èŠ‚ç‚¹
    zk.create("/app/config/database", "db-config".getBytes(),
               ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    
    // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªæ“ä½œå›æ»š
} catch (Exception e) {
    // åŸå­æ€§ä¿è¯ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
    System.out.println("æ“ä½œå¤±è´¥ï¼Œéœ€è¦å›æ»š");
}
```

### 3. å•ä¸€ç³»ç»Ÿæ˜ åƒï¼ˆSingle System Imageï¼‰
```java
// å®¢æˆ·ç«¯è¿æ¥åˆ°ä»»æ„èŠ‚ç‚¹çœ‹åˆ°çš„æ•°æ®ä¸€è‡´
String connectString1 = "zk1:2181";
String connectString2 = "zk2:2181";

ZooKeeper zk1 = new ZooKeeper(connectString1, 5000, watcher);
ZooKeeper zk2 = new ZooKeeper(connectString2, 5000, watcher);

// ä¸¤ä¸ªè¿æ¥çœ‹åˆ°çš„æ•°æ®å®Œå…¨ä¸€è‡´
byte[] data1 = zk1.getData("/app/config", false, null);
byte[] data2 = zk2.getData("/app/config", false, null);

// data1 å’Œ data2 å†…å®¹å®Œå…¨ç›¸åŒ
assert Arrays.equals(data1, data2);
```

## ğŸ”„ ä¼šè¯ç®¡ç†

### 1. ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
```java
// åˆ›å»ºä¼šè¯
ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, watcher);

// ä¼šè¯çŠ¶æ€ç›‘å¬
Watcher watcher = new Watcher() {
    public void process(WatchedEvent event) {
        switch (event.getState()) {
            case SyncConnected:
                System.out.println("ä¼šè¯å»ºç«‹æˆåŠŸ");
                break;
            case Disconnected:
                System.out.println("ä¼šè¯æ–­å¼€");
                break;
            case Expired:
                System.out.println("ä¼šè¯è¿‡æœŸï¼Œéœ€è¦é‡æ–°è¿æ¥");
                break;
            case ConnectedReadOnly:
                System.out.println("åªè¯»è¿æ¥");
                break;
        }
    }
};
```

### 2. ä¼šè¯è¶…æ—¶å¤„ç†
```java
// è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´
int sessionTimeout = 10000; // 10ç§’
ZooKeeper zk = new ZooKeeper("localhost:2181", sessionTimeout, watcher);

// ä¼šè¯è¿‡æœŸåçš„å¤„ç†
if (zk.getState() == ZooKeeper.States.EXPIRED) {
    // é‡æ–°åˆ›å»ºè¿æ¥
    zk = new ZooKeeper("localhost:2181", sessionTimeout, watcher);
}
```

### 3. å¿ƒè·³æœºåˆ¶
```java
// å®šæœŸå‘é€å¿ƒè·³ä¿æŒä¼šè¯æ´»è·ƒ
Timer heartbeatTimer = new Timer();
heartbeatTimer.scheduleAtFixedRate(new TimerTask() {
    @Override
    public void run() {
        try {
            // æ‰§è¡Œä¸€ä¸ªè½»é‡çº§æ“ä½œä¿æŒä¼šè¯æ´»è·ƒ
            zk.exists("/heartbeat", false);
        } catch (Exception e) {
            System.out.println("å¿ƒè·³å¤±è´¥: " + e.getMessage());
        }
    }
}, 0, 5000); // æ¯5ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
```

## ğŸ‘€ ç›‘å¬æœºåˆ¶ï¼ˆWatcherï¼‰

### 1. ä¸€æ¬¡æ€§ç›‘å¬å™¨
```java
// ä¸€æ¬¡æ€§ç›‘å¬å™¨ï¼Œè§¦å‘åè‡ªåŠ¨å¤±æ•ˆ
Watcher oneTimeWatcher = new Watcher() {
    public void process(WatchedEvent event) {
        System.out.println("èŠ‚ç‚¹å˜åŒ–: " + event.getPath());
        // ç›‘å¬å™¨è§¦å‘åè‡ªåŠ¨å¤±æ•ˆï¼Œä¸ä¼šå†æ¬¡è§¦å‘
    }
};

// æ³¨å†Œç›‘å¬å™¨
zk.getData("/app/config", oneTimeWatcher, null);
```

### 2. æŒä¹…ç›‘å¬å™¨
```java
// æŒä¹…ç›‘å¬å™¨ï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°æ³¨å†Œ
Watcher persistentWatcher = new Watcher() {
    public void process(WatchedEvent event) {
        System.out.println("èŠ‚ç‚¹å˜åŒ–: " + event.getPath());
        
        // é‡æ–°æ³¨å†Œç›‘å¬å™¨ä»¥ç»§ç»­ç›‘å¬
        try {
            zk.getData(event.getPath(), this, null);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
};

// æ³¨å†Œç›‘å¬å™¨
zk.getData("/app/config", persistentWatcher, null);
```

### 3. ç›‘å¬å™¨ç±»å‹
```java
// ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
zk.getData("/app/config", dataWatcher, null);

// ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
zk.getChildren("/app", childrenWatcher);

// ç›‘å¬èŠ‚ç‚¹å­˜åœ¨æ€§
zk.exists("/app/new-node", existsWatcher);
```

## ğŸ” è®¿é—®æ§åˆ¶ï¼ˆACLï¼‰

### 1. å†…ç½®ACLæ–¹æ¡ˆ
```java
// å®Œå…¨å¼€æ”¾è®¿é—®
List<ACL> openAcl = ZooDefs.Ids.OPEN_ACL_UNSAFE;

// åªè¯»è®¿é—®
List<ACL> readOnlyAcl = Arrays.asList(
    new ACL(ZooDefs.Perms.READ, new Id("world", "anyone"))
);

// åˆ›å»ºè€…å®Œå…¨æ§åˆ¶
List<ACL> creatorAcl = ZooDefs.Ids.CREATOR_ALL_ACL;
```

### 2. è‡ªå®šä¹‰ACL
```java
// åˆ›å»ºå¸¦ç”¨æˆ·åå¯†ç çš„ACL
List<ACL> customAcl = Arrays.asList(
    new ACL(ZooDefs.Perms.READ | ZooDefs.Perms.WRITE, 
            new Id("digest", "user:password"))
);

// åˆ›å»ºèŠ‚ç‚¹æ—¶ä½¿ç”¨è‡ªå®šä¹‰ACL
zk.create("/app/secure", "secure-data".getBytes(), customAcl, CreateMode.PERSISTENT);
```

### 3. ACLæƒé™ç»„åˆ
```java
// ç»„åˆå¤šç§æƒé™
int permissions = ZooDefs.Perms.READ |    // è¯»å–æƒé™
                 ZooDefs.Perms.WRITE |   // å†™å…¥æƒé™
                 ZooDefs.Perms.CREATE;   // åˆ›å»ºæƒé™

List<ACL> acls = Arrays.asList(
    new ACL(permissions, new Id("world", "anyone"))
);
```

## ğŸ“Š ç‰ˆæœ¬æ§åˆ¶

### 1. ä¹è§‚é”æœºåˆ¶
```java
// è·å–å½“å‰ç‰ˆæœ¬
Stat stat = new Stat();
byte[] data = zk.getData("/app/config", false, stat);
int currentVersion = stat.getVersion();

// åŸºäºç‰ˆæœ¬å·æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰
try {
    Stat newStat = zk.setData("/app/config", "new-data".getBytes(), currentVersion);
    System.out.println("æ›´æ–°æˆåŠŸï¼Œæ–°ç‰ˆæœ¬: " + newStat.getVersion());
} catch (KeeperException.BadVersionException e) {
    System.out.println("ç‰ˆæœ¬å†²çªï¼Œæ•°æ®å·²è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹");
    // é‡æ–°è·å–æ•°æ®å¹¶é‡è¯•
}
```

### 2. æ¡ä»¶æ›´æ–°
```java
// æ¡ä»¶æ›´æ–°ï¼šåªæœ‰å½“æ•°æ®æœªè¢«ä¿®æ”¹æ—¶æ‰æ›´æ–°
public boolean updateIfUnchanged(String path, String newData, String expectedData) {
    try {
        Stat stat = new Stat();
        byte[] currentData = zk.getData(path, false, stat);
        String current = new String(currentData);
        
        if (current.equals(expectedData)) {
            zk.setData(path, newData.getBytes(), stat.getVersion());
            return true;
        }
        return false;
    } catch (Exception e) {
        e.printStackTrace();
        return false;
    }
}
```

## ğŸš€ é«˜å¯ç”¨æ€§

### 1. è‡ªåŠ¨æ•…éšœè½¬ç§»
```java
// é…ç½®å¤šä¸ªZooKeeperæœåŠ¡å™¨
String connectString = "zk1:2181,zk2:2181,zk3:2181";
ZooKeeper zk = new ZooKeeper(connectString, 5000, watcher);

// è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šå¦‚æœzk1ä¸å¯ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°zk2æˆ–zk3
```

### 2. è¿æ¥é‡è¯•æœºåˆ¶
```java
// å®ç°è¿æ¥é‡è¯•
public ZooKeeper connectWithRetry(String connectString, int timeout, int maxRetries) {
    for (int i = 0; i < maxRetries; i++) {
        try {
            ZooKeeper zk = new ZooKeeper(connectString, timeout, watcher);
            
            // ç­‰å¾…è¿æ¥å»ºç«‹
            CountDownLatch connectedSignal = new CountDownLatch(1);
            Watcher connectionWatcher = new Watcher() {
                public void process(WatchedEvent event) {
                    if (event.getState() == Event.KeeperState.SyncConnected) {
                        connectedSignal.countDown();
                    }
                }
            };
            
            if (connectedSignal.await(10, TimeUnit.SECONDS)) {
                return zk;
            }
        } catch (Exception e) {
            System.out.println("è¿æ¥å¤±è´¥ï¼Œé‡è¯• " + (i + 1) + "/" + maxRetries);
            try {
                Thread.sleep(1000 * (i + 1)); // é€’å¢å»¶è¿Ÿ
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
                break;
            }
        }
    }
    throw new RuntimeException("æ— æ³•è¿æ¥åˆ°ZooKeeper");
}
```

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–

### 1. æ‰¹é‡æ“ä½œ
```java
// æ‰¹é‡åˆ›å»ºèŠ‚ç‚¹
public void batchCreateNodes(String parentPath, List<String> nodeNames) {
    List<Op> operations = new ArrayList<>();
    
    for (String nodeName : nodeNames) {
        String path = parentPath + "/" + nodeName;
        Op createOp = Op.create(path, "data".getBytes(), 
                               ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        operations.add(createOp);
    }
    
    try {
        // æ‰§è¡Œæ‰¹é‡æ“ä½œ
        List<OpResult> results = zk.multi(operations);
        System.out.println("æ‰¹é‡åˆ›å»ºæˆåŠŸï¼Œåˆ›å»ºäº† " + results.size() + " ä¸ªèŠ‚ç‚¹");
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

### 2. å¼‚æ­¥æ“ä½œ
```java
// å¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹
zk.create("/app/async-node", "async-data".getBytes(), 
          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT,
          new AsyncCallback.StringCallback() {
              public void processResult(int rc, String path, Object ctx, String name) {
                  if (rc == KeeperException.Code.OK.intValue()) {
                      System.out.println("å¼‚æ­¥åˆ›å»ºæˆåŠŸ: " + name);
                  } else {
                      System.out.println("å¼‚æ­¥åˆ›å»ºå¤±è´¥: " + KeeperException.Code.get(rc));
                  }
              }
          }, "context-data");
```

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [ZooKeeperé›†ç¾¤éƒ¨ç½²](./05.ZooKeeperé›†ç¾¤éƒ¨ç½².md) - å­¦ä¹ é›†ç¾¤éƒ¨ç½²
- [Javaå®¢æˆ·ç«¯ä½¿ç”¨](./06.Javaå®¢æˆ·ç«¯ä½¿ç”¨.md) - å¼€å§‹Javaç¼–ç¨‹
- [åˆ†å¸ƒå¼é”å®ç°](./07.åˆ†å¸ƒå¼é”å®ç°.md) - å®è·µåº”ç”¨

---

**è®°ä½ï¼šZooKeeperçš„æ ¸å¿ƒç‰¹æ€§æ˜¯ä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§ï¼** ğŸ¯
