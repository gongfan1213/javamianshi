# ZooKeeper 集群部署

## 🏗️ 集群架构设计

### 1. 推荐集群规模
```
┌─────────────────────────────────────────────────────────────┐
│                    集群规模建议                              │
├─────────────────────────────────────────────────────────────┤
│  开发环境: 3节点 (1 Leader + 2 Follower)                   │
│  测试环境: 3-5节点 (1 Leader + 2-4 Follower)               │
│  生产环境: 5-7节点 (1 Leader + 4-6 Follower)               │
│  超大规模: 7+节点 (1 Leader + 6+ Follower)                 │
└─────────────────────────────────────────────────────────────┘
```

**为什么选择奇数节点？**
- 避免脑裂问题
- 选举时更容易达成多数共识
- 资源利用率更高

### 2. 网络拓扑
```
┌─────────────────────────────────────────────────────────────┐
│                    网络拓扑示例                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │
│  │   ZK1       │    │   ZK2       │    │   ZK3       │    │
│  │ 192.168.1.10│    │192.168.1.11 │    │192.168.1.12 │    │
│  │   Leader    │    │  Follower   │    │  Follower   │    │
│  └─────────────┘    └─────────────┘    └─────────────┘    │
│         │                    │                    │        │
│         └────────────────────┼────────────────────┘        │
│                              │                             │
│                    ┌─────────┴─────────┐                  │
│                    │    客户端网络      │                  │
│                    │  192.168.1.0/24   │                  │
│                    └───────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

## 📋 环境准备

### 1. 系统要求
```bash
# 操作系统：Linux (推荐 CentOS 7+ 或 Ubuntu 18+)
# Java版本：JDK 8 或 JDK 11
# 内存：至少 2GB RAM
# 磁盘：至少 10GB 可用空间
# 网络：节点间网络延迟 < 100ms

# 检查Java版本
java -version

# 检查系统资源
free -h
df -h
```

### 2. 创建专用用户
```bash
# 创建zookeeper用户
sudo useradd -r -m -d /opt/zookeeper zookeeper
sudo passwd zookeeper

# 设置sudo权限
sudo usermod -aG wheel zookeeper

# 切换到zookeeper用户
su - zookeeper
```

### 3. 下载ZooKeeper
```bash
# 下载ZooKeeper
cd /opt
wget https://downloads.apache.org/zookeeper/zookeeper-3.8.0/apache-zookeeper-3.8.0-bin.tar.gz

# 解压
tar -xzf apache-zookeeper-3.8.0-bin.tar.gz
ln -s apache-zookeeper-3.8.0 zookeeper

# 设置权限
sudo chown -R zookeeper:zookeeper /opt/zookeeper
```

## ⚙️ 配置文件

### 1. 主配置文件（zoo.cfg）
```properties
# 基本配置
tickTime=2000
initLimit=10
syncLimit=5
dataDir=/opt/zookeeper/data
dataLogDir=/opt/zookeeper/logs
clientPort=2181

# 自动清理快照和事务日志
autopurge.snapRetainCount=3
autopurge.purgeInterval=1

# 最大客户端连接数
maxClientCnxns=60

# 集群配置
server.1=192.168.1.10:2888:3888
server.2=192.168.1.11:2888:3888
server.3=192.168.1.12:2888:3888

# 端口说明：
# 2888: 节点间通信端口（Follower连接Leader）
# 3888: Leader选举端口（选举时使用）
```

### 2. 环境变量配置
```bash
# 编辑 ~/.bashrc
vim ~/.bashrc

# 添加以下内容
export ZOOKEEPER_HOME=/opt/zookeeper
export PATH=$PATH:$ZOOKEEPER_HOME/bin

# 重新加载配置
source ~/.bashrc
```

### 3. JVM配置
```bash
# 编辑 $ZOOKEEPER_HOME/conf/java.env
vim $ZOOKEEPER_HOME/conf/java.env

# 添加以下内容
export SERVER_JVMFLAGS="-Xms1g -Xmx1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

## 🚀 集群部署步骤

### 1. 准备数据目录
```bash
# 在每个节点上创建数据目录
mkdir -p /opt/zookeeper/data
mkdir -p /opt/zookeeper/logs

# 设置权限
chmod 755 /opt/zookeeper/data
chmod 755 /opt/zookeeper/logs
```

### 2. 配置节点ID
```bash
# 节点1 (192.168.1.10)
echo "1" > /opt/zookeeper/data/myid

# 节点2 (192.168.1.11)
echo "2" > /opt/zookeeper/data/myid

# 节点3 (192.168.1.12)
echo "3" > /opt/zookeeper/data/myid
```

### 3. 启动集群
```bash
# 在所有节点上启动ZooKeeper
zkServer.sh start

# 检查启动状态
zkServer.sh status

# 查看日志
tail -f /opt/zookeeper/logs/zookeeper.out
```

### 4. 验证集群状态
```bash
# 连接到任意节点
zkCli.sh -server 192.168.1.10:2181

# 查看集群信息
echo stat | nc 192.168.1.10 2181
echo mntr | nc 192.168.1.10 2181
```

## 🔧 集群管理

### 1. 启动/停止脚本
```bash
#!/bin/bash
# 创建启动脚本 start-zk.sh
case "$1" in
    start)
        echo "启动ZooKeeper集群..."
        for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
            echo "启动 $host..."
            ssh zookeeper@$host "zkServer.sh start"
        done
        ;;
    stop)
        echo "停止ZooKeeper集群..."
        for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
            echo "停止 $host..."
            ssh zookeeper@$host "zkServer.sh stop"
        done
        ;;
    restart)
        $0 stop
        sleep 5
        $0 start
        ;;
    status)
        echo "检查集群状态..."
        for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
            echo "检查 $host..."
            ssh zookeeper@$host "zkServer.sh status"
        done
        ;;
    *)
        echo "用法: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
```

### 2. 监控脚本
```bash
#!/bin/bash
# 创建监控脚本 monitor-zk.sh
echo "=== ZooKeeper 集群监控 ==="
echo "时间: $(date)"
echo ""

for host in 192.168.1.10 192.168.1.11 192.168.1.12; do
    echo "节点: $host"
    
    # 检查进程状态
    if ssh zookeeper@$host "pgrep -f zookeeper" > /dev/null; then
        echo "  进程状态: 运行中"
        
        # 检查端口监听
        if ssh zookeeper@$host "netstat -tlnp | grep :2181" > /dev/null; then
            echo "  端口状态: 监听中"
        else
            echo "  端口状态: 未监听"
        fi
        
        # 获取节点角色
        role=$(ssh zookeeper@$host "echo stat | nc localhost 2181 | grep Mode" | awk '{print $2}')
        echo "  节点角色: $role"
    else
        echo "  进程状态: 未运行"
    fi
    
    echo ""
done
```

## 📊 性能调优

### 1. 内存配置
```properties
# 根据服务器内存调整JVM参数
# 4GB内存服务器
export SERVER_JVMFLAGS="-Xms2g -Xmx2g -XX:+UseG1GC"

# 8GB内存服务器
export SERVER_JVMFLAGS="-Xms4g -Xmx4g -XX:+UseG1GC"

# 16GB内存服务器
export SERVER_JVMFLAGS="-Xms8g -Xmx8g -XX:+UseG1GC"
```

### 2. 网络调优
```bash
# 调整系统网络参数
echo 'net.core.somaxconn = 65535' >> /etc/sysctl.conf
echo 'net.ipv4.tcp_max_syn_backlog = 65535' >> /etc/sysctl.conf
echo 'net.core.netdev_max_backlog = 65535' >> /etc/sysctl.conf

# 应用配置
sysctl -p
```

### 3. 磁盘优化
```bash
# 使用SSD存储
# 调整文件系统参数
echo 'vm.dirty_ratio = 15' >> /etc/sysctl.conf
echo 'vm.dirty_background_ratio = 5' >> /etc/sysctl.conf

# 应用配置
sysctl -p
```

## 🚨 故障处理

### 1. 常见问题排查
```bash
# 检查进程状态
ps aux | grep zookeeper

# 检查端口监听
netstat -tlnp | grep :2181

# 检查日志
tail -f /opt/zookeeper/logs/zookeeper.out

# 检查数据目录
ls -la /opt/zookeeper/data/
```

### 2. 集群恢复
```bash
# 如果集群无法启动，检查数据一致性
# 1. 停止所有节点
zkServer.sh stop

# 2. 备份数据目录
cp -r /opt/zookeeper/data /opt/zookeeper/data.backup

# 3. 清理事务日志（保留最新快照）
find /opt/zookeeper/data -name "log.*" -delete

# 4. 重新启动集群
zkServer.sh start
```

### 3. 节点替换
```bash
# 替换故障节点
# 1. 在新节点上安装ZooKeeper
# 2. 复制配置文件
# 3. 设置正确的节点ID
# 4. 启动新节点
# 5. 验证集群状态
```

## 📈 监控指标

### 1. 关键指标
- **连接数**：当前客户端连接数
- **请求延迟**：读写请求的响应时间
- **内存使用**：JVM堆内存使用情况
- **磁盘使用**：数据目录和日志目录大小
- **网络流量**：节点间通信流量

### 2. 监控工具
```bash
# 使用ZooKeeper自带的四字命令
echo stat | nc localhost 2181    # 状态信息
echo mntr | nc localhost 2181    # 监控指标
echo conf | nc localhost 2181    # 配置信息
echo envi | nc localhost 2181    # 环境信息
```

## 🔗 下一步学习

- [Java客户端使用](./06.Java客户端使用.md) - 开始Java编程
- [分布式锁实现](./07.分布式锁实现.md) - 实践应用
- [配置中心实现](./08.配置中心实现.md) - 学习配置管理

---

**记住：集群部署是生产环境的基础，稳定性和性能是关键！** 🎯
