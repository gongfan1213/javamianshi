# Java å®¢æˆ·ç«¯ä½¿ç”¨

## ğŸš€ ç¯å¢ƒå‡†å¤‡

### 1. Mavenä¾èµ–
```xml
<dependency>
    <groupId>org.apache.zookeeper</groupId>
    <artifactId>zookeeper</artifactId>
    <version>3.8.0</version>
</dependency>

<!-- å¦‚æœéœ€è¦è¿æ¥æ± åŠŸèƒ½ -->
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-framework</artifactId>
    <version>5.3.0</version>
</dependency>
```

### 2. Gradleä¾èµ–
```gradle
implementation 'org.apache.zookeeper:zookeeper:3.8.0'
implementation 'org.apache.curator:curator-framework:5.3.0'
```

## ğŸ”Œ åŸºç¡€è¿æ¥

### 1. åˆ›å»ºè¿æ¥
```java
import org.apache.zookeeper.*;
import java.util.concurrent.CountDownLatch;

public class ZooKeeperClient {
    private ZooKeeper zk;
    private CountDownLatch connectedSignal = new CountDownLatch(1);
    
    public void connect(String connectString) throws Exception {
        // åˆ›å»ºè¿æ¥
        zk = new ZooKeeper(connectString, 5000, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getState() == Event.KeeperState.SyncConnected) {
                    connectedSignal.countDown();
                    System.out.println("è¿æ¥æˆåŠŸï¼");
                }
            }
        });
        
        // ç­‰å¾…è¿æ¥å»ºç«‹
        connectedSignal.await();
    }
    
    public void close() throws InterruptedException {
        if (zk != null) {
            zk.close();
        }
    }
}
```

### 2. è¿æ¥çŠ¶æ€ç›‘å¬
```java
public class ConnectionWatcher implements Watcher {
    private CountDownLatch connectedSignal = new CountDownLatch(1);
    
    @Override
    public void process(WatchedEvent event) {
        System.out.println("æ”¶åˆ°äº‹ä»¶: " + event.getType() + " - " + event.getState());
        
        switch (event.getState()) {
            case SyncConnected:
                System.out.println("è¿æ¥å»ºç«‹æˆåŠŸ");
                connectedSignal.countDown();
                break;
            case Disconnected:
                System.out.println("è¿æ¥æ–­å¼€");
                break;
            case Expired:
                System.out.println("ä¼šè¯è¿‡æœŸ");
                break;
            case ConnectedReadOnly:
                System.out.println("åªè¯»è¿æ¥");
                break;
            case AuthFailed:
                System.out.println("è®¤è¯å¤±è´¥");
                break;
        }
    }
    
    public void waitForConnection() throws InterruptedException {
        connectedSignal.await();
    }
}
```

## ğŸ“ åŸºæœ¬æ“ä½œ

### 1. åˆ›å»ºèŠ‚ç‚¹
```java
public class NodeOperations {
    private ZooKeeper zk;
    
    public NodeOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // åˆ›å»ºæŒä¹…èŠ‚ç‚¹
    public String createPersistentNode(String path, String data) throws Exception {
        return zk.create(path, data.getBytes(), 
                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    }
    
    // åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
    public String createEphemeralNode(String path, String data) throws Exception {
        return zk.create(path, data.getBytes(), 
                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
    }
    
    // åˆ›å»ºé¡ºåºèŠ‚ç‚¹
    public String createSequentialNode(String path, String data) throws Exception {
        return zk.create(path, data.getBytes(), 
                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
    }
    
    // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
    public String createEphemeralSequentialNode(String path, String data) throws Exception {
        return zk.create(path, data.getBytes(), 
                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);
    }
}
```

### 2. è¯»å–èŠ‚ç‚¹
```java
public class ReadOperations {
    private ZooKeeper zk;
    
    public ReadOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // è·å–èŠ‚ç‚¹æ•°æ®
    public String getNodeData(String path) throws Exception {
        byte[] data = zk.getData(path, false, null);
        return new String(data);
    }
    
    // è·å–èŠ‚ç‚¹æ•°æ®ï¼ˆå¸¦ç‰ˆæœ¬ä¿¡æ¯ï¼‰
    public NodeData getNodeDataWithStat(String path) throws Exception {
        Stat stat = new Stat();
        byte[] data = zk.getData(path, false, stat);
        
        return new NodeData(
            new String(data),
            stat.getVersion(),
            stat.getCtime(),
            stat.getMtime()
        );
    }
    
    // è·å–å­èŠ‚ç‚¹åˆ—è¡¨
    public List<String> getChildren(String path) throws Exception {
        return zk.getChildren(path, false);
    }
    
    // æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
    public boolean exists(String path) throws Exception {
        return zk.exists(path, false) != null;
    }
    
    // è·å–èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯
    public Stat getStat(String path) throws Exception {
        return zk.exists(path, false);
    }
}

// èŠ‚ç‚¹æ•°æ®åŒ…è£…ç±»
public class NodeData {
    private String data;
    private int version;
    private long createTime;
    private long modifyTime;
    
    // æ„é€ å‡½æ•°ã€getterã€setter...
}
```

### 3. æ›´æ–°èŠ‚ç‚¹
```java
public class UpdateOperations {
    private ZooKeeper zk;
    
    public UpdateOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // æ›´æ–°èŠ‚ç‚¹æ•°æ®
    public Stat updateNodeData(String path, String newData) throws Exception {
        return zk.setData(path, newData.getBytes(), -1);
    }
    
    // æ¡ä»¶æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰
    public boolean updateIfVersion(String path, String newData, int expectedVersion) {
        try {
            Stat stat = zk.setData(path, newData.getBytes(), expectedVersion);
            System.out.println("æ›´æ–°æˆåŠŸï¼Œæ–°ç‰ˆæœ¬: " + stat.getVersion());
            return true;
        } catch (KeeperException.BadVersionException e) {
            System.out.println("ç‰ˆæœ¬å†²çªï¼Œæ›´æ–°å¤±è´¥");
            return false;
        } catch (Exception e) {
            System.out.println("æ›´æ–°å¤±è´¥: " + e.getMessage());
            return false;
        }
    }
    
    // åŸå­æ›´æ–°ï¼šåªæœ‰å½“æ•°æ®æœªè¢«ä¿®æ”¹æ—¶æ‰æ›´æ–°
    public boolean updateIfUnchanged(String path, String newData, String expectedData) {
        try {
            Stat stat = new Stat();
            byte[] currentData = zk.getData(path, false, stat);
            String current = new String(currentData);
            
            if (current.equals(expectedData)) {
                zk.setData(path, newData.getBytes(), stat.getVersion());
                return true;
            }
            return false;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }
}
```

### 4. åˆ é™¤èŠ‚ç‚¹
```java
public class DeleteOperations {
    private ZooKeeper zk;
    
    public DeleteOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // åˆ é™¤èŠ‚ç‚¹
    public void deleteNode(String path) throws Exception {
        zk.delete(path, -1);
    }
    
    // æ¡ä»¶åˆ é™¤
    public boolean deleteIfVersion(String path, int expectedVersion) {
        try {
            zk.delete(path, expectedVersion);
            return true;
        } catch (KeeperException.BadVersionException e) {
            System.out.println("ç‰ˆæœ¬å†²çªï¼Œåˆ é™¤å¤±è´¥");
            return false;
        } catch (Exception e) {
            System.out.println("åˆ é™¤å¤±è´¥: " + e.getMessage());
            return false;
        }
    }
    
    // é€’å½’åˆ é™¤ï¼ˆåˆ é™¤èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹ï¼‰
    public void deleteRecursively(String path) throws Exception {
        List<String> children = zk.getChildren(path, false);
        
        // å…ˆåˆ é™¤å­èŠ‚ç‚¹
        for (String child : children) {
            deleteRecursively(path + "/" + child);
        }
        
        // å†åˆ é™¤å½“å‰èŠ‚ç‚¹
        zk.delete(path, -1);
    }
}
```

## ğŸ‘€ ç›‘å¬æœºåˆ¶

### 1. æ•°æ®å˜åŒ–ç›‘å¬
```java
public class DataWatcher implements Watcher {
    private ZooKeeper zk;
    private String path;
    
    public DataWatcher(ZooKeeper zk, String path) {
        this.zk = zk;
        this.path = path;
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDataChanged) {
            System.out.println("èŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–: " + event.getPath());
            
            try {
                // é‡æ–°æ³¨å†Œç›‘å¬å™¨
                zk.getData(path, this, null);
                
                // å¤„ç†æ•°æ®å˜åŒ–
                handleDataChange();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    private void handleDataChange() throws Exception {
        String data = new String(zk.getData(path, false, null));
        System.out.println("æ–°æ•°æ®: " + data);
        
        // åœ¨è¿™é‡Œæ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘
        // æ¯”å¦‚ï¼šæ›´æ–°æœ¬åœ°ç¼“å­˜ã€é€šçŸ¥å…¶ä»–ç»„ä»¶ç­‰
    }
    
    // å¼€å§‹ç›‘å¬
    public void startWatching() throws Exception {
        zk.getData(path, this, null);
    }
}
```

### 2. å­èŠ‚ç‚¹å˜åŒ–ç›‘å¬
```java
public class ChildrenWatcher implements Watcher {
    private ZooKeeper zk;
    private String path;
    
    public ChildrenWatcher(ZooKeeper zk, String path) {
        this.zk = zk;
        this.path = path;
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeChildrenChanged) {
            System.out.println("å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–: " + event.getPath());
            
            try {
                // é‡æ–°æ³¨å†Œç›‘å¬å™¨
                zk.getChildren(path, this);
                
                // å¤„ç†å­èŠ‚ç‚¹å˜åŒ–
                handleChildrenChange();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    private void handleChildrenChange() throws Exception {
        List<String> children = zk.getChildren(path, false);
        System.out.println("å½“å‰å­èŠ‚ç‚¹: " + children);
        
        // åœ¨è¿™é‡Œæ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘
        // æ¯”å¦‚ï¼šæœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ç­‰
    }
    
    // å¼€å§‹ç›‘å¬
    public void startWatching() throws Exception {
        zk.getChildren(path, this);
    }
}
```

### 3. èŠ‚ç‚¹å­˜åœ¨æ€§ç›‘å¬
```java
public class ExistsWatcher implements Watcher {
    private ZooKeeper zk;
    private String path;
    
    public ExistsWatcher(ZooKeeper zk, String path) {
        this.zk = zk;
        this.path = path;
    }
    
    @Override
    public void process(WatchedEvent event) {
        switch (event.getType()) {
            case NodeCreated:
                System.out.println("èŠ‚ç‚¹åˆ›å»º: " + event.getPath());
                handleNodeCreated();
                break;
            case NodeDeleted:
                System.out.println("èŠ‚ç‚¹åˆ é™¤: " + event.getPath());
                handleNodeDeleted();
                break;
            case NodeDataChanged:
                System.out.println("èŠ‚ç‚¹æ•°æ®å˜åŒ–: " + event.getPath());
                handleNodeDataChanged();
                break;
        }
        
        // é‡æ–°æ³¨å†Œç›‘å¬å™¨
        try {
            zk.exists(path, this);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void handleNodeCreated() {
        System.out.println("å¤„ç†èŠ‚ç‚¹åˆ›å»ºäº‹ä»¶");
        // æ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘
    }
    
    private void handleNodeDeleted() {
        System.out.println("å¤„ç†èŠ‚ç‚¹åˆ é™¤äº‹ä»¶");
        // æ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘
    }
    
    private void handleNodeDataChanged() {
        System.out.println("å¤„ç†èŠ‚ç‚¹æ•°æ®å˜åŒ–äº‹ä»¶");
        // æ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘
    }
    
    // å¼€å§‹ç›‘å¬
    public void startWatching() throws Exception {
        zk.exists(path, this);
    }
}
```

## ğŸ” è®¿é—®æ§åˆ¶

### 1. åˆ›å»ºå¸¦ACLçš„èŠ‚ç‚¹
```java
public class ACLOperations {
    private ZooKeeper zk;
    
    public ACLOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // åˆ›å»ºåªè¯»èŠ‚ç‚¹
    public String createReadOnlyNode(String path, String data) throws Exception {
        List<ACL> acls = Arrays.asList(
            new ACL(ZooDefs.Perms.READ, new Id("world", "anyone"))
        );
        
        return zk.create(path, data.getBytes(), acls, CreateMode.PERSISTENT);
    }
    
    // åˆ›å»ºå¸¦ç”¨æˆ·åå¯†ç çš„èŠ‚ç‚¹
    public String createSecureNode(String path, String data, String username, String password) throws Exception {
        String auth = username + ":" + password;
        List<ACL> acls = Arrays.asList(
            new ACL(ZooDefs.Perms.ALL, new Id("digest", auth))
        );
        
        return zk.create(path, data.getBytes(), acls, CreateMode.PERSISTENT);
    }
    
    // åˆ›å»ºIPé™åˆ¶çš„èŠ‚ç‚¹
    public String createIPRestrictedNode(String path, String data, String ip) throws Exception {
        List<ACL> acls = Arrays.asList(
            new ACL(ZooDefs.Perms.ALL, new Id("ip", ip))
        );
        
        return zk.create(path, data.getBytes(), acls, CreateMode.PERSISTENT);
    }
}
```

### 2. è®¤è¯
```java
public class AuthenticationOperations {
    private ZooKeeper zk;
    
    public AuthenticationOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // æ·»åŠ è®¤è¯ä¿¡æ¯
    public void addAuth(String scheme, String auth) throws Exception {
        zk.addAuthInfo(scheme, auth.getBytes());
    }
    
    // æ·»åŠ ç”¨æˆ·åå¯†ç è®¤è¯
    public void addDigestAuth(String username, String password) throws Exception {
        String auth = username + ":" + password;
        zk.addAuthInfo("digest", auth.getBytes());
    }
    
    // æ·»åŠ IPè®¤è¯
    public void addIPAuth(String ip) throws Exception {
        zk.addAuthInfo("ip", ip.getBytes());
    }
}
```

## ğŸš€ é«˜çº§åŠŸèƒ½

### 1. æ‰¹é‡æ“ä½œ
```java
public class BatchOperations {
    private ZooKeeper zk;
    
    public BatchOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // æ‰¹é‡åˆ›å»ºèŠ‚ç‚¹
    public List<OpResult> batchCreateNodes(String parentPath, List<String> nodeNames) throws Exception {
        List<Op> operations = new ArrayList<>();
        
        for (String nodeName : nodeNames) {
            String path = parentPath + "/" + nodeName;
            Op createOp = Op.create(path, "data".getBytes(), 
                                   ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            operations.add(createOp);
        }
        
        return zk.multi(operations);
    }
    
    // æ‰¹é‡æ›´æ–°èŠ‚ç‚¹
    public List<OpResult> batchUpdateNodes(Map<String, String> pathDataMap) throws Exception {
        List<Op> operations = new ArrayList<>();
        
        for (Map.Entry<String, String> entry : pathDataMap.entrySet()) {
            Op setDataOp = Op.setData(entry.getKey(), entry.getValue().getBytes(), -1);
            operations.add(setDataOp);
        }
        
        return zk.multi(operations);
    }
    
    // æ‰¹é‡åˆ é™¤èŠ‚ç‚¹
    public List<OpResult> batchDeleteNodes(List<String> paths) throws Exception {
        List<Op> operations = new ArrayList<>();
        
        for (String path : paths) {
            Op deleteOp = Op.delete(path, -1);
            operations.add(deleteOp);
        }
        
        return zk.multi(operations);
    }
}
```

### 2. å¼‚æ­¥æ“ä½œ
```java
public class AsyncOperations {
    private ZooKeeper zk;
    
    public AsyncOperations(ZooKeeper zk) {
        this.zk = zk;
    }
    
    // å¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹
    public void createNodeAsync(String path, String data) {
        zk.create(path, data.getBytes(), 
                  ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT,
                  new AsyncCallback.StringCallback() {
                      @Override
                      public void processResult(int rc, String path, Object ctx, String name) {
                          if (rc == KeeperException.Code.OK.intValue()) {
                              System.out.println("å¼‚æ­¥åˆ›å»ºæˆåŠŸ: " + name);
                          } else {
                              System.out.println("å¼‚æ­¥åˆ›å»ºå¤±è´¥: " + KeeperException.Code.get(rc));
                          }
                      }
                  }, "context-data");
    }
    
    // å¼‚æ­¥è·å–æ•°æ®
    public void getDataAsync(String path) {
        zk.getData(path, false, new AsyncCallback.DataCallback() {
            @Override
            public void processResult(int rc, String path, Object ctx, byte[] data, Stat stat) {
                if (rc == KeeperException.Code.OK.intValue()) {
                    String content = new String(data);
                    System.out.println("å¼‚æ­¥è·å–æ•°æ®æˆåŠŸ: " + content);
                } else {
                    System.out.println("å¼‚æ­¥è·å–æ•°æ®å¤±è´¥: " + KeeperException.Code.get(rc));
                }
            }
        }, "context-data");
    }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. è¿æ¥ç®¡ç†
```java
public class ZooKeeperManager {
    private static final String CONNECT_STRING = "localhost:2181";
    private static final int SESSION_TIMEOUT = 5000;
    private static final int CONNECTION_TIMEOUT = 10000;
    
    private ZooKeeper zk;
    private volatile boolean isConnected = false;
    
    public ZooKeeper connect() throws Exception {
        CountDownLatch connectedSignal = new CountDownLatch(1);
        
        zk = new ZooKeeper(CONNECT_STRING, SESSION_TIMEOUT, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getState() == Event.KeeperState.SyncConnected) {
                    isConnected = true;
                    connectedSignal.countDown();
                } else if (event.getState() == Event.KeeperState.Disconnected) {
                    isConnected = false;
                } else if (event.getState() == Event.KeeperState.Expired) {
                    isConnected = false;
                    // é‡æ–°è¿æ¥é€»è¾‘
                    reconnect();
                }
            }
        });
        
        if (!connectedSignal.await(CONNECTION_TIMEOUT, TimeUnit.MILLISECONDS)) {
            throw new RuntimeException("è¿æ¥è¶…æ—¶");
        }
        
        return zk;
    }
    
    private void reconnect() {
        // å®ç°é‡è¿é€»è¾‘
        try {
            Thread.sleep(1000);
            connect();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public boolean isConnected() {
        return isConnected && zk != null && zk.getState() == ZooKeeper.States.CONNECTED;
    }
    
    public void close() throws InterruptedException {
        if (zk != null) {
            zk.close();
        }
    }
}
```

### 2. å¼‚å¸¸å¤„ç†
```java
public class ZooKeeperExceptionHandler {
    
    public static void handleException(Exception e) {
        if (e instanceof KeeperException.NoNodeException) {
            System.out.println("èŠ‚ç‚¹ä¸å­˜åœ¨");
        } else if (e instanceof KeeperException.NodeExistsException) {
            System.out.println("èŠ‚ç‚¹å·²å­˜åœ¨");
        } else if (e instanceof KeeperException.BadVersionException) {
            System.out.println("ç‰ˆæœ¬å†²çª");
        } else if (e instanceof KeeperException.ConnectionLossException) {
            System.out.println("è¿æ¥ä¸¢å¤±");
        } else if (e instanceof KeeperException.SessionExpiredException) {
            System.out.println("ä¼šè¯è¿‡æœŸ");
        } else {
            System.out.println("å…¶ä»–å¼‚å¸¸: " + e.getMessage());
        }
    }
    
    public static boolean isRetryableException(Exception e) {
        return e instanceof KeeperException.ConnectionLossException ||
               e instanceof KeeperException.SessionExpiredException;
    }
}
```

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [åˆ†å¸ƒå¼é”å®ç°](./07.åˆ†å¸ƒå¼é”å®ç°.md) - å®è·µåº”ç”¨
- [é…ç½®ä¸­å¿ƒå®ç°](./08.é…ç½®ä¸­å¿ƒå®ç°.md) - å­¦ä¹ é…ç½®ç®¡ç†
- [æœåŠ¡å‘ç°å®ç°](./09.æœåŠ¡å‘ç°å®ç°.md) - å­¦ä¹ æœåŠ¡å‘ç°

---

**è®°ä½ï¼šJavaå®¢æˆ·ç«¯æ˜¯ä½¿ç”¨ZooKeeperçš„æ ¸å¿ƒï¼ŒæŒæ¡APIå°±èƒ½å®ç°å„ç§åˆ†å¸ƒå¼åŠŸèƒ½ï¼** ğŸ¯
