# ZooKeeper 架构设计

## 🏗️ 整体架构概览

ZooKeeper采用主从架构（Master-Slave），通过ZAB协议（ZooKeeper Atomic Broadcast）保证数据一致性。

```
┌─────────────────────────────────────────────────────────────┐
│                    ZooKeeper 集群                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │   Leader    │  │   Follower  │  │   Follower  │        │
│  │   (主节点)   │  │   (从节点)   │  │   (从节点)   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
         │                    │                    │
         ▼                    ▼                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Client    │    │   Client    │    │   Client    │
│   (客户端)   │    │   (客户端)   │    │   (客户端)   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 🎭 角色定义

### 1. Leader（领导者）
- **职责**：处理所有写请求，协调集群
- **特点**：唯一性，集群中只有一个Leader
- **选举**：通过ZAB协议选举产生

### 2. Follower（跟随者）
- **职责**：处理读请求，参与Leader选举
- **特点**：可以有多个，处理客户端请求
- **限制**：不能处理写请求

### 3. Observer（观察者）
- **职责**：只处理读请求，不参与选举
- **特点**：提高读性能，不影响写性能
- **用途**：扩展集群读能力

## 🔄 ZAB协议详解

### 阶段1：Leader选举（Leader Election）
```
┌─────────────────────────────────────────────────────────────┐
│                        Leader选举过程                        │
├─────────────────────────────────────────────────────────────┤
│  1. 每个节点发起投票请求                                    │
│  2. 节点投票给比自己ID大的节点                              │
│  3. 统计投票结果，得票过半的成为Leader                      │
│  4. 其他节点成为Follower                                   │
└─────────────────────────────────────────────────────────────┘
```

### 阶段2：原子广播（Atomic Broadcast）
```
┌─────────────────────────────────────────────────────────────┐
│                        写请求流程                           │
├─────────────────────────────────────────────────────────────┤
│  Client → Leader → 提案(Proposal) → Follower → 确认(Ack)   │
│     ↑                                                    │
│     └── 响应结果 ← Leader ← 提交(Commit) ← Follower        │
└─────────────────────────────────────────────────────────────┘
```

## 📊 数据一致性保证

### 1. 顺序一致性（Sequential Consistency）
- 所有客户端看到的操作顺序一致
- 全局单调递增的事务ID（zxid）

### 2. 原子性（Atomicity）
- 事务要么全部成功，要么全部失败
- 不存在部分成功的情况

### 3. 单一系统映像（Single System Image）
- 客户端连接到任意节点看到的数据一致
- 强一致性保证

## 🔧 集群配置示例

### 1. 配置文件（zoo.cfg）
```properties
# 基本配置
tickTime=2000
initLimit=10
syncLimit=5
dataDir=/var/lib/zookeeper
clientPort=2181

# 集群配置
server.1=zk1.example.com:2888:3888
server.2=zk2.example.com:2888:3888
server.3=zk3.example.com:2888:3888

# 端口说明
# 2888: 节点间通信端口
# 3888: Leader选举端口
```

### 2. 节点ID配置
```bash
# 在每个节点的dataDir目录下创建myid文件
echo "1" > /var/lib/zookeeper/myid  # 节点1
echo "2" > /var/lib/zookeeper/myid  # 节点2
echo "3" > /var/lib/zookeeper/myid  # 节点3
```

## 🚀 高可用性设计

### 1. 故障检测
- 心跳机制检测节点状态
- 自动故障转移
- 快速故障恢复

### 2. 负载均衡
- 读请求分散到所有节点
- 写请求统一由Leader处理
- Observer节点扩展读能力

### 3. 数据备份
- 内存数据快照
- 事务日志持久化
- 多副本数据同步

## 💻 客户端连接策略

### 1. 连接字符串格式
```java
// 单机连接
String connectString = "localhost:2181";

// 集群连接
String connectString = "zk1:2181,zk2:2181,zk3:2181";

// 带路径的连接
String connectString = "zk1:2181,zk2:2181,zk3:2181/app";
```

### 2. 连接状态监听
```java
// 监听连接状态变化
watcher = new Watcher() {
    public void process(WatchedEvent event) {
        switch (event.getState()) {
            case SyncConnected:
                System.out.println("连接成功");
                break;
            case Disconnected:
                System.out.println("连接断开");
                break;
            case Expired:
                System.out.println("会话过期");
                break;
        }
    }
};
```

## 🔍 性能优化策略

### 1. 内存优化
- 合理设置JVM堆内存
- 调整数据目录大小
- 优化快照和日志清理策略

### 2. 网络优化
- 使用专用网络
- 调整超时参数
- 优化心跳间隔

### 3. 存储优化
- SSD存储介质
- 合理的快照频率
- 及时清理过期数据

## 💡 架构设计要点

1. **Leader选举是ZAB协议的核心**
2. **写请求必须经过Leader，读请求可以任意节点**
3. **Observer节点提高读性能，不影响写性能**
4. **ZAB协议保证数据一致性和顺序性**
5. **集群节点数建议为奇数，避免脑裂问题**

## 🔗 下一步学习

- [ZooKeeper数据模型](./03.ZooKeeper数据模型.md) - 了解数据结构
- [ZooKeeper核心特性](./04.ZooKeeper核心特性.md) - 学习核心功能
- [ZooKeeper集群部署](./05.ZooKeeper集群部署.md) - 实践部署

---

**记住：ZAB协议是ZooKeeper的核心，理解它就能理解整个系统！** 🎯
