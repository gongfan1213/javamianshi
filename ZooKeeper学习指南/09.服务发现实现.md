# 服务发现实现

## 🎯 服务发现概述

服务发现是微服务架构中的核心组件，用于解决服务之间的相互发现和通信问题。

### 1. 服务发现的作用
- **服务注册**：服务启动时向注册中心注册自己
- **服务发现**：客户端通过注册中心查找服务
- **健康检查**：监控服务的健康状态
- **负载均衡**：在多个服务实例间分发请求

### 2. ZooKeeper实现服务发现的优势
- **实时通知**：Watcher机制支持服务状态实时变化
- **临时节点**：服务下线时自动清理注册信息
- **顺序节点**：支持服务实例的版本管理
- **强一致性**：ZAB协议保证服务信息一致性

## 🏗️ 基础服务发现实现

### 1. 服务注册结构
```
/services
├── user-service/
│   ├── instance-001
│   │   ├── host: 192.168.1.100
│   │   ├── port: 8080
│   │   ├── status: UP
│   │   └── metadata: {"version":"1.0","weight":1}
│   └── instance-002
│       ├── host: 192.168.1.101
│       ├── port: 8080
│       ├── status: UP
│       └── metadata: {"version":"1.0","weight":1}
├── order-service/
│   └── instance-001
│       ├── host: 192.168.1.102
│       ├── port: 8081
│       ├── status: UP
│       └── metadata: {"version":"1.0","weight":1}
└── payment-service/
    └── instance-001
        ├── host: 192.168.1.103
        ├── port: 8082
        ├── status: UP
        └── metadata: {"version":"1.0","weight":1}
```

### 2. 服务注册器
```java
public class ServiceRegistry {
    private ZooKeeper zk;
    private String serviceRootPath;
    private String serviceName;
    private String serviceInstance;
    private String instancePath;
    
    public ServiceRegistry(ZooKeeper zk, String serviceRootPath, String serviceName) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
        this.serviceName = serviceName;
        this.serviceInstance = UUID.randomUUID().toString();
        initializeServiceRoot();
    }
    
    // 初始化服务根目录
    private void initializeServiceRoot() {
        try {
            if (zk.exists(serviceRootPath, false) == null) {
                zk.create(serviceRootPath, "services-root".getBytes(),
                          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // 注册服务
    public void registerService(String host, int port, Map<String, String> metadata) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // 确保服务目录存在
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, "service".getBytes(),
                      ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
        
        // 创建服务实例节点
        String instancePath = servicePath + "/" + serviceInstance;
        
        // 构建实例信息
        ServiceInstance instance = new ServiceInstance();
        instance.setHost(host);
        instance.setPort(port);
        instance.setStatus("UP");
        instance.setMetadata(metadata);
        instance.setRegisterTime(System.currentTimeMillis());
        
        // 序列化实例信息
        String instanceData = serializeInstance(instance);
        
        // 创建临时节点，会话结束时自动删除
        this.instancePath = zk.create(instancePath, instanceData.getBytes(),
                                     ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
        
        System.out.println("服务注册成功: " + this.instancePath);
        
        // 注册会话监听器
        registerSessionWatcher();
    }
    
    // 注销服务
    public void unregisterService() throws Exception {
        if (instancePath != null) {
            try {
                zk.delete(instancePath, -1);
                System.out.println("服务注销成功: " + instancePath);
            } catch (KeeperException.NoNodeException e) {
                // 节点已被删除，忽略异常
            }
        }
    }
    
    // 更新服务状态
    public void updateServiceStatus(String status) throws Exception {
        if (instancePath != null) {
            try {
                // 获取当前实例信息
                byte[] data = zk.getData(instancePath, false, null);
                ServiceInstance instance = deserializeInstance(new String(data));
                
                // 更新状态
                instance.setStatus(status);
                instance.setUpdateTime(System.currentTimeMillis());
                
                // 更新节点数据
                String newData = serializeInstance(instance);
                zk.setData(instancePath, newData.getBytes(), -1);
                
                System.out.println("服务状态更新成功: " + status);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    // 注册会话监听器
    private void registerSessionWatcher() {
        // 监听会话状态变化
        zk.register(new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getState() == Event.KeeperState.Expired) {
                    System.out.println("会话过期，尝试重新注册服务");
                    try {
                        // 重新连接并注册服务
                        reconnectAndReregister();
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        });
    }
    
    // 重新连接并重新注册
    private void reconnectAndReregister() throws Exception {
        // 这里应该实现重新连接逻辑
        // 为了简化，这里只是打印日志
        System.out.println("需要实现重新连接逻辑");
    }
    
    // 序列化服务实例
    private String serializeInstance(ServiceInstance instance) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.writeValueAsString(instance);
    }
    
    // 反序列化服务实例
    private ServiceInstance deserializeInstance(String data) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(data, ServiceInstance.class);
    }
}

// 服务实例类
public class ServiceInstance {
    private String host;
    private int port;
    private String status;
    private Map<String, String> metadata;
    private long registerTime;
    private long updateTime;
    
    // 构造函数、getter、setter...
}
```

### 3. 服务发现器
```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private String serviceRootPath;
    private Map<String, List<ServiceInstance>> serviceCache = new ConcurrentHashMap<>();
    private Map<String, List<ServiceChangeListener>> listeners = new ConcurrentHashMap<>();
    
    public ServiceDiscovery(ZooKeeper zk, String serviceRootPath) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
    }
    
    // 发现服务
    public List<ServiceInstance> discoverService(String serviceName) throws Exception {
        // 先从缓存获取
        List<ServiceInstance> cachedInstances = serviceCache.get(serviceName);
        if (cachedInstances != null) {
            return new ArrayList<>(cachedInstances);
        }
        
        // 从ZooKeeper获取
        List<ServiceInstance> instances = loadServiceInstances(serviceName);
        
        // 更新缓存
        serviceCache.put(serviceName, instances);
        
        // 注册监听器
        registerServiceWatcher(serviceName);
        
        return instances;
    }
    
    // 加载服务实例
    private List<ServiceInstance> loadServiceInstances(String serviceName) throws Exception {
        List<ServiceInstance> instances = new ArrayList<>();
        String servicePath = serviceRootPath + "/" + serviceName;
        
        try {
            List<String> instanceNames = zk.getChildren(servicePath, false);
            
            for (String instanceName : instanceNames) {
                try {
                    String instancePath = servicePath + "/" + instanceName;
                    byte[] data = zk.getData(instancePath, false, null);
                    
                    ServiceInstance instance = deserializeInstance(new String(data));
                    instances.add(instance);
                } catch (Exception e) {
                    System.out.println("加载服务实例失败: " + instanceName + ", 错误: " + e.getMessage());
                }
            }
        } catch (KeeperException.NoNodeException e) {
            // 服务不存在
        }
        
        return instances;
    }
    
    // 注册服务监听器
    private void registerServiceWatcher(String serviceName) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // 监听子节点变化
        zk.getChildren(servicePath, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeChildrenChanged) {
                    try {
                        // 重新加载服务实例
                        List<ServiceInstance> newInstances = loadServiceInstances(serviceName);
                        
                        // 更新缓存
                        List<ServiceInstance> oldInstances = serviceCache.get(serviceName);
                        serviceCache.put(serviceName, newInstances);
                        
                        // 通知监听器
                        notifyServiceChange(serviceName, oldInstances, newInstances);
                        
                        // 重新注册监听器
                        registerServiceWatcher(serviceName);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        }, null);
    }
    
    // 添加服务变化监听器
    public void addServiceChangeListener(String serviceName, ServiceChangeListener listener) {
        listeners.computeIfAbsent(serviceName, k -> new ArrayList<>()).add(listener);
    }
    
    // 移除服务变化监听器
    public void removeServiceChangeListener(String serviceName, ServiceChangeListener listener) {
        List<ServiceChangeListener> listenerList = listeners.get(serviceName);
        if (listenerList != null) {
            listenerList.remove(listener);
        }
    }
    
    // 通知服务变化
    private void notifyServiceChange(String serviceName, List<ServiceInstance> oldInstances, 
                                   List<ServiceInstance> newInstances) {
        List<ServiceChangeListener> listenerList = listeners.get(serviceName);
        if (listenerList != null) {
            for (ServiceChangeListener listener : listenerList) {
                try {
                    listener.onServiceChange(serviceName, oldInstances, newInstances);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    // 获取所有服务名称
    public List<String> getAllServiceNames() throws Exception {
        try {
            return zk.getChildren(serviceRootPath, false);
        } catch (Exception e) {
            return new ArrayList<>();
        }
    }
    
    // 检查服务是否存在
    public boolean isServiceExists(String serviceName) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        return zk.exists(servicePath, false) != null;
    }
    
    // 反序列化服务实例
    private ServiceInstance deserializeInstance(String data) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(data, ServiceInstance.class);
    }
}

// 服务变化监听器接口
public interface ServiceChangeListener {
    void onServiceChange(String serviceName, List<ServiceInstance> oldInstances, 
                        List<ServiceInstance> newInstances);
}
```

## 🚀 高级服务发现功能

### 1. 负载均衡器
```java
public class LoadBalancer {
    
    // 随机负载均衡
    public static ServiceInstance randomLoadBalance(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        Random random = new Random();
        int index = random.nextInt(instances.size());
        return instances.get(index);
    }
    
    // 轮询负载均衡
    public static class RoundRobinLoadBalancer {
        private AtomicInteger counter = new AtomicInteger(0);
        
        public ServiceInstance next(List<ServiceInstance> instances) {
            if (instances == null || instances.isEmpty()) {
                return null;
            }
            
            int index = counter.getAndIncrement() % instances.size();
            return instances.get(index);
        }
    }
    
    // 权重负载均衡
    public static ServiceInstance weightedLoadBalance(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        // 计算总权重
        int totalWeight = 0;
        for (ServiceInstance instance : instances) {
            String weightStr = instance.getMetadata().get("weight");
            int weight = weightStr != null ? Integer.parseInt(weightStr) : 1;
            totalWeight += weight;
        }
        
        if (totalWeight == 0) {
            return randomLoadBalance(instances);
        }
        
        // 随机选择
        Random random = new Random();
        int randomWeight = random.nextInt(totalWeight);
        
        int currentWeight = 0;
        for (ServiceInstance instance : instances) {
            String weightStr = instance.getMetadata().get("weight");
            int weight = weightStr != null ? Integer.parseInt(weightStr) : 1;
            currentWeight += weight;
            
            if (randomWeight < currentWeight) {
                return instance;
            }
        }
        
        return instances.get(instances.size() - 1);
    }
    
    // 健康检查负载均衡
    public static ServiceInstance healthyLoadBalance(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        // 过滤健康实例
        List<ServiceInstance> healthyInstances = instances.stream()
            .filter(instance -> "UP".equals(instance.getStatus()))
            .collect(Collectors.toList());
        
        if (healthyInstances.isEmpty()) {
            return null;
        }
        
        // 使用随机负载均衡
        return randomLoadBalance(healthyInstances);
    }
}
```

### 2. 服务健康检查
```java
public class HealthChecker {
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(5);
    private Map<String, HealthCheckTask> healthCheckTasks = new ConcurrentHashMap<>();
    
    // 开始健康检查
    public void startHealthCheck(String serviceName, String host, int port, 
                                ServiceRegistry serviceRegistry) {
        HealthCheckTask task = new HealthCheckTask(host, port, serviceRegistry);
        healthCheckTasks.put(serviceName, task);
        
        // 每30秒检查一次
        scheduler.scheduleAtFixedRate(task, 0, 30, TimeUnit.SECONDS);
    }
    
    // 停止健康检查
    public void stopHealthCheck(String serviceName) {
        HealthCheckTask task = healthCheckTasks.remove(serviceName);
        if (task != null) {
            task.stop();
        }
    }
    
    // 健康检查任务
    private static class HealthCheckTask implements Runnable {
        private String host;
        private int port;
        private ServiceRegistry serviceRegistry;
        private volatile boolean running = true;
        
        public HealthCheckTask(String host, int port, ServiceRegistry serviceRegistry) {
            this.host = host;
            this.port = port;
            this.serviceRegistry = serviceRegistry;
        }
        
        @Override
        public void run() {
            if (!running) {
                return;
            }
            
            try {
                // 检查服务健康状态
                boolean isHealthy = checkHealth(host, port);
                
                if (isHealthy) {
                    serviceRegistry.updateServiceStatus("UP");
                } else {
                    serviceRegistry.updateServiceStatus("DOWN");
                }
            } catch (Exception e) {
                System.out.println("健康检查失败: " + e.getMessage());
                try {
                    serviceRegistry.updateServiceStatus("DOWN");
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
            }
        }
        
        private boolean checkHealth(String host, int port) {
            try (Socket socket = new Socket()) {
                socket.connect(new InetSocketAddress(host, port), 5000);
                return true;
            } catch (Exception e) {
                return false;
            }
        }
        
        public void stop() {
            running = false;
        }
    }
    
    // 关闭健康检查器
    public void shutdown() {
        scheduler.shutdown();
        try {
            if (!scheduler.awaitTermination(60, TimeUnit.SECONDS)) {
                scheduler.shutdownNow();
            }
        } catch (InterruptedException e) {
            scheduler.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

### 3. 服务路由
```java
public class ServiceRouter {
    private ServiceDiscovery serviceDiscovery;
    private LoadBalancer loadBalancer;
    
    public ServiceRouter(ServiceDiscovery serviceDiscovery) {
        this.serviceDiscovery = serviceDiscovery;
        this.loadBalancer = new LoadBalancer.RoundRobinLoadBalancer();
    }
    
    // 路由到服务实例
    public ServiceInstance routeToService(String serviceName) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            throw new RuntimeException("服务不可用: " + serviceName);
        }
        
        // 使用负载均衡选择实例
        return loadBalancer.next(instances);
    }
    
    // 路由到指定版本的服务
    public ServiceInstance routeToServiceVersion(String serviceName, String version) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            throw new RuntimeException("服务不可用: " + serviceName);
        }
        
        // 过滤指定版本的实例
        List<ServiceInstance> versionInstances = instances.stream()
            .filter(instance -> version.equals(instance.getMetadata().get("version")))
            .collect(Collectors.toList());
        
        if (versionInstances.isEmpty()) {
            throw new RuntimeException("指定版本的服务不可用: " + serviceName + ":" + version);
        }
        
        return loadBalancer.next(versionInstances);
    }
    
    // 路由到指定区域的实例
    public ServiceInstance routeToServiceRegion(String serviceName, String region) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            throw new RuntimeException("服务不可用: " + serviceName);
        }
        
        // 过滤指定区域的实例
        List<ServiceInstance> regionInstances = instances.stream()
            .filter(instance -> region.equals(instance.getMetadata().get("region")))
            .collect(Collectors.toList());
        
        if (regionInstances.isEmpty()) {
            // 如果指定区域没有实例，返回任意实例
            return loadBalancer.next(instances);
        }
        
        return loadBalancer.next(regionInstances);
    }
}
```

## 💡 使用示例

### 1. 服务注册示例
```java
public class ServiceRegistrationExample {
    public static void main(String[] args) {
        try {
            ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, null);
            
            // 创建服务注册器
            ServiceRegistry registry = new ServiceRegistry(zk, "/services", "user-service");
            
            // 注册服务
            Map<String, String> metadata = new HashMap<>();
            metadata.put("version", "1.0");
            metadata.put("weight", "1");
            metadata.put("region", "us-east-1");
            
            registry.registerService("192.168.1.100", 8080, metadata);
            
            // 启动健康检查
            HealthChecker healthChecker = new HealthChecker();
            healthChecker.startHealthCheck("user-service", "192.168.1.100", 8080, registry);
            
            // 保持服务运行
            Thread.sleep(60000); // 运行1分钟
            
            // 停止健康检查
            healthChecker.stopHealthCheck("user-service");
            healthChecker.shutdown();
            
            // 注销服务
            registry.unregisterService();
            
            zk.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 2. 服务发现示例
```java
public class ServiceDiscoveryExample {
    public static void main(String[] args) {
        try {
            ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, null);
            
            // 创建服务发现器
            ServiceDiscovery discovery = new ServiceDiscovery(zk, "/services");
            
            // 添加服务变化监听器
            discovery.addServiceChangeListener("user-service", new ServiceChangeListener() {
                @Override
                public void onServiceChange(String serviceName, List<ServiceInstance> oldInstances, 
                                         List<ServiceInstance> newInstances) {
                    System.out.println("服务变化通知:");
                    System.out.println("服务名称: " + serviceName);
                    System.out.println("旧实例数量: " + (oldInstances != null ? oldInstances.size() : 0));
                    System.out.println("新实例数量: " + (newInstances != null ? newInstances.size() : 0));
                }
            });
            
            // 发现服务
            List<ServiceInstance> instances = discovery.discoverService("user-service");
            System.out.println("发现服务实例数量: " + instances.size());
            
            for (ServiceInstance instance : instances) {
                System.out.println("实例: " + instance.getHost() + ":" + instance.getPort());
                System.out.println("状态: " + instance.getStatus());
                System.out.println("元数据: " + instance.getMetadata());
            }
            
            // 使用负载均衡选择实例
            ServiceInstance selectedInstance = LoadBalancer.randomLoadBalance(instances);
            if (selectedInstance != null) {
                System.out.println("选择的实例: " + selectedInstance.getHost() + ":" + selectedInstance.getPort());
            }
            
            Thread.sleep(30000); // 等待30秒观察服务变化
            
            zk.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 3. 完整服务调用示例
```java
public class ServiceCallExample {
    public static void main(String[] args) {
        try {
            ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, null);
            
            // 创建服务发现器和路由器
            ServiceDiscovery discovery = new ServiceDiscovery(zk, "/services");
            ServiceRouter router = new ServiceRouter(discovery);
            
            // 模拟服务调用
            for (int i = 0; i < 5; i++) {
                try {
                    // 路由到服务实例
                    ServiceInstance instance = router.routeToService("user-service");
                    
                    System.out.println("第" + (i + 1) + "次调用:");
                    System.out.println("  目标实例: " + instance.getHost() + ":" + instance.getPort());
                    System.out.println("  实例状态: " + instance.getStatus());
                    
                    // 模拟HTTP调用
                    String response = callService(instance);
                    System.out.println("  响应结果: " + response);
                    
                } catch (Exception e) {
                    System.out.println("第" + (i + 1) + "次调用失败: " + e.getMessage());
                }
                
                Thread.sleep(2000); // 等待2秒
            }
            
            zk.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // 模拟服务调用
    private static String callService(ServiceInstance instance) {
        // 这里应该实现实际的HTTP调用
        // 为了简化，这里只是返回模拟响应
        return "Hello from " + instance.getHost() + ":" + instance.getPort();
    }
}
```

## 🔧 服务发现管理工具

### 1. 服务监控
```java
public class ServiceMonitor {
    private ServiceDiscovery serviceDiscovery;
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    
    public ServiceMonitor(ServiceDiscovery serviceDiscovery) {
        this.serviceDiscovery = serviceDiscovery;
    }
    
    // 开始监控
    public void startMonitoring() {
        scheduler.scheduleAtFixedRate(this::monitorServices, 0, 60, TimeUnit.SECONDS);
    }
    
    // 监控服务
    private void monitorServices() {
        try {
            List<String> serviceNames = serviceDiscovery.getAllServiceNames();
            
            System.out.println("=== 服务监控报告 ===");
            System.out.println("时间: " + new Date());
            System.out.println("总服务数: " + serviceNames.size());
            
            for (String serviceName : serviceNames) {
                List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
                
                long upCount = instances.stream()
                    .filter(instance -> "UP".equals(instance.getStatus()))
                    .count();
                
                long downCount = instances.size() - upCount;
                
                System.out.println("服务: " + serviceName);
                System.out.println("  总实例数: " + instances.size());
                System.out.println("  健康实例数: " + upCount);
                System.out.println("  异常实例数: " + downCount);
                System.out.println("  可用性: " + (instances.size() > 0 ? (upCount * 100 / instances.size()) + "%" : "0%"));
            }
            
            System.out.println("==================");
            
        } catch (Exception e) {
            System.out.println("监控失败: " + e.getMessage());
        }
    }
    
    // 停止监控
    public void stopMonitoring() {
        scheduler.shutdown();
    }
}
```

### 2. 服务统计
```java
public class ServiceStatistics {
    private ServiceDiscovery serviceDiscovery;
    private Map<String, ServiceStats> serviceStats = new ConcurrentHashMap<>();
    
    // 获取服务统计信息
    public ServiceStats getServiceStats(String serviceName) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        ServiceStats stats = new ServiceStats();
        stats.setServiceName(serviceName);
        stats.setTotalInstances(instances.size());
        stats.setHealthyInstances((int) instances.stream()
            .filter(instance -> "UP".equals(instance.getStatus()))
            .count());
        stats.setUnhealthyInstances((int) instances.stream()
            .filter(instance -> "DOWN".equals(instance.getStatus()))
            .count());
        
        // 计算平均响应时间（如果有的话）
        double avgResponseTime = instances.stream()
            .mapToDouble(instance -> {
                String responseTime = instance.getMetadata().get("responseTime");
                return responseTime != null ? Double.parseDouble(responseTime) : 0.0;
            })
            .average()
            .orElse(0.0);
        
        stats.setAverageResponseTime(avgResponseTime);
        
        return stats;
    }
    
    // 获取所有服务统计
    public Map<String, ServiceStats> getAllServiceStats() throws Exception {
        List<String> serviceNames = serviceDiscovery.getAllServiceNames();
        Map<String, ServiceStats> allStats = new HashMap<>();
        
        for (String serviceName : serviceNames) {
            allStats.put(serviceName, getServiceStats(serviceName));
        }
        
        return allStats;
    }
}

// 服务统计信息类
public class ServiceStats {
    private String serviceName;
    private int totalInstances;
    private int healthyInstances;
    private int unhealthyInstances;
    private double averageResponseTime;
    
    // 构造函数、getter、setter...
}
```

## 🚨 注意事项

### 1. 服务注册
- **临时节点**：使用临时节点确保服务下线时自动清理
- **心跳机制**：实现健康检查保持服务状态更新
- **重连机制**：ZooKeeper连接断开时自动重连并重新注册

### 2. 服务发现
- **缓存机制**：本地缓存减少ZooKeeper访问
- **监听器管理**：及时重新注册监听器
- **异常处理**：处理服务不可用的情况

### 3. 负载均衡
- **健康检查**：只路由到健康的服务实例
- **权重配置**：支持实例权重配置
- **故障转移**：主实例不可用时自动切换到备用实例

### 4. 性能优化
- **批量操作**：批量获取服务信息
- **异步处理**：异步处理服务变化通知
- **连接池**：复用ZooKeeper连接

## 🔗 下一步学习

- [面试题集锦](./10.面试题集锦.md) - 准备面试
- [实战项目](./11.实战项目.md) - 完整项目实践

---

**记住：服务发现是微服务架构的基础，掌握它就能实现服务的动态发现和路由！** 🎯
