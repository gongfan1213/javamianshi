# æœåŠ¡å‘ç°å®ç°

## ğŸ¯ æœåŠ¡å‘ç°æ¦‚è¿°

æœåŠ¡å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºè§£å†³æœåŠ¡ä¹‹é—´çš„ç›¸äº’å‘ç°å’Œé€šä¿¡é—®é¢˜ã€‚

### 1. æœåŠ¡å‘ç°çš„ä½œç”¨
- **æœåŠ¡æ³¨å†Œ**ï¼šæœåŠ¡å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±
- **æœåŠ¡å‘ç°**ï¼šå®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œä¸­å¿ƒæŸ¥æ‰¾æœåŠ¡
- **å¥åº·æ£€æŸ¥**ï¼šç›‘æ§æœåŠ¡çš„å¥åº·çŠ¶æ€
- **è´Ÿè½½å‡è¡¡**ï¼šåœ¨å¤šä¸ªæœåŠ¡å®ä¾‹é—´åˆ†å‘è¯·æ±‚

### 2. ZooKeeperå®ç°æœåŠ¡å‘ç°çš„ä¼˜åŠ¿
- **å®æ—¶é€šçŸ¥**ï¼šWatcheræœºåˆ¶æ”¯æŒæœåŠ¡çŠ¶æ€å®æ—¶å˜åŒ–
- **ä¸´æ—¶èŠ‚ç‚¹**ï¼šæœåŠ¡ä¸‹çº¿æ—¶è‡ªåŠ¨æ¸…ç†æ³¨å†Œä¿¡æ¯
- **é¡ºåºèŠ‚ç‚¹**ï¼šæ”¯æŒæœåŠ¡å®ä¾‹çš„ç‰ˆæœ¬ç®¡ç†
- **å¼ºä¸€è‡´æ€§**ï¼šZABåè®®ä¿è¯æœåŠ¡ä¿¡æ¯ä¸€è‡´æ€§

## ğŸ—ï¸ åŸºç¡€æœåŠ¡å‘ç°å®ç°

### 1. æœåŠ¡æ³¨å†Œç»“æ„
```
/services
â”œâ”€â”€ user-service/
â”‚   â”œâ”€â”€ instance-001
â”‚   â”‚   â”œâ”€â”€ host: 192.168.1.100
â”‚   â”‚   â”œâ”€â”€ port: 8080
â”‚   â”‚   â”œâ”€â”€ status: UP
â”‚   â”‚   â””â”€â”€ metadata: {"version":"1.0","weight":1}
â”‚   â””â”€â”€ instance-002
â”‚       â”œâ”€â”€ host: 192.168.1.101
â”‚       â”œâ”€â”€ port: 8080
â”‚       â”œâ”€â”€ status: UP
â”‚       â””â”€â”€ metadata: {"version":"1.0","weight":1}
â”œâ”€â”€ order-service/
â”‚   â””â”€â”€ instance-001
â”‚       â”œâ”€â”€ host: 192.168.1.102
â”‚       â”œâ”€â”€ port: 8081
â”‚       â”œâ”€â”€ status: UP
â”‚       â””â”€â”€ metadata: {"version":"1.0","weight":1}
â””â”€â”€ payment-service/
    â””â”€â”€ instance-001
        â”œâ”€â”€ host: 192.168.1.103
        â”œâ”€â”€ port: 8082
        â”œâ”€â”€ status: UP
        â””â”€â”€ metadata: {"version":"1.0","weight":1}
```

### 2. æœåŠ¡æ³¨å†Œå™¨
```java
public class ServiceRegistry {
    private ZooKeeper zk;
    private String serviceRootPath;
    private String serviceName;
    private String serviceInstance;
    private String instancePath;
    
    public ServiceRegistry(ZooKeeper zk, String serviceRootPath, String serviceName) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
        this.serviceName = serviceName;
        this.serviceInstance = UUID.randomUUID().toString();
        initializeServiceRoot();
    }
    
    // åˆå§‹åŒ–æœåŠ¡æ ¹ç›®å½•
    private void initializeServiceRoot() {
        try {
            if (zk.exists(serviceRootPath, false) == null) {
                zk.create(serviceRootPath, "services-root".getBytes(),
                          ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // æ³¨å†ŒæœåŠ¡
    public void registerService(String host, int port, Map<String, String> metadata) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // ç¡®ä¿æœåŠ¡ç›®å½•å­˜åœ¨
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, "service".getBytes(),
                      ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
        
        // åˆ›å»ºæœåŠ¡å®ä¾‹èŠ‚ç‚¹
        String instancePath = servicePath + "/" + serviceInstance;
        
        // æ„å»ºå®ä¾‹ä¿¡æ¯
        ServiceInstance instance = new ServiceInstance();
        instance.setHost(host);
        instance.setPort(port);
        instance.setStatus("UP");
        instance.setMetadata(metadata);
        instance.setRegisterTime(System.currentTimeMillis());
        
        // åºåˆ—åŒ–å®ä¾‹ä¿¡æ¯
        String instanceData = serializeInstance(instance);
        
        // åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨åˆ é™¤
        this.instancePath = zk.create(instancePath, instanceData.getBytes(),
                                     ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL);
        
        System.out.println("æœåŠ¡æ³¨å†ŒæˆåŠŸ: " + this.instancePath);
        
        // æ³¨å†Œä¼šè¯ç›‘å¬å™¨
        registerSessionWatcher();
    }
    
    // æ³¨é”€æœåŠ¡
    public void unregisterService() throws Exception {
        if (instancePath != null) {
            try {
                zk.delete(instancePath, -1);
                System.out.println("æœåŠ¡æ³¨é”€æˆåŠŸ: " + instancePath);
            } catch (KeeperException.NoNodeException e) {
                // èŠ‚ç‚¹å·²è¢«åˆ é™¤ï¼Œå¿½ç•¥å¼‚å¸¸
            }
        }
    }
    
    // æ›´æ–°æœåŠ¡çŠ¶æ€
    public void updateServiceStatus(String status) throws Exception {
        if (instancePath != null) {
            try {
                // è·å–å½“å‰å®ä¾‹ä¿¡æ¯
                byte[] data = zk.getData(instancePath, false, null);
                ServiceInstance instance = deserializeInstance(new String(data));
                
                // æ›´æ–°çŠ¶æ€
                instance.setStatus(status);
                instance.setUpdateTime(System.currentTimeMillis());
                
                // æ›´æ–°èŠ‚ç‚¹æ•°æ®
                String newData = serializeInstance(instance);
                zk.setData(instancePath, newData.getBytes(), -1);
                
                System.out.println("æœåŠ¡çŠ¶æ€æ›´æ–°æˆåŠŸ: " + status);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    // æ³¨å†Œä¼šè¯ç›‘å¬å™¨
    private void registerSessionWatcher() {
        // ç›‘å¬ä¼šè¯çŠ¶æ€å˜åŒ–
        zk.register(new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getState() == Event.KeeperState.Expired) {
                    System.out.println("ä¼šè¯è¿‡æœŸï¼Œå°è¯•é‡æ–°æ³¨å†ŒæœåŠ¡");
                    try {
                        // é‡æ–°è¿æ¥å¹¶æ³¨å†ŒæœåŠ¡
                        reconnectAndReregister();
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        });
    }
    
    // é‡æ–°è¿æ¥å¹¶é‡æ–°æ³¨å†Œ
    private void reconnectAndReregister() throws Exception {
        // è¿™é‡Œåº”è¯¥å®ç°é‡æ–°è¿æ¥é€»è¾‘
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¯æ‰“å°æ—¥å¿—
        System.out.println("éœ€è¦å®ç°é‡æ–°è¿æ¥é€»è¾‘");
    }
    
    // åºåˆ—åŒ–æœåŠ¡å®ä¾‹
    private String serializeInstance(ServiceInstance instance) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.writeValueAsString(instance);
    }
    
    // ååºåˆ—åŒ–æœåŠ¡å®ä¾‹
    private ServiceInstance deserializeInstance(String data) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(data, ServiceInstance.class);
    }
}

// æœåŠ¡å®ä¾‹ç±»
public class ServiceInstance {
    private String host;
    private int port;
    private String status;
    private Map<String, String> metadata;
    private long registerTime;
    private long updateTime;
    
    // æ„é€ å‡½æ•°ã€getterã€setter...
}
```

### 3. æœåŠ¡å‘ç°å™¨
```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private String serviceRootPath;
    private Map<String, List<ServiceInstance>> serviceCache = new ConcurrentHashMap<>();
    private Map<String, List<ServiceChangeListener>> listeners = new ConcurrentHashMap<>();
    
    public ServiceDiscovery(ZooKeeper zk, String serviceRootPath) {
        this.zk = zk;
        this.serviceRootPath = serviceRootPath;
    }
    
    // å‘ç°æœåŠ¡
    public List<ServiceInstance> discoverService(String serviceName) throws Exception {
        // å…ˆä»ç¼“å­˜è·å–
        List<ServiceInstance> cachedInstances = serviceCache.get(serviceName);
        if (cachedInstances != null) {
            return new ArrayList<>(cachedInstances);
        }
        
        // ä»ZooKeeperè·å–
        List<ServiceInstance> instances = loadServiceInstances(serviceName);
        
        // æ›´æ–°ç¼“å­˜
        serviceCache.put(serviceName, instances);
        
        // æ³¨å†Œç›‘å¬å™¨
        registerServiceWatcher(serviceName);
        
        return instances;
    }
    
    // åŠ è½½æœåŠ¡å®ä¾‹
    private List<ServiceInstance> loadServiceInstances(String serviceName) throws Exception {
        List<ServiceInstance> instances = new ArrayList<>();
        String servicePath = serviceRootPath + "/" + serviceName;
        
        try {
            List<String> instanceNames = zk.getChildren(servicePath, false);
            
            for (String instanceName : instanceNames) {
                try {
                    String instancePath = servicePath + "/" + instanceName;
                    byte[] data = zk.getData(instancePath, false, null);
                    
                    ServiceInstance instance = deserializeInstance(new String(data));
                    instances.add(instance);
                } catch (Exception e) {
                    System.out.println("åŠ è½½æœåŠ¡å®ä¾‹å¤±è´¥: " + instanceName + ", é”™è¯¯: " + e.getMessage());
                }
            }
        } catch (KeeperException.NoNodeException e) {
            // æœåŠ¡ä¸å­˜åœ¨
        }
        
        return instances;
    }
    
    // æ³¨å†ŒæœåŠ¡ç›‘å¬å™¨
    private void registerServiceWatcher(String serviceName) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        
        // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
        zk.getChildren(servicePath, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeChildrenChanged) {
                    try {
                        // é‡æ–°åŠ è½½æœåŠ¡å®ä¾‹
                        List<ServiceInstance> newInstances = loadServiceInstances(serviceName);
                        
                        // æ›´æ–°ç¼“å­˜
                        List<ServiceInstance> oldInstances = serviceCache.get(serviceName);
                        serviceCache.put(serviceName, newInstances);
                        
                        // é€šçŸ¥ç›‘å¬å™¨
                        notifyServiceChange(serviceName, oldInstances, newInstances);
                        
                        // é‡æ–°æ³¨å†Œç›‘å¬å™¨
                        registerServiceWatcher(serviceName);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                }
            }
        }, null);
    }
    
    // æ·»åŠ æœåŠ¡å˜åŒ–ç›‘å¬å™¨
    public void addServiceChangeListener(String serviceName, ServiceChangeListener listener) {
        listeners.computeIfAbsent(serviceName, k -> new ArrayList<>()).add(listener);
    }
    
    // ç§»é™¤æœåŠ¡å˜åŒ–ç›‘å¬å™¨
    public void removeServiceChangeListener(String serviceName, ServiceChangeListener listener) {
        List<ServiceChangeListener> listenerList = listeners.get(serviceName);
        if (listenerList != null) {
            listenerList.remove(listener);
        }
    }
    
    // é€šçŸ¥æœåŠ¡å˜åŒ–
    private void notifyServiceChange(String serviceName, List<ServiceInstance> oldInstances, 
                                   List<ServiceInstance> newInstances) {
        List<ServiceChangeListener> listenerList = listeners.get(serviceName);
        if (listenerList != null) {
            for (ServiceChangeListener listener : listenerList) {
                try {
                    listener.onServiceChange(serviceName, oldInstances, newInstances);
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    // è·å–æ‰€æœ‰æœåŠ¡åç§°
    public List<String> getAllServiceNames() throws Exception {
        try {
            return zk.getChildren(serviceRootPath, false);
        } catch (Exception e) {
            return new ArrayList<>();
        }
    }
    
    // æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
    public boolean isServiceExists(String serviceName) throws Exception {
        String servicePath = serviceRootPath + "/" + serviceName;
        return zk.exists(servicePath, false) != null;
    }
    
    // ååºåˆ—åŒ–æœåŠ¡å®ä¾‹
    private ServiceInstance deserializeInstance(String data) throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(data, ServiceInstance.class);
    }
}

// æœåŠ¡å˜åŒ–ç›‘å¬å™¨æ¥å£
public interface ServiceChangeListener {
    void onServiceChange(String serviceName, List<ServiceInstance> oldInstances, 
                        List<ServiceInstance> newInstances);
}
```

## ğŸš€ é«˜çº§æœåŠ¡å‘ç°åŠŸèƒ½

### 1. è´Ÿè½½å‡è¡¡å™¨
```java
public class LoadBalancer {
    
    // éšæœºè´Ÿè½½å‡è¡¡
    public static ServiceInstance randomLoadBalance(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        Random random = new Random();
        int index = random.nextInt(instances.size());
        return instances.get(index);
    }
    
    // è½®è¯¢è´Ÿè½½å‡è¡¡
    public static class RoundRobinLoadBalancer {
        private AtomicInteger counter = new AtomicInteger(0);
        
        public ServiceInstance next(List<ServiceInstance> instances) {
            if (instances == null || instances.isEmpty()) {
                return null;
            }
            
            int index = counter.getAndIncrement() % instances.size();
            return instances.get(index);
        }
    }
    
    // æƒé‡è´Ÿè½½å‡è¡¡
    public static ServiceInstance weightedLoadBalance(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        // è®¡ç®—æ€»æƒé‡
        int totalWeight = 0;
        for (ServiceInstance instance : instances) {
            String weightStr = instance.getMetadata().get("weight");
            int weight = weightStr != null ? Integer.parseInt(weightStr) : 1;
            totalWeight += weight;
        }
        
        if (totalWeight == 0) {
            return randomLoadBalance(instances);
        }
        
        // éšæœºé€‰æ‹©
        Random random = new Random();
        int randomWeight = random.nextInt(totalWeight);
        
        int currentWeight = 0;
        for (ServiceInstance instance : instances) {
            String weightStr = instance.getMetadata().get("weight");
            int weight = weightStr != null ? Integer.parseInt(weightStr) : 1;
            currentWeight += weight;
            
            if (randomWeight < currentWeight) {
                return instance;
            }
        }
        
        return instances.get(instances.size() - 1);
    }
    
    // å¥åº·æ£€æŸ¥è´Ÿè½½å‡è¡¡
    public static ServiceInstance healthyLoadBalance(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        // è¿‡æ»¤å¥åº·å®ä¾‹
        List<ServiceInstance> healthyInstances = instances.stream()
            .filter(instance -> "UP".equals(instance.getStatus()))
            .collect(Collectors.toList());
        
        if (healthyInstances.isEmpty()) {
            return null;
        }
        
        // ä½¿ç”¨éšæœºè´Ÿè½½å‡è¡¡
        return randomLoadBalance(healthyInstances);
    }
}
```

### 2. æœåŠ¡å¥åº·æ£€æŸ¥
```java
public class HealthChecker {
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(5);
    private Map<String, HealthCheckTask> healthCheckTasks = new ConcurrentHashMap<>();
    
    // å¼€å§‹å¥åº·æ£€æŸ¥
    public void startHealthCheck(String serviceName, String host, int port, 
                                ServiceRegistry serviceRegistry) {
        HealthCheckTask task = new HealthCheckTask(host, port, serviceRegistry);
        healthCheckTasks.put(serviceName, task);
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
        scheduler.scheduleAtFixedRate(task, 0, 30, TimeUnit.SECONDS);
    }
    
    // åœæ­¢å¥åº·æ£€æŸ¥
    public void stopHealthCheck(String serviceName) {
        HealthCheckTask task = healthCheckTasks.remove(serviceName);
        if (task != null) {
            task.stop();
        }
    }
    
    // å¥åº·æ£€æŸ¥ä»»åŠ¡
    private static class HealthCheckTask implements Runnable {
        private String host;
        private int port;
        private ServiceRegistry serviceRegistry;
        private volatile boolean running = true;
        
        public HealthCheckTask(String host, int port, ServiceRegistry serviceRegistry) {
            this.host = host;
            this.port = port;
            this.serviceRegistry = serviceRegistry;
        }
        
        @Override
        public void run() {
            if (!running) {
                return;
            }
            
            try {
                // æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
                boolean isHealthy = checkHealth(host, port);
                
                if (isHealthy) {
                    serviceRegistry.updateServiceStatus("UP");
                } else {
                    serviceRegistry.updateServiceStatus("DOWN");
                }
            } catch (Exception e) {
                System.out.println("å¥åº·æ£€æŸ¥å¤±è´¥: " + e.getMessage());
                try {
                    serviceRegistry.updateServiceStatus("DOWN");
                } catch (Exception ex) {
                    ex.printStackTrace();
                }
            }
        }
        
        private boolean checkHealth(String host, int port) {
            try (Socket socket = new Socket()) {
                socket.connect(new InetSocketAddress(host, port), 5000);
                return true;
            } catch (Exception e) {
                return false;
            }
        }
        
        public void stop() {
            running = false;
        }
    }
    
    // å…³é—­å¥åº·æ£€æŸ¥å™¨
    public void shutdown() {
        scheduler.shutdown();
        try {
            if (!scheduler.awaitTermination(60, TimeUnit.SECONDS)) {
                scheduler.shutdownNow();
            }
        } catch (InterruptedException e) {
            scheduler.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

### 3. æœåŠ¡è·¯ç”±
```java
public class ServiceRouter {
    private ServiceDiscovery serviceDiscovery;
    private LoadBalancer loadBalancer;
    
    public ServiceRouter(ServiceDiscovery serviceDiscovery) {
        this.serviceDiscovery = serviceDiscovery;
        this.loadBalancer = new LoadBalancer.RoundRobinLoadBalancer();
    }
    
    // è·¯ç”±åˆ°æœåŠ¡å®ä¾‹
    public ServiceInstance routeToService(String serviceName) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            throw new RuntimeException("æœåŠ¡ä¸å¯ç”¨: " + serviceName);
        }
        
        // ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹
        return loadBalancer.next(instances);
    }
    
    // è·¯ç”±åˆ°æŒ‡å®šç‰ˆæœ¬çš„æœåŠ¡
    public ServiceInstance routeToServiceVersion(String serviceName, String version) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            throw new RuntimeException("æœåŠ¡ä¸å¯ç”¨: " + serviceName);
        }
        
        // è¿‡æ»¤æŒ‡å®šç‰ˆæœ¬çš„å®ä¾‹
        List<ServiceInstance> versionInstances = instances.stream()
            .filter(instance -> version.equals(instance.getMetadata().get("version")))
            .collect(Collectors.toList());
        
        if (versionInstances.isEmpty()) {
            throw new RuntimeException("æŒ‡å®šç‰ˆæœ¬çš„æœåŠ¡ä¸å¯ç”¨: " + serviceName + ":" + version);
        }
        
        return loadBalancer.next(versionInstances);
    }
    
    // è·¯ç”±åˆ°æŒ‡å®šåŒºåŸŸçš„å®ä¾‹
    public ServiceInstance routeToServiceRegion(String serviceName, String region) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        if (instances == null || instances.isEmpty()) {
            throw new RuntimeException("æœåŠ¡ä¸å¯ç”¨: " + serviceName);
        }
        
        // è¿‡æ»¤æŒ‡å®šåŒºåŸŸçš„å®ä¾‹
        List<ServiceInstance> regionInstances = instances.stream()
            .filter(instance -> region.equals(instance.getMetadata().get("region")))
            .collect(Collectors.toList());
        
        if (regionInstances.isEmpty()) {
            // å¦‚æœæŒ‡å®šåŒºåŸŸæ²¡æœ‰å®ä¾‹ï¼Œè¿”å›ä»»æ„å®ä¾‹
            return loadBalancer.next(instances);
        }
        
        return loadBalancer.next(regionInstances);
    }
}
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### 1. æœåŠ¡æ³¨å†Œç¤ºä¾‹
```java
public class ServiceRegistrationExample {
    public static void main(String[] args) {
        try {
            ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, null);
            
            // åˆ›å»ºæœåŠ¡æ³¨å†Œå™¨
            ServiceRegistry registry = new ServiceRegistry(zk, "/services", "user-service");
            
            // æ³¨å†ŒæœåŠ¡
            Map<String, String> metadata = new HashMap<>();
            metadata.put("version", "1.0");
            metadata.put("weight", "1");
            metadata.put("region", "us-east-1");
            
            registry.registerService("192.168.1.100", 8080, metadata);
            
            // å¯åŠ¨å¥åº·æ£€æŸ¥
            HealthChecker healthChecker = new HealthChecker();
            healthChecker.startHealthCheck("user-service", "192.168.1.100", 8080, registry);
            
            // ä¿æŒæœåŠ¡è¿è¡Œ
            Thread.sleep(60000); // è¿è¡Œ1åˆ†é’Ÿ
            
            // åœæ­¢å¥åº·æ£€æŸ¥
            healthChecker.stopHealthCheck("user-service");
            healthChecker.shutdown();
            
            // æ³¨é”€æœåŠ¡
            registry.unregisterService();
            
            zk.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 2. æœåŠ¡å‘ç°ç¤ºä¾‹
```java
public class ServiceDiscoveryExample {
    public static void main(String[] args) {
        try {
            ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, null);
            
            // åˆ›å»ºæœåŠ¡å‘ç°å™¨
            ServiceDiscovery discovery = new ServiceDiscovery(zk, "/services");
            
            // æ·»åŠ æœåŠ¡å˜åŒ–ç›‘å¬å™¨
            discovery.addServiceChangeListener("user-service", new ServiceChangeListener() {
                @Override
                public void onServiceChange(String serviceName, List<ServiceInstance> oldInstances, 
                                         List<ServiceInstance> newInstances) {
                    System.out.println("æœåŠ¡å˜åŒ–é€šçŸ¥:");
                    System.out.println("æœåŠ¡åç§°: " + serviceName);
                    System.out.println("æ—§å®ä¾‹æ•°é‡: " + (oldInstances != null ? oldInstances.size() : 0));
                    System.out.println("æ–°å®ä¾‹æ•°é‡: " + (newInstances != null ? newInstances.size() : 0));
                }
            });
            
            // å‘ç°æœåŠ¡
            List<ServiceInstance> instances = discovery.discoverService("user-service");
            System.out.println("å‘ç°æœåŠ¡å®ä¾‹æ•°é‡: " + instances.size());
            
            for (ServiceInstance instance : instances) {
                System.out.println("å®ä¾‹: " + instance.getHost() + ":" + instance.getPort());
                System.out.println("çŠ¶æ€: " + instance.getStatus());
                System.out.println("å…ƒæ•°æ®: " + instance.getMetadata());
            }
            
            // ä½¿ç”¨è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹
            ServiceInstance selectedInstance = LoadBalancer.randomLoadBalance(instances);
            if (selectedInstance != null) {
                System.out.println("é€‰æ‹©çš„å®ä¾‹: " + selectedInstance.getHost() + ":" + selectedInstance.getPort());
            }
            
            Thread.sleep(30000); // ç­‰å¾…30ç§’è§‚å¯ŸæœåŠ¡å˜åŒ–
            
            zk.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 3. å®Œæ•´æœåŠ¡è°ƒç”¨ç¤ºä¾‹
```java
public class ServiceCallExample {
    public static void main(String[] args) {
        try {
            ZooKeeper zk = new ZooKeeper("localhost:2181", 5000, null);
            
            // åˆ›å»ºæœåŠ¡å‘ç°å™¨å’Œè·¯ç”±å™¨
            ServiceDiscovery discovery = new ServiceDiscovery(zk, "/services");
            ServiceRouter router = new ServiceRouter(discovery);
            
            // æ¨¡æ‹ŸæœåŠ¡è°ƒç”¨
            for (int i = 0; i < 5; i++) {
                try {
                    // è·¯ç”±åˆ°æœåŠ¡å®ä¾‹
                    ServiceInstance instance = router.routeToService("user-service");
                    
                    System.out.println("ç¬¬" + (i + 1) + "æ¬¡è°ƒç”¨:");
                    System.out.println("  ç›®æ ‡å®ä¾‹: " + instance.getHost() + ":" + instance.getPort());
                    System.out.println("  å®ä¾‹çŠ¶æ€: " + instance.getStatus());
                    
                    // æ¨¡æ‹ŸHTTPè°ƒç”¨
                    String response = callService(instance);
                    System.out.println("  å“åº”ç»“æœ: " + response);
                    
                } catch (Exception e) {
                    System.out.println("ç¬¬" + (i + 1) + "æ¬¡è°ƒç”¨å¤±è´¥: " + e.getMessage());
                }
                
                Thread.sleep(2000); // ç­‰å¾…2ç§’
            }
            
            zk.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // æ¨¡æ‹ŸæœåŠ¡è°ƒç”¨
    private static String callService(ServiceInstance instance) {
        // è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„HTTPè°ƒç”¨
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªæ˜¯è¿”å›æ¨¡æ‹Ÿå“åº”
        return "Hello from " + instance.getHost() + ":" + instance.getPort();
    }
}
```

## ğŸ”§ æœåŠ¡å‘ç°ç®¡ç†å·¥å…·

### 1. æœåŠ¡ç›‘æ§
```java
public class ServiceMonitor {
    private ServiceDiscovery serviceDiscovery;
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    
    public ServiceMonitor(ServiceDiscovery serviceDiscovery) {
        this.serviceDiscovery = serviceDiscovery;
    }
    
    // å¼€å§‹ç›‘æ§
    public void startMonitoring() {
        scheduler.scheduleAtFixedRate(this::monitorServices, 0, 60, TimeUnit.SECONDS);
    }
    
    // ç›‘æ§æœåŠ¡
    private void monitorServices() {
        try {
            List<String> serviceNames = serviceDiscovery.getAllServiceNames();
            
            System.out.println("=== æœåŠ¡ç›‘æ§æŠ¥å‘Š ===");
            System.out.println("æ—¶é—´: " + new Date());
            System.out.println("æ€»æœåŠ¡æ•°: " + serviceNames.size());
            
            for (String serviceName : serviceNames) {
                List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
                
                long upCount = instances.stream()
                    .filter(instance -> "UP".equals(instance.getStatus()))
                    .count();
                
                long downCount = instances.size() - upCount;
                
                System.out.println("æœåŠ¡: " + serviceName);
                System.out.println("  æ€»å®ä¾‹æ•°: " + instances.size());
                System.out.println("  å¥åº·å®ä¾‹æ•°: " + upCount);
                System.out.println("  å¼‚å¸¸å®ä¾‹æ•°: " + downCount);
                System.out.println("  å¯ç”¨æ€§: " + (instances.size() > 0 ? (upCount * 100 / instances.size()) + "%" : "0%"));
            }
            
            System.out.println("==================");
            
        } catch (Exception e) {
            System.out.println("ç›‘æ§å¤±è´¥: " + e.getMessage());
        }
    }
    
    // åœæ­¢ç›‘æ§
    public void stopMonitoring() {
        scheduler.shutdown();
    }
}
```

### 2. æœåŠ¡ç»Ÿè®¡
```java
public class ServiceStatistics {
    private ServiceDiscovery serviceDiscovery;
    private Map<String, ServiceStats> serviceStats = new ConcurrentHashMap<>();
    
    // è·å–æœåŠ¡ç»Ÿè®¡ä¿¡æ¯
    public ServiceStats getServiceStats(String serviceName) throws Exception {
        List<ServiceInstance> instances = serviceDiscovery.discoverService(serviceName);
        
        ServiceStats stats = new ServiceStats();
        stats.setServiceName(serviceName);
        stats.setTotalInstances(instances.size());
        stats.setHealthyInstances((int) instances.stream()
            .filter(instance -> "UP".equals(instance.getStatus()))
            .count());
        stats.setUnhealthyInstances((int) instances.stream()
            .filter(instance -> "DOWN".equals(instance.getStatus()))
            .count());
        
        // è®¡ç®—å¹³å‡å“åº”æ—¶é—´ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        double avgResponseTime = instances.stream()
            .mapToDouble(instance -> {
                String responseTime = instance.getMetadata().get("responseTime");
                return responseTime != null ? Double.parseDouble(responseTime) : 0.0;
            })
            .average()
            .orElse(0.0);
        
        stats.setAverageResponseTime(avgResponseTime);
        
        return stats;
    }
    
    // è·å–æ‰€æœ‰æœåŠ¡ç»Ÿè®¡
    public Map<String, ServiceStats> getAllServiceStats() throws Exception {
        List<String> serviceNames = serviceDiscovery.getAllServiceNames();
        Map<String, ServiceStats> allStats = new HashMap<>();
        
        for (String serviceName : serviceNames) {
            allStats.put(serviceName, getServiceStats(serviceName));
        }
        
        return allStats;
    }
}

// æœåŠ¡ç»Ÿè®¡ä¿¡æ¯ç±»
public class ServiceStats {
    private String serviceName;
    private int totalInstances;
    private int healthyInstances;
    private int unhealthyInstances;
    private double averageResponseTime;
    
    // æ„é€ å‡½æ•°ã€getterã€setter...
}
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æœåŠ¡æ³¨å†Œ
- **ä¸´æ—¶èŠ‚ç‚¹**ï¼šä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹ç¡®ä¿æœåŠ¡ä¸‹çº¿æ—¶è‡ªåŠ¨æ¸…ç†
- **å¿ƒè·³æœºåˆ¶**ï¼šå®ç°å¥åº·æ£€æŸ¥ä¿æŒæœåŠ¡çŠ¶æ€æ›´æ–°
- **é‡è¿æœºåˆ¶**ï¼šZooKeeperè¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿å¹¶é‡æ–°æ³¨å†Œ

### 2. æœåŠ¡å‘ç°
- **ç¼“å­˜æœºåˆ¶**ï¼šæœ¬åœ°ç¼“å­˜å‡å°‘ZooKeeperè®¿é—®
- **ç›‘å¬å™¨ç®¡ç†**ï¼šåŠæ—¶é‡æ–°æ³¨å†Œç›‘å¬å™¨
- **å¼‚å¸¸å¤„ç†**ï¼šå¤„ç†æœåŠ¡ä¸å¯ç”¨çš„æƒ…å†µ

### 3. è´Ÿè½½å‡è¡¡
- **å¥åº·æ£€æŸ¥**ï¼šåªè·¯ç”±åˆ°å¥åº·çš„æœåŠ¡å®ä¾‹
- **æƒé‡é…ç½®**ï¼šæ”¯æŒå®ä¾‹æƒé‡é…ç½®
- **æ•…éšœè½¬ç§»**ï¼šä¸»å®ä¾‹ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨å®ä¾‹

### 4. æ€§èƒ½ä¼˜åŒ–
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡è·å–æœåŠ¡ä¿¡æ¯
- **å¼‚æ­¥å¤„ç†**ï¼šå¼‚æ­¥å¤„ç†æœåŠ¡å˜åŒ–é€šçŸ¥
- **è¿æ¥æ± **ï¼šå¤ç”¨ZooKeeperè¿æ¥

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [é¢è¯•é¢˜é›†é”¦](./10.é¢è¯•é¢˜é›†é”¦.md) - å‡†å¤‡é¢è¯•
- [å®æˆ˜é¡¹ç›®](./11.å®æˆ˜é¡¹ç›®.md) - å®Œæ•´é¡¹ç›®å®è·µ

---

**è®°ä½ï¼šæœåŠ¡å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„çš„åŸºç¡€ï¼ŒæŒæ¡å®ƒå°±èƒ½å®ç°æœåŠ¡çš„åŠ¨æ€å‘ç°å’Œè·¯ç”±ï¼** ğŸ¯
