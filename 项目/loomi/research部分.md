æˆ‘æ¥è¯¦ç»†åˆ†æprod/blueplan-researchç³»ç»Ÿï¼Œä¸ºæ‚¨æä¾›é’ˆå¯¹Agentå¼€å‘å²—ä½çš„è¯¦ç»†é¡¹ç›®æè¿°ã€‚

Read file: prod/blueplan-research/BLUEPLAN_ARCHITECTURE_ANALYSIS.md
Read file: prod/blueplan-research/agents/nova3/supervisor.py
Read file: prod/blueplan-research/agents/nova3/supervisor.py
Read file: prod/blueplan-research/agents/nova3/insight_agent.py
Read file: prod/blueplan-research/utils/layered_queue_manager.py
Read file: prod/blueplan-research/agents/nova3/xhs_writing_agent.py
Read file: prod/blueplan-research/agents/nova3/base_nova3_agent.py
åŸºäºå¯¹prod/blueplan-researchç³»ç»Ÿçš„æ·±å…¥åˆ†æï¼Œæˆ‘ä¸ºæ‚¨æä¾›é’ˆå¯¹Agentå¼€å‘å²—ä½çš„è¯¦ç»†é¡¹ç›®æè¿°ï¼š

## ğŸ¤– **BluePlan Research - å¤šAgentåä½œå†…å®¹åˆ›ä½œç³»ç»Ÿ**

### **é¡¹ç›®æ¦‚è¿°**
BluePlan Researchæ˜¯ä¸€ä¸ªåŸºäºå¤šAgentåä½œæ¶æ„çš„æ™ºèƒ½å†…å®¹åˆ›ä½œå¹³å°ï¼Œä¸“é—¨ä¸ºç¤¾äº¤åª’ä½“å†…å®¹åˆ›ä½œè®¾è®¡ã€‚ç³»ç»Ÿé‡‡ç”¨Nova3Supervisorä¸»æ§åˆ¶å™¨æ¨¡å¼ï¼Œåè°ƒ7ä¸ªä¸“ä¸šAgentå®Œæˆä»æ´å¯Ÿåˆ†æåˆ°å†…å®¹åˆ›ä½œçš„å…¨æµç¨‹ä»»åŠ¡ã€‚

---

## ï¿½ï¿½ï¸ **æ ¸å¿ƒAgentæ¶æ„è®¾è®¡**

### **1. Nova3Supervisorä¸»æ§åˆ¶å™¨**
**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ä»»åŠ¡è§£æä¸æ‰§è¡Œè®¡åˆ’ç”Ÿæˆ
- å¤šAgentåä½œè°ƒåº¦
- çŠ¶æ€æŒä¹…åŒ–ä¸æ¢å¤
- æµå¼å“åº”ç®¡ç†

**æŠ€æœ¯å®ç°ï¼š**
```python
class Nova3Supervisor(BaseAgent):
    def __init__(self):
        # ä¸‰å±‚é˜Ÿåˆ—ç®¡ç†å™¨ï¼šå†…å­˜ -> Redis -> æ–‡ä»¶
        self.layered_queue_manager = LayeredQueueManager()
        # è½®æ¬¡ç»“æœç®¡ç†å™¨
        self.round_results_manager = RoundResultsManager()
        # LangSmithè¿½è¸ªé›†æˆ
        self.llm_client = get_langsmith_llm_client()
```

**æŠ€æœ¯éš¾ç‚¹ï¼š**
- **ä¸‰å±‚å­˜å‚¨æ¶æ„ï¼š** å†…å­˜ç¼“å­˜(50é˜Ÿåˆ—) â†’ Redisç¼“å­˜(24å°æ—¶TTL) â†’ æ–‡ä»¶æŒä¹…åŒ–
- **å¹¶å‘å®‰å…¨ï¼š** ä½¿ç”¨çº¿ç¨‹é”å’Œå¼‚æ­¥æ“ä½œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **æ•…éšœæ¢å¤ï¼š** æ”¯æŒä»ä»»æ„å­˜å‚¨å±‚æ¢å¤ä»»åŠ¡çŠ¶æ€

---

### **2. ä¸“ä¸šAgentè®¾è®¡æ¨¡å¼**

**Agentå±‚æ¬¡ç»“æ„ï¼š**
```
Nova3BaseAgent (åŸºç±»)
â”œâ”€â”€ InsightAgent (æ´å¯Ÿåˆ†æ)
â”œâ”€â”€ ProfileAgent (å—ä¼—ç”»åƒ)  
â”œâ”€â”€ HitpointAgent (å†…å®¹æ‰“ç‚¹)
â”œâ”€â”€ FactsAgent (äº‹å®æ”¶é›†)
â”œâ”€â”€ XHSWritingAgent (å°çº¢ä¹¦åˆ›ä½œ)
â”œâ”€â”€ TiktokScriptAgent (æŠ–éŸ³å£æ’­ç¨¿)
â””â”€â”€ WechatArticleAgent (å…¬ä¼—å·æ–‡ç« )
```

**åŸºç±»è®¾è®¡ç‰¹ç‚¹ï¼š**
```python
class Nova3BaseAgent(BaseAgent):
    async def call_llm_with_tracing(self, messages, parent_run_id=None):
        # LangSmithåˆ†å¸ƒå¼è¿½è¸ª
        # æ”¯æŒçˆ¶å­run_idå…³è”
        # Tokenä½¿ç”¨é‡ä¼°ç®—
        # é”™è¯¯å¤„ç†å’Œæ¢å¤
```

**æŠ€æœ¯éš¾ç‚¹ï¼š**
- **åˆ†å¸ƒå¼è¿½è¸ªï¼š** æ¯ä¸ªAgentè°ƒç”¨éƒ½æœ‰ç‹¬ç«‹çš„LangSmith run_idï¼Œæ”¯æŒé“¾è·¯è¿½è¸ª
- **å¹¶å‘å¤„ç†ï¼š** æ”¯æŒå•ä¸ªAgentå†…éƒ¨å¹¶å‘å¤„ç†å¤šä¸ªprofile/hitpoint
- **çŠ¶æ€ä¼ é€’ï¼š** Agenté—´é€šè¿‡contextä¼ é€’æ‰§è¡ŒçŠ¶æ€å’Œä¸­é—´ç»“æœ

---

### **3. ä¸‰å±‚é˜Ÿåˆ—ç®¡ç†ç³»ç»Ÿ**

**å­˜å‚¨æ¶æ„ï¼š**
```python
class LayeredQueueManager:
    def __init__(self):
        # L1: å†…å­˜ç¼“å­˜ (50é˜Ÿåˆ—, 1å°æ—¶TTL)
        self.memory_cache = {}
        # L2: Redisç¼“å­˜ (24å°æ—¶TTL)
        self.redis_client = aioredis.from_url()
        # L3: æ–‡ä»¶æŒä¹…åŒ–
        self.persist_dir = Path("data/nova3_queues")
```

**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š**
- **LRUç¼“å­˜ï¼š** å†…å­˜å±‚è‡ªåŠ¨æ¸…ç†è¿‡æœŸå’Œæœ€å°‘ä½¿ç”¨çš„é˜Ÿåˆ—
- **è¿æ¥æ± ï¼š** Redisæ”¯æŒ50ä¸ªå¹¶å‘è¿æ¥
- **å¼‚æ­¥æ“ä½œï¼š** æ‰€æœ‰å­˜å‚¨æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹

**æŠ€æœ¯éš¾ç‚¹ï¼š**
- **æ•°æ®ä¸€è‡´æ€§ï¼š** ä¸‰å±‚å­˜å‚¨çš„æ•°æ®åŒæ­¥å’Œä¸€è‡´æ€§ä¿è¯
- **æ•…éšœé™çº§ï¼š** Redisä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°æ–‡ä»¶å­˜å‚¨
- **æ€§èƒ½ç›‘æ§ï¼š** å®æ—¶ç»Ÿè®¡å„å±‚å­˜å‚¨çš„å‘½ä¸­ç‡å’Œæ€§èƒ½æŒ‡æ ‡

---

### **4. å¹¶å‘å¤„ç†ä¸ä»»åŠ¡è°ƒåº¦**

**å¹¶å‘æ¶æ„ï¼š**
```python
# å¤šprofileå¹¶å‘å¤„ç†
async def process_multiple_profiles(self, profiles):
    concurrent_tasks = []
    for profile in profiles:
        task = self._collect_single_profile_results(profile)
        concurrent_tasks.append(task)
    
    # çœŸæ­£çš„å¹¶å‘æ‰§è¡Œ
    results = await asyncio.gather(*concurrent_tasks, return_exceptions=True)
```

**ä»»åŠ¡è°ƒåº¦ç­–ç•¥ï¼š**
- **ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š** æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§è®¾ç½®
- **ä¾èµ–ç®¡ç†ï¼š** Agenté—´ä»»åŠ¡ä¾èµ–å…³ç³»å¤„ç†
- **è´Ÿè½½å‡è¡¡ï¼š** è‡ªåŠ¨åˆ†é…ä»»åŠ¡åˆ°å¯ç”¨Agent

**æŠ€æœ¯éš¾ç‚¹ï¼š**
- **èµ„æºç®¡ç†ï¼š** æ§åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å…èµ„æºè€—å°½
- **é”™è¯¯éš”ç¦»ï¼š** å•ä¸ªä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
- **ç»“æœèšåˆï¼š** å¹¶å‘ä»»åŠ¡ç»“æœçš„ç»Ÿä¸€æ”¶é›†å’Œæ ¼å¼åŒ–

---

### **5. æµå¼å“åº”ä¸å®æ—¶äº¤äº’**

**æµå¼æ¶æ„ï¼š**
```python
async def stream_agent_execution(self, agent, input_data):
    async for chunk in agent.stream_execute(input_data):
        yield StreamEvent(
            event_type=EventType.LLM_CHUNK,
            content_type=ContentType.NOVA3_INSIGHT,
            data=chunk,
            metadata={"agent": agent.name}
        )
```

**å®æ—¶ç‰¹æ€§ï¼š**
- **SSEæ”¯æŒï¼š** Server-Sent Eventså®æ—¶æ•°æ®æ¨é€
- **è¿›åº¦åé¦ˆï¼š** å®æ—¶æ˜¾ç¤ºAgentæ‰§è¡Œè¿›åº¦
- **ä¸­æ–­å¤„ç†ï¼š** æ”¯æŒç”¨æˆ·ä¸­æ–­é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡

**æŠ€æœ¯éš¾ç‚¹ï¼š**
- **è¿æ¥ç®¡ç†ï¼š** é•¿æ—¶é—´è¿æ¥çš„çŠ¶æ€ç»´æŠ¤
- **å†…å­˜ä¼˜åŒ–ï¼š** æµå¼å¤„ç†ä¸­çš„å†…å­˜ä½¿ç”¨æ§åˆ¶
- **é”™è¯¯æ¢å¤ï¼š** è¿æ¥ä¸­æ–­æ—¶çš„çŠ¶æ€æ¢å¤

---

### **6. LangSmithåˆ†å¸ƒå¼è¿½è¸ª**

**è¿½è¸ªæ¶æ„ï¼š**
```python
# ä¸»é“¾è·¯è¿½è¸ª
master_run_id = langsmith_client.create_run(
    name="nova3_master_flow",
    run_type="chain",
    inputs={"user_query": query}
)

# Agentçº§è¿½è¸ª
agent_run_id = langsmith_client.create_run(
    parent_run_id=master_run_id,
    name=f"{agent_name}_execution",
    run_type="tool"
)

# LLMè°ƒç”¨è¿½è¸ª
llm_run_id = langsmith_client.create_run(
    parent_run_id=agent_run_id,
    name="llm_call",
    run_type="llm"
)
```

**è¿½è¸ªåŠŸèƒ½ï¼š**
- **é“¾è·¯è¿½è¸ªï¼š** å®Œæ•´çš„æ‰§è¡Œé“¾è·¯å¯è§†åŒ–
- **æ€§èƒ½ç›‘æ§ï¼š** Tokenä½¿ç”¨é‡ã€å“åº”æ—¶é—´ç»Ÿè®¡
- **é”™è¯¯å®šä½ï¼š** ç²¾ç¡®åˆ°Agentå’ŒLLMè°ƒç”¨çš„é”™è¯¯å®šä½

**æŠ€æœ¯éš¾ç‚¹ï¼š**
- **å±‚çº§å…³ç³»ï¼š** ç»´æŠ¤å¤æ‚çš„çˆ¶å­run_idå…³ç³»
- **å…ƒæ•°æ®ç®¡ç†ï¼š** ä¸°å¯Œçš„æ‰§è¡Œå…ƒæ•°æ®æ”¶é›†
- **æ€§èƒ½å½±å“ï¼š** è¿½è¸ªå¯¹ç³»ç»Ÿæ€§èƒ½çš„æœ€å°åŒ–å½±å“

---

## ğŸ”§ **Agentå¼€å‘æ ¸å¿ƒæŠ€æœ¯æŒ‘æˆ˜**

### **1. çŠ¶æ€ç®¡ç†å¤æ‚æ€§**
- **å¤šAgentçŠ¶æ€åŒæ­¥ï¼š** 7ä¸ªAgenté—´çš„çŠ¶æ€ä¼ é€’å’ŒåŒæ­¥
- **æŒä¹…åŒ–ç­–ç•¥ï¼š** ä¸‰å±‚å­˜å‚¨çš„çŠ¶æ€ä¸€è‡´æ€§ä¿è¯
- **å¹¶å‘å®‰å…¨ï¼š** å¤šç”¨æˆ·å¹¶å‘è®¿é—®æ—¶çš„çŠ¶æ€éš”ç¦»

### **2. ä»»åŠ¡è°ƒåº¦ä¼˜åŒ–**
- **ä¾èµ–å…³ç³»å¤„ç†ï¼š** Agenté—´ä»»åŠ¡ä¾èµ–çš„è‡ªåŠ¨è§£æ
- **èµ„æºåˆ†é…ï¼š** æ™ºèƒ½åˆ†é…è®¡ç®—èµ„æºç»™ä¸åŒAgent
- **è´Ÿè½½å‡è¡¡ï¼š** åŠ¨æ€è°ƒæ•´Agentè´Ÿè½½ï¼Œé¿å…ç“¶é¢ˆ

### **3. é”™è¯¯å¤„ç†ä¸æ¢å¤**
- **æ•…éšœéš”ç¦»ï¼š** å•ä¸ªAgentæ•…éšœä¸å½±å“æ•´ä½“æµç¨‹
- **è‡ªåŠ¨é‡è¯•ï¼š** æ™ºèƒ½é‡è¯•æœºåˆ¶å’Œé™çº§ç­–ç•¥
- **çŠ¶æ€æ¢å¤ï¼š** ä»ä»»æ„æ•…éšœç‚¹æ¢å¤æ‰§è¡ŒçŠ¶æ€

### **4. æ€§èƒ½ä¼˜åŒ–**
- **å¹¶å‘æ§åˆ¶ï¼š** åˆç†çš„å¹¶å‘æ•°é‡æ§åˆ¶
- **ç¼“å­˜ç­–ç•¥ï¼š** å¤šå±‚ç¼“å­˜çš„æœ‰æ•ˆåˆ©ç”¨
- **èµ„æºç›‘æ§ï¼š** å®æ—¶ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

### **5. å¯è§‚æµ‹æ€§è®¾è®¡**
- **åˆ†å¸ƒå¼è¿½è¸ªï¼š** å®Œæ•´çš„æ‰§è¡Œé“¾è·¯è¿½è¸ª
- **æ€§èƒ½æŒ‡æ ‡ï¼š** è¯¦ç»†çš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- **æ—¥å¿—ç®¡ç†ï¼š** ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•å’Œåˆ†æ

è¿™ä¸ªç³»ç»Ÿå±•ç°äº†ç°ä»£Agentå¼€å‘çš„æ ¸å¿ƒæŠ€æœ¯ï¼šå¤šAgentåä½œã€åˆ†å¸ƒå¼çŠ¶æ€ç®¡ç†ã€å¹¶å‘å¤„ç†ã€æµå¼å“åº”ã€åˆ†å¸ƒå¼è¿½è¸ªç­‰ï¼Œæ˜¯Agentå¼€å‘é¢†åŸŸçš„å…¸å‹å®è·µæ¡ˆä¾‹ã€‚
