### 可观测性与检查点策略

#### 可观测性对比
- dev：
  - 采用 Langfuse（`requirements.txt` 与日志“Langfuse追踪已启用”）；
  - `apis/graph_routes_v2.py` 在每次图执行创建/结束会话级 trace（`get_traced_llm_client().create_session_trace/end_session_trace`）。
- prod：
  - 使用 LangSmith（`utils/langsmith_llm_client*.py`、日志/数据中的 `langsmith_run_id` 等）。

权衡：Langfuse 自托管/开源，便于与内部平台整合；LangSmith 功能成熟但闭源依赖重。

#### 检查点策略对比
- dev：
  - Memory/Redis 两种 checkpointer：`MemorySaver` 与自研 `AsyncRedisSaver`；
  - Redis 侧实现了 `put/put_writes/get_tuple/list/adelete_thread` 与 SCAN 避免 KEYS 扫描；
  - `thread_id=user_id:session_id` 统一关联会话，支持中断/恢复；
  - SSE 流中合并历史 `messages`，可在恢复后继续累积状态。
- prod：
  - 以队列/文件/自研结构组合实现会话/阶段数据落盘（如 `data/nova3_queues/**`），无 LangGraph Checkpointer 协议；
  - 支持追踪与状态，但编排恢复语义由业务代码自行维护。

#### 风险与缓解
- Redis 数据增长与 TTL：dev 在保存键上设置 `settings.memory.checkpoint_ttl`，需配合监控与定期清理；
- trace 一致性：确保 `/chat` 与 `/graph_v2/chat/stream` 的会话追踪结构一致，便于统一分析；
- 人审链路：中断后用户反馈需要正确拼接到 `messages`，避免丢上下文。


