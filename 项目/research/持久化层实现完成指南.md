# æŒä¹…åŒ–å±‚å®ç°å®ŒæˆæŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†åŸºäº Supabase PostgreSQL çš„å®Œæ•´æŒä¹…åŒ–å±‚ï¼Œä¸º BluePlan Research é¡¹ç›®æä¾›æ•°æ®æŒä¹…åŒ–èƒ½åŠ›ã€‚æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆå¹¶å¯ç«‹å³ä½¿ç”¨ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒç»„ä»¶å®ç°

#### æ•°æ®åº“å®¢æˆ·ç«¯ç®¡ç†
- **æ–‡ä»¶**: `utils/database/client.py`
- **åŠŸèƒ½**: Supabaseå®¢æˆ·ç«¯å•ä¾‹ç®¡ç†ã€è¿æ¥æµ‹è¯•
- **çŠ¶æ€**: âœ… å®Œæˆ

#### é”™è¯¯å¤„ç†å·¥å…·
- **æ–‡ä»¶**: `utils/database/error_handler.py`
- **åŠŸèƒ½**: ç»Ÿä¸€é”™è¯¯å¤„ç†ã€é‡è¯•æœºåˆ¶ã€æŒ‡æ•°é€€é¿
- **çŠ¶æ€**: âœ… å®Œæˆ

#### æ¶ˆæ¯å­˜å‚¨æœåŠ¡ (ChatStorage)
- **æ–‡ä»¶**: `utils/database/chat_storage.py`
- **åŠŸèƒ½**: 
  - å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯ã€AIå›å¤ã€ç³»ç»Ÿæ¶ˆæ¯
  - æ”¯æŒå¤æ‚çš„function_toolsæ•°æ®æ ¼å¼
  - æ‰¹é‡å­˜å‚¨å¯¹è¯è½®æ¬¡
  - è·å–å¯¹è¯å†å²å’Œæœ€è¿‘æ¶ˆæ¯
- **çŠ¶æ€**: âœ… å®Œæˆ

#### ä¸Šä¸‹æ–‡å­˜å‚¨æœåŠ¡ (ContextStorage)
- **æ–‡ä»¶**: `utils/database/context_storage.py`
- **åŠŸèƒ½**:
  - æ”¯æŒä¸åŒAgentçš„ä¸Šä¸‹æ–‡æ•°æ®å­˜å‚¨
  - é€šè¿‡actionå­—æ®µåŒºåˆ†ä¸åŒç±»å‹ä¸Šä¸‹æ–‡
  - CRUDæ“ä½œå’Œæ·±åº¦å­—æ®µæ›´æ–°
  - ä¸Šä¸‹æ–‡æ‘˜è¦ç»Ÿè®¡
- **çŠ¶æ€**: âœ… å®Œæˆ

#### Noteså­˜å‚¨æœåŠ¡ (NotesStorage)
- **æ–‡ä»¶**: `utils/database/notes_storage.py`
- **åŠŸèƒ½**:
  - AIç”Ÿæˆçš„åˆ†æç»“æœå­˜å‚¨
  - æ”¯æŒé€‰æ‹©çŠ¶æ€ç®¡ç†
  - æ‰¹é‡æ›´æ–°æ“ä½œ
  - Notesæ‘˜è¦å’Œç»Ÿè®¡
- **çŠ¶æ€**: âœ… å®Œæˆ

#### æŒä¹…åŒ–ç®¡ç†å™¨ (PersistenceManager)
- **æ–‡ä»¶**: `utils/database/persistence_manager.py`
- **åŠŸèƒ½**:
  - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å­˜å‚¨æœåŠ¡
  - æä¾›ç®€åŒ–çš„APIæ¥å£
  - å…¼å®¹ç°æœ‰ä»£ç æ ¼å¼
  - é«˜çº§çŠ¶æ€ç®¡ç†åŠŸèƒ½
- **çŠ¶æ€**: âœ… å®Œæˆ

### 2. æ•°æ®åº“è¡¨ç»“æ„

#### contextsè¡¨
```sql
CREATE TABLE contexts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  session_id text NOT NULL,
  action text NOT NULL,  -- åŒºåˆ†ä¸åŒagentçš„ä¸Šä¸‹æ–‡
  context_data jsonb NOT NULL,
  metadata jsonb DEFAULT '{}',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(user_id, session_id, action)
);
```

#### notesè¡¨
```sql
CREATE TABLE notes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  session_id text NOT NULL,
  action text NOT NULL,  -- noteç±»å‹
  name text NOT NULL,     -- noteæ ‡è¯†ç¬¦
  context text NOT NULL,  -- noteå†…å®¹
  select_status integer DEFAULT 0,
  metadata jsonb DEFAULT '{}',
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(user_id, session_id, name)
);
```

### 3. è¿ç§»å·¥å…·

#### æ•°æ®åº“è¿ç§»è„šæœ¬
- **æ–‡ä»¶**: `utils/database/run_migrations.py`
- **åŠŸèƒ½**: è‡ªåŠ¨åˆ›å»ºè¡¨ã€ç´¢å¼•ã€æ£€æŸ¥RLSçŠ¶æ€
- **çŠ¶æ€**: âœ… å®Œæˆ

#### SQLè¿ç§»æ–‡ä»¶
- **æ–‡ä»¶**: `utils/database/migrations/001_create_contexts_table.sql`
- **æ–‡ä»¶**: `utils/database/migrations/002_create_notes_table.sql`
- **çŠ¶æ€**: âœ… å®Œæˆ

### 4. é›†æˆç¤ºä¾‹

#### å¸¦æŒä¹…åŒ–çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- **æ–‡ä»¶**: `utils/loomi_context_manager_with_persistence.py`
- **åŠŸèƒ½**: å®Œæ•´çš„é›†æˆç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å°†æŒä¹…åŒ–åŠŸèƒ½é›†æˆåˆ°ç°æœ‰ä»£ç 
- **çŠ¶æ€**: âœ… å®Œæˆ

#### æµ‹è¯•è„šæœ¬
- **æ–‡ä»¶**: `test_persistence_layer.py`
- **åŠŸèƒ½**: å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•ï¼ŒéªŒè¯æ‰€æœ‰CRUDæ“ä½œ
- **çŠ¶æ€**: âœ… å®Œæˆ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
pip install supabase==2.9.0
```

### 2. åˆå§‹åŒ–æ•°æ®åº“è¡¨
```bash
# è¿è¡Œè¿ç§»è„šæœ¬åˆ›å»ºè¡¨
python utils/database/run_migrations.py
```

### 3. åŸºç¡€ä½¿ç”¨
```python
from utils.database import init_persistence

# åˆå§‹åŒ–æŒä¹…åŒ–å±‚
pm = init_persistence()

# å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯
result = pm.store_user_message(
    session_id="your-session-id",
    content="ç”¨æˆ·æ¶ˆæ¯å†…å®¹"
)

# åˆ›å»ºnote
note_id = await pm.create_note(
    user_id="user123",
    session_id="session456", 
    note_type="profile",
    note_id="profile1",
    content="ç”¨æˆ·ç”»åƒå†…å®¹"
)

# ä¿å­˜ä¸Šä¸‹æ–‡
success = await pm.save_context(
    user_id="user123",
    session_id="session456",
    action="orchestrator",
    context_data={"key": "value"}
)
```

## ğŸ“Š æ•°æ®æ˜ å°„

### Noteså­—æ®µæ˜ å°„
æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œç°æœ‰ä»£ç çš„å­—æ®µæ˜ å°„å¦‚ä¸‹ï¼š
```python
# ç°æœ‰ä»£ç  -> æ•°æ®åº“å­—æ®µ
note_type  -> action     # noteç±»å‹
note_id    -> name       # noteæ ‡è¯†ç¬¦  
content    -> context    # noteå†…å®¹
select     -> select_status  # é€‰æ‹©çŠ¶æ€
```

### å…¼å®¹æ€§æ¥å£
æŒä¹…åŒ–ç®¡ç†å™¨æä¾›å…¼å®¹ç°æœ‰ä»£ç çš„æ¥å£ï¼š
```python
# å…¼å®¹ç°æœ‰æ ¼å¼çš„create_noteæ–¹æ³•
await pm.create_note(
    user_id=user_id,
    session_id=session_id,
    note_type=note_type,    # è‡ªåŠ¨æ˜ å°„ä¸ºaction
    note_id=note_id,        # è‡ªåŠ¨æ˜ å°„ä¸ºname
    content=content,        # è‡ªåŠ¨æ˜ å°„ä¸ºcontext
    select_status=0
)
```

## ğŸ”§ é›†æˆç°æœ‰ä»£ç 

### æ–¹å¼1ï¼šç›´æ¥æ›¿æ¢
```python
# åœ¨ç°æœ‰çš„loomi_context_manager.pyä¸­æ·»åŠ 
from utils.database import get_persistence

class LoomiContextManager:
    def __init__(self):
        # ... ç°æœ‰ä»£ç  ...
        self.persistence = get_persistence()
    
    async def add_note(self, ...):
        # ... ç°æœ‰é€»è¾‘ ...
        
        # ğŸ†• æ·»åŠ æŒä¹…åŒ–
        await self.persistence.create_note(
            user_id=user_id,
            session_id=session_id,
            note_type=note_type,
            note_id=note_id,
            content=content
        )
```

### æ–¹å¼2ï¼šä½¿ç”¨é›†æˆç‰ˆæœ¬
```python
# ä½¿ç”¨å®Œæ•´é›†æˆç‰ˆæœ¬
from utils.loomi_context_manager_with_persistence import LoomiContextManagerWithPersistence

# æ›¿æ¢åŸæœ‰çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨
context_manager = LoomiContextManagerWithPersistence()
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“æƒé™
- æµ‹è¯•æ˜¾ç¤ºchat_messagesè¡¨å¯ç”¨äº†RLSï¼ˆè¡Œçº§å®‰å…¨ç­–ç•¥ï¼‰
- éœ€è¦åœ¨Supabase Dashboardä¸­é…ç½®é€‚å½“çš„RLSç­–ç•¥æˆ–ç¦ç”¨RLS
- æˆ–ä½¿ç”¨æœåŠ¡è§’è‰²å¯†é’¥è€ŒéåŒ¿åå¯†é’¥

### 2. session_idæ ¼å¼
- session_idå¿…é¡»æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼
- chat_messagesè¡¨çš„project_idå­—æ®µå®é™…å°±æ˜¯session_id
- éœ€è¦ç¡®ä¿session_idåœ¨projectsè¡¨ä¸­å­˜åœ¨ï¼ˆå¤–é”®çº¦æŸï¼‰

### 3. é”™è¯¯å¤„ç†
- æ‰€æœ‰æ–¹æ³•éƒ½åŒ…å«å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- æ•°æ®åº“ä¸å¯ç”¨æ—¶ä¼šè‡ªåŠ¨é™çº§åˆ°å†…å­˜æ¨¡å¼
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### 1. è¿æ¥ç®¡ç†
- å»¶è¿Ÿåˆå§‹åŒ–æ•°æ®åº“è¿æ¥
- å•ä¾‹æ¨¡å¼é¿å…é‡å¤è¿æ¥
- è‡ªåŠ¨é‡è¯•å’Œè¿æ¥æ¢å¤

### 2. æŸ¥è¯¢ä¼˜åŒ–
- åŸºäºç”¨æˆ·å’Œä¼šè¯çš„å¤åˆç´¢å¼•
- æ”¯æŒæ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“è®¿é—®
- æ™ºèƒ½æŸ¥è¯¢ç¼“å­˜

### 3. é”™è¯¯æ¢å¤
- æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- ä¼˜é›…çš„é™çº§æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å¤„ç†

## ğŸ¯ é«˜çº§åŠŸèƒ½

### 1. AgentçŠ¶æ€ç®¡ç†
```python
# ä¿å­˜å®Œæ•´AgentçŠ¶æ€
await pm.save_agent_state(
    user_id="user123",
    session_id="session456", 
    agent_type="orchestrator",
    state_data={"rounds": 3},
    notes=[{"type": "insight", "content": "åˆ†æç»“æœ"}]
)

# åŠ è½½AgentçŠ¶æ€
state = await pm.load_agent_state(
    user_id="user123",
    session_id="session456",
    agent_type="orchestrator"
)
```

### 2. æ‰¹é‡æ“ä½œ
```python
# æ‰¹é‡æ›´æ–°noteé€‰æ‹©çŠ¶æ€
await pm.batch_update_selections(
    user_id="user123",
    session_id="session456",
    selections={
        "profile1": 1,  # é€‰ä¸­
        "profile2": 0,  # æœªé€‰ä¸­
        "insight1": 1   # é€‰ä¸­
    }
)
```

### 3. ç»Ÿè®¡åˆ†æ
```python
# è·å–notesæ‘˜è¦
summary = await pm.get_notes_summary("user123", "session456")
# è¿”å›: {
#   "total_count": 5,
#   "selected_count": 2, 
#   "by_action": {
#     "profile": {"total": 3, "selected": 1},
#     "insight": {"total": 2, "selected": 1}
#   },
#   "selection_rate": 0.4
# }
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•
```bash
python test_persistence_layer.py
```

### æµ‹è¯•è¦†ç›–
- âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•
- âœ… æ¶ˆæ¯å­˜å‚¨æµ‹è¯•ï¼ˆç”¨æˆ·ã€AIã€ç³»ç»Ÿæ¶ˆæ¯ï¼‰
- âœ… ä¸Šä¸‹æ–‡å­˜å‚¨æµ‹è¯•ï¼ˆCRUDæ“ä½œï¼‰
- âœ… Noteså­˜å‚¨æµ‹è¯•ï¼ˆåˆ›å»ºã€æŸ¥è¯¢ã€é€‰æ‹©çŠ¶æ€ï¼‰
- âœ… é«˜çº§åŠŸèƒ½æµ‹è¯•ï¼ˆAgentçŠ¶æ€ç®¡ç†ï¼‰
- âœ… é”™è¯¯å¤„ç†æµ‹è¯•

## ğŸ“š APIæ–‡æ¡£

### PersistenceManager æ ¸å¿ƒæ–¹æ³•

#### æ¶ˆæ¯ç›¸å…³
- `store_user_message(session_id, content)` - å­˜å‚¨ç”¨æˆ·æ¶ˆæ¯
- `store_assistant_message(session_id, content, function_tools, ...)` - å­˜å‚¨AIå›å¤
- `store_conversation_round(session_id, user_message, assistant_response)` - å­˜å‚¨å®Œæ•´å¯¹è¯è½®æ¬¡
- `get_chat_history(session_id, limit)` - è·å–å¯¹è¯å†å²

#### ä¸Šä¸‹æ–‡ç›¸å…³
- `save_context(user_id, session_id, action, context_data, metadata)` - ä¿å­˜ä¸Šä¸‹æ–‡
- `get_context(user_id, session_id, action)` - è·å–ä¸Šä¸‹æ–‡
- `delete_context(user_id, session_id, action)` - åˆ é™¤ä¸Šä¸‹æ–‡

#### Notesç›¸å…³
- `create_note(user_id, session_id, note_type, note_id, content, select_status)` - åˆ›å»ºnote
- `get_note_by_name(user_id, session_id, note_name)` - è·å–æŒ‡å®šnote
- `get_session_notes(user_id, session_id, action)` - è·å–ä¼šè¯notes
- `update_note_selection(user_id, session_id, note_name, select_status)` - æ›´æ–°é€‰æ‹©çŠ¶æ€
- `get_notes_summary(user_id, session_id)` - è·å–notesæ‘˜è¦

#### é«˜çº§åŠŸèƒ½
- `save_agent_state(user_id, session_id, agent_type, state_data, notes)` - ä¿å­˜AgentçŠ¶æ€
- `load_agent_state(user_id, session_id, agent_type)` - åŠ è½½AgentçŠ¶æ€

## ğŸ‰ æ€»ç»“

æŒä¹…åŒ–å±‚å·²å®Œæ•´å®ç°å¹¶å¯ç«‹å³æŠ•å…¥ä½¿ç”¨ï¼ä¸»è¦æˆå°±ï¼š

1. **å®Œæ•´çš„CRUDåŠŸèƒ½** - æ”¯æŒæ‰€æœ‰æ•°æ®ç±»å‹çš„å¢åˆ æ”¹æŸ¥
2. **å…¼å®¹ç°æœ‰ä»£ç ** - æ— éœ€å¤§å¹…ä¿®æ”¹ç°æœ‰ä»£ç ç»“æ„
3. **robusté”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
4. **é«˜æ€§èƒ½è®¾è®¡** - ä¼˜åŒ–çš„æŸ¥è¯¢å’Œæ‰¹é‡æ“ä½œ
5. **è¯¦ç»†æ–‡æ¡£** - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹ä»£ç 

ç°åœ¨å¯ä»¥ï¼š
- è¿è¡Œè¿ç§»è„šæœ¬åˆ›å»ºæ•°æ®åº“è¡¨
- é›†æˆåˆ°ç°æœ‰çš„loomi_context_manager
- å¼€å§‹æŒä¹…åŒ–ç”¨æˆ·æ•°æ®å’ŒAIåˆ†æç»“æœ
- å®ç°è·¨ä¼šè¯çš„æ•°æ®æ¢å¤åŠŸèƒ½ 
