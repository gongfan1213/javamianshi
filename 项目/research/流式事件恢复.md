# ğŸš€ Loomiæµå¼äº‹ä»¶æ¢å¤åŠŸèƒ½ - æç®€ç‰ˆéƒ¨ç½²æŒ‡å—

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **åªæœ‰2ä¸ªæ¥å£**ï¼šå¿ƒè·³æ¥å£ + æ™ºèƒ½æµå¼å›æ”¾æ¥å£
- **æ— ç”¨æˆ·é€‰æ‹©**ï¼šæ£€æµ‹åˆ°æ–­ç‚¹è‡ªåŠ¨å›æ”¾ï¼Œæ— éœ€ç”¨æˆ·ç¡®è®¤
- **é›¶è”è°ƒæˆæœ¬**ï¼šå‰ç«¯è‡ªåŠ¨å¤„ç†ï¼Œåç«¯è‡ªåŠ¨åˆ¤æ–­
- **æç®€é›†æˆ**ï¼šæœ€å°ä»£ç ä¿®æ”¹ï¼Œå¿«é€Ÿä¸Šçº¿

## ğŸ”§ å¿«é€Ÿéƒ¨ç½²ï¼ˆ5åˆ†é’Ÿå®Œæˆï¼‰

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆ1åˆ†é’Ÿï¼‰

åœ¨æ‚¨çš„Supabaseé¡¹ç›®ä¸­æ‰§è¡Œï¼š

```sql
-- æ‰§è¡Œ utils/database/migrations/create_stream_recovery_tables_simple.sql
-- è¿™å°†åˆ›å»º loomi_stream_events è¡¨
```

### æ­¥éª¤2ï¼šé›†æˆåˆ°PersistenceManagerï¼ˆ1åˆ†é’Ÿï¼‰

åœ¨ `utils/database/persistence_manager.py` ä¸­æ·»åŠ ï¼š

```python
# å¯¼å…¥ç®€åŒ–ç‰ˆå­˜å‚¨ç±»
from utils.database.stream_storage_simple import StreamEventStorageSimple

class PersistenceManager:
    def initialize(self):
        # ... ç°æœ‰ä»£ç  ...
        
        # ğŸ¯ æ–°å¢ï¼šåˆå§‹åŒ–æµå¼äº‹ä»¶å­˜å‚¨
        self.stream_storage = StreamEventStorageSimple()
        
        self.logger.info("ğŸ“Š StreamStorage: âœ… å·²åˆå§‹åŒ–")
```

### æ­¥éª¤3ï¼šæ‰©å±•BaseLoomiAgentï¼ˆ1åˆ†é’Ÿï¼‰

å°† `agents/loomi/base_loomi_agent_simple.py` ä¸­çš„ä»£ç å¤åˆ¶åˆ°æ‚¨çš„ `agents/loomi/base_loomi_agent.py` ä¸­ï¼Œæˆ–è€…æ›¿æ¢ç°æœ‰çš„ `emit_loomi_event` æ–¹æ³•ã€‚

### æ­¥éª¤4ï¼šæ³¨å†ŒAPIè·¯ç”±ï¼ˆ1åˆ†é’Ÿï¼‰

åœ¨ `apis/app.py` ä¸­æ·»åŠ ï¼š

```python
from apis.recovery_routes_simple import recovery_router

def create_app():
    app = FastAPI(...)
    
    # ğŸ¯ æ³¨å†Œç®€åŒ–ç‰ˆæ¢å¤è·¯ç”±
    app.include_router(recovery_router)
    
    return app
```

### æ­¥éª¤5ï¼šé›†æˆå‰ç«¯ï¼ˆ1åˆ†é’Ÿï¼‰

åœ¨HTMLé¡µé¢ä¸­å¼•å…¥ï¼š

```html
<script src="/static/js/loomi-recovery-simple.js"></script>
<script>
    // è®¾ç½®ç”¨æˆ·å’Œä¼šè¯ä¿¡æ¯
    window.userId = '{{ user_id }}';
    window.sessionId = '{{ session_id }}';
</script>
```

## ğŸ¯ å·¥ä½œåŸç†

### å‰ç«¯è‡ªåŠ¨æµç¨‹
```
é¡µé¢åŠ è½½ â†’ å¯åŠ¨å¿ƒè·³(æ¯5ç§’) â†’ è°ƒç”¨/streamæ¥å£æ£€æŸ¥å›æ”¾
       â†“
   è‡ªåŠ¨å›æ”¾æ–­ç½‘æœŸé—´çš„äº‹ä»¶(50msé—´éš”) â†’ å›æ”¾å®Œæˆ
```

### åç«¯åˆ¤æ–­é€»è¾‘
```python
# ç®€åŒ–ç‰ˆåˆ¤æ–­ï¼šåªè¦æœ‰æ–­ç½‘åçš„äº‹ä»¶å°±å›æ”¾
if has_disconnect_events:
    return {'needs_replay': True, 'events': [...]}

# æˆ–è€…äº‹ä»¶å †ç§¯å¤ªå¤šä¹Ÿå›æ”¾
if len(events) > 10:
    return {'needs_replay': True, 'events': [...]}
```

## ğŸ” æ¥å£è¯´æ˜

### 1. å¿ƒè·³æ¥å£
```bash
POST /api/loomi/heartbeat
{
    "user_id": "user123",
    "session_id": "session456"
}
```

**ä½œç”¨**ï¼šå‰ç«¯æ¯5ç§’è°ƒç”¨ï¼Œåç«¯è®°å½•ç”¨æˆ·æ´»è·ƒçŠ¶æ€ï¼Œç”¨äºæ£€æµ‹æ–­ç½‘

### 2. æ™ºèƒ½æµå¼æ¥å£
```bash
GET /api/loomi/stream/{session_id}
# è¿”å›SSEæµ
```

**ä½œç”¨**ï¼š
- æ— æ–­ç‚¹ï¼šè¿”å› `{"type": "no_replay"}`
- æœ‰æ–­ç‚¹ï¼šè‡ªåŠ¨æµå¼å›æ”¾æ‰€æœ‰æœªæ˜¾ç¤ºäº‹ä»¶

## ğŸ“± å‰ç«¯é›†æˆè¦ç‚¹

### è‡ªåŠ¨å¯åŠ¨
```javascript
// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    window.recoveryManager = new LoomiRecoverySimple(userId, sessionId);
});
```

### äº‹ä»¶æ˜¾ç¤ºï¼ˆéœ€è¦è‡ªå®šä¹‰ï¼‰
```javascript
displayThought(content, isReplay) {
    // TODO: æ ¹æ®æ‚¨çš„ç•Œé¢å®ç°æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
    // isReplay=true è¡¨ç¤ºè¿™æ˜¯å›æ”¾çš„äº‹ä»¶
}

displayConciergeMessage(content, isReplay) {
    // TODO: æ ¹æ®æ‚¨çš„ç•Œé¢å®ç°æ¥å¾…å‘˜æ¶ˆæ¯æ˜¾ç¤º
}

// ... å…¶ä»–äº‹ä»¶ç±»å‹
```

## âœ… éªŒè¯åŠŸèƒ½

1. **å¯åŠ¨åº”ç”¨**ï¼šé‡å¯æ‚¨çš„åº”ç”¨
2. **å‘èµ·è¯·æ±‚**ï¼šç”¨æˆ·å‘èµ·Loomiè¯·æ±‚
3. **æ¨¡æ‹Ÿæ–­ç½‘**ï¼šä¸­é€”å…³é—­é¡µé¢æˆ–æ–­ç½‘
4. **é‡æ–°è®¿é—®**ï¼šé‡æ–°æ‰“å¼€é¡µé¢
5. **è§‚å¯Ÿå›æ”¾**ï¼šåº”è¯¥çœ‹åˆ°å³ä¸Šè§’çš„å›æ”¾æŒ‡ç¤ºå™¨å’Œå®Œæ•´çš„äº‹ä»¶å›æ”¾

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### è°ƒæ•´å¿ƒè·³é—´éš”
```javascript
// ä¿®æ”¹ static/js/loomi-recovery-simple.js ä¸­çš„é—´éš”æ—¶é—´
this.heartbeatInterval = setInterval(() => {
    this.sendHeartbeat();
}, 3000); // æ”¹ä¸º3ç§’
```

### è°ƒæ•´æ–­ç½‘æ£€æµ‹é˜ˆå€¼
```python
# ä¿®æ”¹ agents/loomi/base_loomi_agent_simple.py ä¸­çš„é˜ˆå€¼
disconnect_threshold = datetime.now() - timedelta(seconds=20)  # æ”¹ä¸º20ç§’
```

### è°ƒæ•´å›æ”¾é€Ÿåº¦
```python
# ä¿®æ”¹ apis/recovery_routes_simple.py ä¸­çš„é—´éš”
await asyncio.sleep(0.1)  # æ”¹ä¸º100msé—´éš”
```

## ğŸŠ ä¼˜åŠ¿æ€»ç»“

âœ… **æç®€éƒ¨ç½²**ï¼š5ä¸ªæ–‡ä»¶ï¼Œæœ€å°ä»£ç ä¿®æ”¹  
âœ… **é›¶è”è°ƒ**ï¼šå‰ç«¯è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€å¤æ‚è”è°ƒ  
âœ… **è‡ªåŠ¨æ¢å¤**ï¼šæ— ç”¨æˆ·é€‰æ‹©ï¼Œæ£€æµ‹åˆ°æ–­ç‚¹è‡ªåŠ¨å›æ”¾  
âœ… **é«˜æ€§èƒ½**ï¼šå¿ƒè·³ç¼“å­˜ï¼Œå¼‚æ­¥å­˜å‚¨ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡  
âœ… **å®¹é”™æ€§å¼º**ï¼šå­˜å‚¨å¤±è´¥ä¸å½±å“æµå¼è¾“å‡º  

ç›¸æ¯”åŸè®¾è®¡å‡å°‘äº†ï¼š
- âŒ 4ä¸ªæ¥å£ â†’ âœ… 2ä¸ªæ¥å£
- âŒ ç”¨æˆ·ç¡®è®¤å¯¹è¯æ¡† â†’ âœ… è‡ªåŠ¨å›æ”¾
- âŒ å¤æ‚çŠ¶æ€ç®¡ç† â†’ âœ… ç®€å•äº‹ä»¶æ ‡è®°
- âŒ å‰ç«¯çŠ¶æ€åŒæ­¥ â†’ âœ… åŸºäºå¿ƒè·³çš„ç®€å•æ£€æµ‹

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **æ˜¾ç¤ºæ–¹æ³•éœ€è¦è‡ªå®šä¹‰**ï¼šè¯·æ ¹æ®æ‚¨çš„ç•Œé¢å®ç°å…·ä½“çš„äº‹ä»¶æ˜¾ç¤ºæ–¹æ³•
2. **ç”¨æˆ·ä¿¡æ¯è·å–**ï¼šç¡®ä¿å‰ç«¯èƒ½æ­£ç¡®è·å– `userId` å’Œ `sessionId`
3. **æ•°æ®åº“æ€§èƒ½**ï¼šå¤§é‡äº‹ä»¶æ—¶æ³¨æ„æ•°æ®åº“æ€§èƒ½ï¼Œå»ºè®®å®šæœŸæ¸…ç†
4. **ç½‘ç»œå¼‚å¸¸å¤„ç†**ï¼šå¿ƒè·³å¤±è´¥æ—¶æœ‰é™çº§å¤„ç†ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨

ç°åœ¨æ‚¨çš„Loomiç³»ç»Ÿæ‹¥æœ‰äº†ä¼ä¸šçº§çš„æ–­ç½‘æ¢å¤èƒ½åŠ›ï¼Œè€Œä¸”éƒ¨ç½²æˆæœ¬æä½ï¼ğŸ‰ 

