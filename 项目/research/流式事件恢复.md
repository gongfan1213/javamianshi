# 🚀 Loomi流式事件恢复功能 - 极简版部署指南

## ✨ 核心特性

- **只有2个接口**：心跳接口 + 智能流式回放接口
- **无用户选择**：检测到断点自动回放，无需用户确认
- **零联调成本**：前端自动处理，后端自动判断
- **极简集成**：最小代码修改，快速上线

## 🔧 快速部署（5分钟完成）

### 步骤1：创建数据库表（1分钟）

在您的Supabase项目中执行：

```sql
-- 执行 utils/database/migrations/create_stream_recovery_tables_simple.sql
-- 这将创建 loomi_stream_events 表
```

### 步骤2：集成到PersistenceManager（1分钟）

在 `utils/database/persistence_manager.py` 中添加：

```python
# 导入简化版存储类
from utils.database.stream_storage_simple import StreamEventStorageSimple

class PersistenceManager:
    def initialize(self):
        # ... 现有代码 ...
        
        # 🎯 新增：初始化流式事件存储
        self.stream_storage = StreamEventStorageSimple()
        
        self.logger.info("📊 StreamStorage: ✅ 已初始化")
```

### 步骤3：扩展BaseLoomiAgent（1分钟）

将 `agents/loomi/base_loomi_agent_simple.py` 中的代码复制到您的 `agents/loomi/base_loomi_agent.py` 中，或者替换现有的 `emit_loomi_event` 方法。

### 步骤4：注册API路由（1分钟）

在 `apis/app.py` 中添加：

```python
from apis.recovery_routes_simple import recovery_router

def create_app():
    app = FastAPI(...)
    
    # 🎯 注册简化版恢复路由
    app.include_router(recovery_router)
    
    return app
```

### 步骤5：集成前端（1分钟）

在HTML页面中引入：

```html
<script src="/static/js/loomi-recovery-simple.js"></script>
<script>
    // 设置用户和会话信息
    window.userId = '{{ user_id }}';
    window.sessionId = '{{ session_id }}';
</script>
```

## 🎯 工作原理

### 前端自动流程
```
页面加载 → 启动心跳(每5秒) → 调用/stream接口检查回放
       ↓
   自动回放断网期间的事件(50ms间隔) → 回放完成
```

### 后端判断逻辑
```python
# 简化版判断：只要有断网后的事件就回放
if has_disconnect_events:
    return {'needs_replay': True, 'events': [...]}

# 或者事件堆积太多也回放
if len(events) > 10:
    return {'needs_replay': True, 'events': [...]}
```

## 🔍 接口说明

### 1. 心跳接口
```bash
POST /api/loomi/heartbeat
{
    "user_id": "user123",
    "session_id": "session456"
}
```

**作用**：前端每5秒调用，后端记录用户活跃状态，用于检测断网

### 2. 智能流式接口
```bash
GET /api/loomi/stream/{session_id}
# 返回SSE流
```

**作用**：
- 无断点：返回 `{"type": "no_replay"}`
- 有断点：自动流式回放所有未显示事件

## 📱 前端集成要点

### 自动启动
```javascript
// 页面加载时自动初始化
document.addEventListener('DOMContentLoaded', () => {
    window.recoveryManager = new LoomiRecoverySimple(userId, sessionId);
});
```

### 事件显示（需要自定义）
```javascript
displayThought(content, isReplay) {
    // TODO: 根据您的界面实现思考过程显示
    // isReplay=true 表示这是回放的事件
}

displayConciergeMessage(content, isReplay) {
    // TODO: 根据您的界面实现接待员消息显示
}

// ... 其他事件类型
```

## ✅ 验证功能

1. **启动应用**：重启您的应用
2. **发起请求**：用户发起Loomi请求
3. **模拟断网**：中途关闭页面或断网
4. **重新访问**：重新打开页面
5. **观察回放**：应该看到右上角的回放指示器和完整的事件回放

## 🔧 自定义配置

### 调整心跳间隔
```javascript
// 修改 static/js/loomi-recovery-simple.js 中的间隔时间
this.heartbeatInterval = setInterval(() => {
    this.sendHeartbeat();
}, 3000); // 改为3秒
```

### 调整断网检测阈值
```python
# 修改 agents/loomi/base_loomi_agent_simple.py 中的阈值
disconnect_threshold = datetime.now() - timedelta(seconds=20)  # 改为20秒
```

### 调整回放速度
```python
# 修改 apis/recovery_routes_simple.py 中的间隔
await asyncio.sleep(0.1)  # 改为100ms间隔
```

## 🎊 优势总结

✅ **极简部署**：5个文件，最小代码修改  
✅ **零联调**：前端自动处理，无需复杂联调  
✅ **自动恢复**：无用户选择，检测到断点自动回放  
✅ **高性能**：心跳缓存，异步存储，不影响主业务  
✅ **容错性强**：存储失败不影响流式输出  

相比原设计减少了：
- ❌ 4个接口 → ✅ 2个接口
- ❌ 用户确认对话框 → ✅ 自动回放
- ❌ 复杂状态管理 → ✅ 简单事件标记
- ❌ 前端状态同步 → ✅ 基于心跳的简单检测

## 🚨 注意事项

1. **显示方法需要自定义**：请根据您的界面实现具体的事件显示方法
2. **用户信息获取**：确保前端能正确获取 `userId` 和 `sessionId`
3. **数据库性能**：大量事件时注意数据库性能，建议定期清理
4. **网络异常处理**：心跳失败时有降级处理，不影响正常使用

现在您的Loomi系统拥有了企业级的断网恢复能力，而且部署成本极低！🎉 

