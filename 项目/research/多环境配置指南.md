# BluePlan 多环境配置指南

本文档说明如何在 BluePlan 项目中使用多环境配置系统，支持开发环境和生产环境的独立配置管理。

## 🏗️ 架构概述

项目支持以下三种环境配置：

- **开发环境** (`env.dev`) - 用于本地开发和测试
- **生产环境** (`env.prod`) - 用于生产部署
- **环境指示器** (`env`) - 仅包含当前激活环境的标识符

## 📁 文件结构

```
blueplan_research/
├── env              # 环境指示器文件（仅包含ENVIRONMENT=development/production）
├── env.dev          # 开发环境完整配置
├── env.prod         # 生产环境完整配置
├── switch_env.py    # 环境切换工具
└── config/
    └── settings.py  # 配置加载逻辑（先读取env获取环境标识，再加载对应的env.dev/env.prod）
```

## 🔧 环境切换工具

### 基本用法

```bash
# 查看帮助信息
python switch_env.py

# 切换到开发环境
python switch_env.py dev

# 切换到生产环境
python switch_env.py prod

# 查看当前环境状态
python switch_env.py status

# 列出所有可用环境
python switch_env.py list
```

### 示例输出

```bash
$ python switch_env.py dev
✅ 已备份当前配置到: env.backup.dev
✅ 已切换到 dev 环境
✅ 环境变量已设置: ENVIRONMENT=development

$ python switch_env.py status
📍 当前环境: development
```

## 🌍 环境配置对比

### 开发环境特点 (`env.dev`)

- **调试模式**: `DEBUG=true`
- **日志级别**: `LOG_LEVEL=DEBUG`
- **性能限制**: 较低的并发用户数 (50)
- **安全设置**: 较宽松的安全策略
- **模型配置**: 使用较小的模型节省成本
- **Redis数据库**: 使用测试数据库 (`REDIS_DB=1`)
- **LangSmith项目**: `blueplan-research-dev`
- **OSS存储桶**: `blueimage-dev`

### 生产环境特点 (`env.prod`)

- **调试模式**: `DEBUG=false`
- **日志级别**: `LOG_LEVEL=INFO`
- **性能限制**: 更高的并发用户数 (200)
- **安全设置**: 严格的安全策略
- **模型配置**: 使用高性能模型
- **Redis数据库**: 使用生产数据库 (`REDIS_DB=0`)
- **LangSmith项目**: `blueplan-research-prod`
- **OSS存储桶**: `blueimage`

## 🔐 安全配置差异

| 配置项 | 开发环境 | 生产环境 |
|--------|----------|----------|
| JWT密钥 | 开发用密钥 | 强安全密钥 |
| Token过期时间 | 60分钟 | 30分钟 |
| 认证启用 | `false` | `true` |
| 速率限制 | `false` | `true` |
| 请求日志 | `false` | `true` |
| CORS严格模式 | `false` | `true` |

## 🚀 模型配置差异

| 任务类型 | 开发环境 | 生产环境 |
|----------|----------|----------|
| 普通任务 | `gemini-2.5-flash` (4K tokens) | `gemini-2.5-pro` (8K tokens) |
| 小红书搜索 | `gemini-2.5-flash` (4K tokens) | `gemini-2.5-pro` (8K tokens) |
| Gemini项目 | `bluemedia-db-bluelab-dev` | `bluemedia-db-bluelab` |

## 📋 自动配置加载

配置系统会自动根据以下优先级加载环境配置：

1. **环境变量** `ENVIRONMENT` 指定的环境
2. **默认开发环境** 如果没有指定环境变量
3. **降级到默认配置** 如果指定环境文件不存在

### 配置加载逻辑

```python
# config/settings.py 中的加载逻辑
# 1. 先从环境指示器文件读取当前环境
load_dotenv(project_root / "env")
environment = os.getenv('ENVIRONMENT', 'development')

# 2. 再加载对应环境的完整配置
env_files = {
    'development': project_root / "env.dev",
    'production': project_root / "env.prod"
}
load_dotenv(env_files[environment], override=True)
```

## 🔄 部署流程

### 开发环境部署

```bash
# 1. 切换到开发环境
python switch_env.py dev

# 2. 启动应用
python main.py
```

### 生产环境部署

```bash
# 1. 切换到生产环境
python switch_env.py prod

# 2. 验证配置
python switch_env.py status

# 3. 启动应用
python main.py
```

### Docker 部署

```dockerfile
# Dockerfile 中设置环境变量
ENV ENVIRONMENT=production

# 或者在 docker-compose.yml 中设置
environment:
  - ENVIRONMENT=production
```

## ⚠️ 注意事项

### 1. 配置文件安全

- **不要将生产环境密钥提交到版本控制**
- 在生产环境中使用环境变量覆盖敏感配置
- 定期轮换JWT密钥和API密钥

### 2. 环境隔离

- 开发和生产环境使用不同的数据库
- 确保Redis数据库索引不同 (`REDIS_DB`)
- 使用不同的OSS存储桶避免数据混淆

### 3. 监控和日志

- 生产环境启用所有监控功能
- 开发环境可以关闭部分监控减少资源消耗
- 注意日志级别对性能的影响

## 🛠️ 配置自定义

### 添加新环境

1. 创建新的环境配置文件，如 `env.staging`
2. 在 `switch_env.py` 中添加对应的环境映射
3. 在 `config/settings.py` 中添加环境配置支持

### 自定义配置项

在对应的环境配置文件中添加新的环境变量：

```bash
# 添加自定义配置
CUSTOM_FEATURE_ENABLED=true
CUSTOM_API_ENDPOINT=https://api.example.com
```

在 `config/settings.py` 中读取：

```python
custom_feature = self._get_env_or_default("CUSTOM_FEATURE_ENABLED", False, bool)
```

## 🐛 故障排除

### 常见问题

1. **环境切换失败**
   ```bash
   python switch_env.py status  # 检查当前状态
   python switch_env.py list    # 检查可用环境
   ```

2. **配置加载失败**
   ```bash
   # 检查环境变量
   echo $ENVIRONMENT
   
   # 检查配置文件是否存在
   ls -la env*
   ```

3. **权限问题**
   ```bash
   # 确保脚本有执行权限
   chmod +x switch_env.py
   ```

## 📚 相关文档

- [部署指南](DEPLOYMENT_GUIDE.md)
- [配置参考](config/README.md)
- [安全配置指南](SECURITY_CONFIG.md)

---

如有问题，请参考项目文档或联系开发团队。 
