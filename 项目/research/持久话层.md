# 持久化层需求文档

## 项目背景
当前 BluePlan Research 项目缺少持久化层，所有数据都存储在内存中。需要集成 Supabase 数据库来实现数据的持久化存储，确保用户会话、上下文和分析结果的可靠保存。

## 核心需求

### 1. 消息流持久化 (chat_messages表)

#### 1.1 需求描述
- **目标**: 存储用户消息、系统消息和AI响应的完整流式数据
- **现状**: 已有 `chat_messages` 表结构，但缺少客户端连接和操作代码
- **数据源**: 用户输入、AI工具调用响应、系统消息

#### 1.2 数据格式要求
```sql
-- 表结构 (已存在)
chat_messages (
  id uuid PRIMARY KEY,
  project_id uuid NOT NULL,
  role text NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
  content text NOT NULL,
  llm_raw_output jsonb NULL,
  function_tools jsonb NULL DEFAULT '[]',
  reference_tools jsonb NULL DEFAULT '[]',
  auto_select_tools jsonb NULL DEFAULT '[]',
  associated_card_id uuid NULL,
  created_at timestamptz NOT NULL DEFAULT now()
)
```

#### 1.3 存储场景
- **用户消息**: 简单文本存储，tools字段为空数组
- **AI响应**: 包含完整的工具调用数据在 `function_tools` 字段
- **系统消息**: 状态更新、错误信息等

### 2. 用户上下文持久化 (contexts表 - 新建)

#### 2.1 需求描述
- **目标**: 持久化用户会话上下文，支持跨会话数据恢复
- **数据源**: `loomi_context_builder.py` 中的上下文数据
- **关键字段**: action字段区分不同agent的上下文类型

#### 2.2 表结构设计
```sql
CREATE TABLE contexts (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  session_id text NOT NULL,
  action text NOT NULL,  -- 'concierge', 'orchestrator', 'insight', 'profile' 等
  context_data jsonb NOT NULL,  -- 完整的上下文数据
  metadata jsonb DEFAULT '{}',  -- 扩展元数据
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(user_id, session_id, action)
);
```

#### 2.3 存储内容
- **conversation_history**: 对话历史记录
- **user_message_queue**: 用户消息队列
- **tactics**: 执行策略记录
- **orchestrator_calls**: Orchestrator调用记录
- **execution_rounds**: 执行轮次数据
- **user_selections**: 用户选择状态

### 3. Notes结果持久化 (notes表 - 新建)

#### 3.1 需求描述
- **目标**: 存储所有AI生成的分析结果和见解
- **数据源**: 各个Agent生成的notes (profile, insight, hitpoint等)
- **用途**: 支持引用、检索和历史查看

#### 3.2 表结构设计
```sql
CREATE TABLE notes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id text NOT NULL,
  session_id text NOT NULL,
  action text NOT NULL,  -- 'profile', 'insight', 'hitpoint', 'content_analysis' 等
  name text NOT NULL,    -- note标识符，如 'profile1', 'insight5'
  context text NOT NULL, -- note完整内容
  select_status integer DEFAULT 0,  -- 选择状态：0未选择，1已选择
  metadata jsonb DEFAULT '{}',      -- 扩展信息
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now(),
  UNIQUE(user_id, session_id, name)
);
```

#### 3.3 数据映射
```python
# 从现有格式映射到数据库字段
{
  "user_id": user_id,
  "session_id": session_id, 
  "action": note_type.strip(),    # type -> action
  "name": note_id.strip(),        # id -> name
  "context": content.strip(),     # content -> context
  "select_status": 0              # 默认未选择
}
```

## 技术需求

### 4.1 数据库连接
- **数据库**: Supabase PostgreSQL
- **连接方式**: supabase-py客户端
- **配置**: 环境变量管理连接信息

### 4.2 操作接口需求
- **消息存储**: 批量存储对话轮次
- **上下文管理**: CRUD操作，支持增量更新
- **Notes管理**: 创建、查询、更新选择状态
- **事务支持**: 确保数据一致性
- **错误处理**: 数据库连接失败的降级机制

### 4.3 性能需求
- **查询优化**: 基于user_id + session_id的高效查询
- **批量操作**: 支持批量插入和更新
- **缓存策略**: 热数据缓存机制
- **连接池**: 数据库连接复用

## 集成点

### 5.1 现有代码集成
- **loomi_context_manager.py**: 需要增加持久化调用
- **各Agent文件**: 在生成notes后调用存储接口  
- **API层**: 在用户交互时触发存储操作

### 5.2 配置管理
- **环境变量**: DATABASE_URL, SUPABASE_KEY等
- **配置文件**: 数据库连接池、超时等参数
- **开发/生产**: 不同环境的数据库配置

## 优先级

### P0 (必须)
1. chat_messages 存储客户端实现
2. contexts 表创建和基础CRUD
3. notes 表创建和基础CRUD

### P1 (重要)  
1. 事务管理和错误处理
2. 批量操作优化
3. 与现有代码的集成

### P2 (优化)
1. 缓存层实现
2. 性能监控
3. 数据备份策略

## 验收标准

### 功能验收
- [ ] 用户对话能够完整存储到chat_messages表
- [ ] 上下文数据能够跨会话恢复
- [ ] Notes能够正确存储和检索
- [ ] 支持用户选择状态的持久化

### 性能验收  
- [ ] 单次对话存储响应时间 < 100ms
- [ ] 上下文加载时间 < 200ms
- [ ] 支持并发100用户的数据操作

### 可靠性验收
- [ ] 数据库连接失败时系统不崩溃
- [ ] 数据完整性约束正确执行
- [ ] 支持优雅的数据迁移 
