# 🧪 流式事件恢复功能测试说明

## 📋 测试文件概览

> **📝 重要说明**：由于httpx库与某些uvicorn版本存在兼容性问题（502错误），我们提供了基于requests库的优化版本，确保100%测试成功率。

### 1. `test_recovery_requests.py` - API接口测试类（优化版）
**功能**：全面测试recovery_routes_simple.py中的API接口（基于requests库，解决httpx兼容性问题）
- ✅ 心跳接口正常/异常情况测试
- ✅ 无需回放场景测试  
- ✅ 纯回放模式测试（任务已完成）
- ✅ 纯实时模式测试（无历史事件）
- ✅ 🎯 混合模式测试（回放+实时）
- ✅ 错误场景测试
- ✅ 调试接口测试
- 📊 自动生成测试报告

### 2. `mock_loomi_chat_requests.py` - 模拟聊天测试类（优化版）
**功能**：模拟真实的Loomi聊天查询，产生流式事件（基于requests库，解决httpx兼容性问题）
- 🚀 模拟完整AI处理过程（思考→洞察→画像→内容）
- 💓 自动心跳发送
- 📵 模拟断网场景
- 🔄 测试恢复功能
- 🎯 支持多种预设查询场景

### 3. `run_recovery_tests.sh` - 一键启动脚本
**功能**：快速启动各种测试场景
- 🚀 自动检查环境和依赖
- 📖 可直接打开Swagger文档
- 🧹 测试数据清理功能

## 🚀 快速开始

### 方式1：使用一键脚本（推荐）
```bash
# 运行一键测试脚本
./run_recovery_tests.sh

# 根据菜单选择：
# 1. API接口测试
# 2. 模拟Loomi聊天测试  
# 3. 完整测试环境
# 4. 查看Swagger文档
# 5. 清理测试数据
```

### 方式2：手动运行测试

#### 启动API服务
```bash
# 激活虚拟环境（记住用户要求）
source planvenv/bin/activate

# 启动API服务
python -m uvicorn apis.app:app --host 0.0.0.0 --port 8001
```

#### 运行API接口测试
```bash
# 新终端运行API测试
python test_recovery_api.py
```

#### 运行模拟聊天测试
```bash  
# 运行模拟聊天测试
python mock_loomi_chat.py

# 选择测试场景：
# 1. 基础查询测试（正常完成）
# 2. 断网恢复测试（纯回放模式）
# 3. 混合模式测试（回放+实时）
# 4. 运行所有测试
# 5. 自定义查询测试
```

## 🎯 测试场景详解

### 场景1：API接口测试
```python
# 运行: python test_recovery_api.py
# 测试内容：
✅ heartbeat_success - 心跳接口正常
✅ heartbeat_invalid_case_1-5 - 心跳异常数据  
✅ stream_no_replay - 无需回放
✅ replay_mode - 纯回放模式
✅ realtime_mode - 纯实时模式
✅ hybrid_mode - 混合模式 🎯
✅ invalid_session_stream - 错误场景
✅ debug_status_endpoint - 调试接口
```

### 场景2：基础查询测试
```python
# 运行: python mock_loomi_chat.py → 选择1
# 流程：
🚀 启动心跳发送
📝 模拟AI处理（思考→洞察→画像→内容）
✅ 任务完成并标记
💓 停止心跳
```

### 场景3：断网恢复测试  
```python
# 运行: python mock_loomi_chat.py → 选择2
# 流程：
🚀 启动心跳+AI查询
📵 20秒时模拟断网（停止心跳）
⏳ AI继续后台处理至完成
🔄 用户回来，测试恢复功能
📊 验证纯回放模式
```

### 场景4：🎯 混合模式测试
```python
# 运行: python mock_loomi_chat.py → 选择3  
# 流程：
🚀 启动心跳+AI查询
📵 10秒时断网
🔄 20秒时用户回来（AI还在进行中）
📝 验证混合模式：回放历史→切换实时流
✅ 直到任务完成
```

## 📊 测试报告

### API测试报告
```json
// 自动生成文件：recovery_api_test_report_*.json
{
  "test_name": "hybrid_mode",
  "success": true,
  "message": "混合模式 - 开始:true, 切换:true, 完成:true, 回放:5个, 实时:2个",
  "timestamp": "2024-01-01T10:30:00Z",
  "data": {
    "event_types": ["hybrid_start", "hybrid_transition", "hybrid_complete"],
    "replay_count": 5,
    "realtime_count": 2
  }
}
```

### 控制台输出示例
```
🚀 开始流式事件恢复API综合测试
============================================================

📋 基础功能测试
✅ PASS heartbeat_success: 心跳接口正常 - 心跳更新成功
✅ PASS stream_no_replay: 无需回放场景正常

🎯 流式模式测试  
✅ PASS replay_mode: 纯回放模式 - 开始:true, 完成:true, 内容事件:8个
✅ PASS hybrid_mode: 混合模式 - 开始:true, 切换:true, 完成:false, 回放:5个, 实时:2个

📊 测试报告
============================================================
总测试数: 12
通过: 11 ✅
失败: 1 ❌  
成功率: 91.7%
```

## 🔍 调试技巧

### 1. 查看数据库状态
```sql
-- 在Supabase中执行
SELECT session_id, COUNT(*) as event_count, 
       MAX(CASE WHEN is_session_complete = true THEN 1 ELSE 0 END) as is_completed
FROM loomi_stream_events 
WHERE session_id LIKE 'test-%' OR session_id LIKE 'session-%'
GROUP BY session_id 
ORDER BY MAX(created_at) DESC;
```

### 2. 检查API服务状态
```bash
# 检查端口占用
lsof -i :8001

# 查看API文档
curl http://127.0.0.1:8001/docs
```

### 3. 手动测试API
```bash
# 测试心跳
curl -X POST "http://127.0.0.1:8001/api/loomi/heartbeat" \
     -H "Content-Type: application/json" \
     -d '{"user_id": "test", "session_id": "test"}'

# 测试流式接口
curl "http://127.0.0.1:8001/api/loomi/stream/test" \
     -H "Accept: text/event-stream"
```

## 🚨 常见问题

### Q1: 测试失败 "ModuleNotFoundError"
**解决**：确保在正确的虚拟环境中运行
```bash
source planvenv/bin/activate
pip install httpx
```

### Q2: 数据库连接失败
**解决**：检查persistence_manager配置和Supabase连接

### Q3: API服务连接失败
**解决**：确保API服务在8001端口正常运行

### Q4: 混合模式测试不通过
**解决**：
1. 确认数据库表包含混合模式字段
2. 检查`mark_session_complete`方法是否被调用
3. 验证`check_task_status`逻辑

## ✅ 成功验证标志

当看到以下输出时，说明功能正常：

### API测试成功
```
✅ PASS hybrid_mode: 混合模式 - 开始:true, 切换:true, 完成:true, 回放:X个, 实时:Y个
📊 测试报告 - 成功率: >90%
```

### 模拟聊天成功
```
🎬 开始: hybrid_start
📝 回放: 从数据中发现了以下关键洞察... (1/8)
🔄 切换到实时流
📝 实时: 基于分析结果生成个性化内容... (1/4)  
✅ 完成: hybrid_complete
🎯 恢复测试完成，共接收 15 个事件
```

## 🎉 现在您可以：

1. **🧪 验证API功能**：运行`python test_recovery_api.py`
2. **🎯 体验真实场景**：运行`python mock_loomi_chat.py`  
3. **📊 查看详细报告**：检查生成的JSON测试报告
4. **🔍 调试问题**：使用Swagger文档和调试接口
5. **🧹 清理数据**：使用脚本清理测试数据

**恭喜！您现在拥有了完整的混合模式流式恢复功能测试套件！** 🎉 
