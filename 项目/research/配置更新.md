# 🔄 BluePlan 配置更新操作指南

## 📋 标准更新流程

当您需要更新 `bluelab.json` 配置文件时，请按以下步骤操作：

### 步骤1: 准备新配置文件
```bash
# 将新的配置内容保存为临时文件
# 例如：config/bluelab-new.json
```

### 步骤2: 进入项目环境
```bash
cd /path/to/blueplan_research
source planvenv/bin/activate
```

### 步骤3: 替换配置文件
```bash
# 方式A：如果有新的配置文件
cp config/bluelab-new.json config/bluelab.json

# 方式B：如果直接编辑现有文件
# 直接编辑 config/bluelab.json 文件
```

### 步骤4: 重新加密配置
```bash
# 一键重新加密和编译
python config_manager.py secure-setup
```

**⚠️ 重要提示**：
- 如果系统提示删除原始配置文件，输入 `y` 确认
- 这会重新生成加密文件和二进制文件

### 步骤5: 更新主密钥（如果有新密钥）
```bash
# 如果生成了新的主密钥，更新环境配置文件
# 编辑 env.dev 文件，更新 BLUEPLAN_MASTER_KEY 的值
```

### 步骤6: 验证配置
```bash
# 验证配置状态
python config_manager.py status

# 验证应用集成
python -c "
from utils.gemini_client_gen import GeminiClientGen
client = GeminiClientGen()
print('✅ 配置更新成功！')
print(f'项目ID: {client.get_model_info()[\"project_id\"]}')
"
```

### 步骤7: 清理临时文件
```bash
# 删除临时配置文件（如果有）
rm -f config/bluelab-new.json
```

### 步骤8: 提交更改
```bash
# 提交加密后的配置文件
git add config/bluelab.enc config/bluelab.bin
git add env.dev  # 如果更新了主密钥
git commit -m "Update encrypted configuration"
```

## 🚀 快捷更新流程

如果您只是小幅修改配置，可以使用简化流程：

### 一行命令更新：
```bash
# 编辑配置后，一键重新加密
python config_manager.py secure-setup && python config_manager.py status
```

## 🔧 常用命令速查

| 命令 | 用途 |
|------|------|
| `python config_manager.py status` | 查看配置状态 |
| `python config_manager.py setup-key` | 生成新主密钥 |
| `python config_manager.py encrypt` | 仅加密配置 |
| `python config_manager.py compile` | 仅编译为二进制 |
| `python config_manager.py secure-setup` | 一键完整设置 |

## ⚠️ 重要注意事项

### 主密钥管理
- 🔑 **保存密钥**: 每次生成新密钥后，立即更新 `env.dev` 文件
- 🔄 **环境同步**: 确保所有环境（开发/生产）使用对应的密钥
- 💾 **安全备份**: 将主密钥安全保存在密码管理器中

### 安全最佳实践
- ❌ **不要提交明文**: 永远不要将 `bluelab.json` 提交到Git
- ✅ **提交加密文件**: 只提交 `.enc` 和 `.bin` 文件
- 🔄 **定期轮换**: 建议每季度更换主密钥
- 🏷️ **环境隔离**: 开发和生产环境使用不同密钥

### 故障排除

#### 配置加载失败
```bash
# 检查主密钥是否正确设置
echo $BLUEPLAN_MASTER_KEY

# 重新加载环境变量
source env.dev

# 验证配置状态
python config_manager.py status
```

#### 加密文件损坏
```bash
# 如果有备份的 bluelab.json，重新加密
python config_manager.py secure-setup

# 如果没有备份，需要重新创建配置文件
```

## 📝 操作检查清单

更新配置时，请确认以下步骤：

- [ ] 准备好新的配置内容
- [ ] 进入项目虚拟环境
- [ ] 更新配置文件
- [ ] 运行 `secure-setup` 重新加密
- [ ] 更新环境变量文件（如有新密钥）
- [ ] 验证配置加载成功
- [ ] 测试应用功能正常
- [ ] 清理临时文件
- [ ] 提交加密文件到Git

## 🎯 总结

记住这个简单的更新流程：
1. **更新** → 修改配置文件
2. **加密** → `python config_manager.py secure-setup`
3. **验证** → `python config_manager.py status`
4. **提交** → `git add` 加密文件

就这么简单！🚀 
