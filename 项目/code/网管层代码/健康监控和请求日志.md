### `apis/middleware.py` 作用与细节
- 功能
  - 请求级日志中间件：记录每次请求的开始与结束、HTTP 方法、URL、状态码、耗时。
  - 在响应头加入 `X-Process-Time`（以秒为单位），便于前端与监控系统采集端到端耗时。
- 关键实现
  - `RequestLoggingMiddleware(BaseHTTPMiddleware).dispatch`：
    - 请求前记录 “Request started: {method} {url}”
    - 调用下游处理
    - 计算耗时，记录 “Request completed ... Status: ... Time: ...s”
    - 将耗时写入响应头 `X-Process-Time`
  - `setup_middleware(app)`：注册该中间件。实际启用在 `apis/app.py` 里调用 `setup_middleware(app)`。
- 日志通道
  - 使用标准库 `logging.getLogger(__name__)`，具体落盘/格式由全局日志配置决定（项目里通常由 `core/log_config.py` 配置）。
- 使用与排错
  - 若需关闭/替换日志粒度：改写或包裹 `RequestLoggingMiddleware`。
  - 若未看到 `X-Process-Time`，检查是否经过该中间件（确保 `setup_middleware(app)` 被调用）。

### `apis/health.py` 作用与细节
- 功能
  - 健康检查与运行时诊断，覆盖基础资源、存储层、配置、端口监控等。
- 路由前缀说明
  - 在 `apis/app.py` 中以 `prefix="/health"` 注册 `health_router`。
  - 因 `health_router` 内部又使用了 `@get("/health")` 等，实际完整路径为：
    - GET `/health/health`（基础健康）
    - GET `/health/health/detailed`（详细健康）
    - 端口监控系（见下）
- 公开接口
  - GET `/health/health`
    - 返回基础健康状态：`status/timestamp/service/version`。固定 200。
  - GET `/health/health/detailed`
    - 聚合检查项：`basic`（主机资源）、`storage`（文件/Redis/队列/轮次结果）、`config`（关键环境与配置）
    - 汇总 `status`：全部 healthy → 200；否则 → 503
  - 端口监控（依赖 `utils.port_monitor_service`）
    - GET `/health/port-monitor`：一次性检查端口组，healthy→200，否则→503
    - POST `/health/port-monitor/start`：启动后台端口监控，返回监控间隔
    - POST `/health/port-monitor/stop`：停止监控
    - GET `/health/port-monitor/status`：读取当前监控状态
- 内部检查项（详细健康用）
  - `_check_basic_health`：使用 `psutil` 采集内存、磁盘占用，超过阈值给出 `warnings`
  - `_check_storage_health`：
    - `_check_file_storage`：检测 `data/nova3_queues` 可写、统计队列文件数
    - `_check_redis_storage`：按 `config.settings().memory` 配置拼接 Redis URL，`aioredis` ping/读取内存信息
    - `_check_queue_manager`：创建 `LayeredQueueManager` 获取队列统计
    - `_check_round_results_manager`：初始化 `RoundResultsManager`，读取 Redis 统计
    - 汇总层级状态，得出整体 `healthy/degraded/unhealthy`
  - `_check_config_health`：检查关键环境变量（如 `OPENAI_API_KEY`、`OPENAI_API_BASE`）与 Redis 配置完整性，返回 `warnings` 和 `status`
  - `_check_port_status`：底层端口连通性探测（当前由 `port_monitor_service` 封装对外）
- 依赖与注意
  - 需要安装 `psutil`、`aioredis`；若 Redis 未启用或包缺失，会返回 `disabled/unavailable/unhealthy` 的分支信息。
  - 详细健康接口可能触发外部资源连接（Redis），异常会被捕获为 `unhealthy` 但不影响接口返回结构。
  - 若你希望对接外部监控系统（Prometheus/云拨测）：可直接拉取 `/health/health` 与 `/health/health/detailed`，或二次封装。

- 快速验证
  - 基础健康：GET `/health/health`
  - 详细健康：GET `/health/health/detailed`
  - 端口监控：GET `/health/port-monitor`，必要时先 `POST /health/port-monitor/start`

- 返回语义
  - 详细健康接口会以 200/503 表示整体可用性；基础健康恒定 200，适合负载均衡的轻量探活。

- 扩展建议
  - 如需降噪：可将 `warnings` 阈值/字段做配置化。
  - 如需外部依赖探测（DB、第三方 API）：参照 Redis 检查方式增加 `_check_*` 并汇总到 `checks.storage` 或新增 `checks.external`。

- 小结
  - `middleware.py` 提供请求级日志与耗时头，`health.py` 提供系统健康体检与端口监控，两者共同提升可观测性与运维友好度。
