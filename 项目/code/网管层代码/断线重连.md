### è¿™ä¸ªæ–‡ä»¶æ˜¯åšä»€ä¹ˆçš„
`apis/recovery_routes_simple.py` æä¾›â€œæ–­çº¿é‡è¿/å›æ”¾æ¢å¤â€çš„æœ€å°å®ç°ï¼Œå›´ç»• Loomi/Nova3 çš„æµå¼è¾“å‡ºåšä¸‰ä»¶äº‹ï¼š
- å¿ƒè·³ä¸ŠæŠ¥ï¼šè®°å½•ç”¨æˆ·æ´»è·ƒï¼Œåˆ¤æ–­æ˜¯å¦æ‰çº¿ã€‚
- æ™ºèƒ½æµå¼å›æ”¾ï¼šæ ¹æ®ä¼šè¯çŠ¶æ€ï¼Œè‡ªåŠ¨é€‰æ‹©â€œæ— éœ€å›æ”¾/çº¯å›æ”¾/å›æ”¾â†’å®æ—¶æµâ€çš„æ¨¡å¼ï¼ŒæŠŠä¸¢å¤±çš„äº‹ä»¶é‡æ–°æ¨é€ç»™å‰ç«¯ã€‚
- è°ƒè¯•è¯Šæ–­ï¼šæš´éœ²çŠ¶æ€æŸ¥è¯¢æ¥å£ï¼Œå®šä½æ–­çº¿ä¸å›æ”¾é€»è¾‘ã€‚

### è·¯ç”±ä¸åŸºç¡€
- è·¯ç”±å‰ç¼€ï¼š`/api/loomi`
- æ—¥å¿—ï¼š`BluePlanLogger("RecoveryRoutes")`
- æ•°æ®æ¨¡å‹ï¼š`HeartbeatRequest(user_id, session_id)`

### æ ¸å¿ƒæ¥å£
- å¿ƒè·³æ¥å£ï¼ˆå‰ç«¯æ¯ 5 ç§’è°ƒç”¨ï¼‰
```25:33:apis/recovery_routes_simple.py
@recovery_router.post("/heartbeat")
async def user_heartbeat(request: HeartbeatRequest):
    """
    ç”¨æˆ·æ´»è·ƒçŠ¶æ€å¿ƒè·³æ¥å£
    - å‰ç«¯æ¯5ç§’è°ƒç”¨ä¸€æ¬¡
    - åç«¯è®°å½•ç”¨æˆ·æœ€åæ´»è·ƒæ—¶é—´
    - ç”¨äºåˆ¤æ–­ç”¨æˆ·ä½•æ—¶æ–­ç½‘
    """
```
ä½œç”¨ï¼šè°ƒç”¨ `persistence_manager.stream_storage.update_user_heartbeat` æ›´æ–°å¿ƒè·³å¹¶è¿”å›æ˜¯å¦æˆåŠŸå’Œæ—¶é—´æˆ³ã€‚

- æ™ºèƒ½å›æ”¾æ¥å£ï¼ˆé¡µé¢åŠ è½½/é‡è¿æ—¶è°ƒç”¨ï¼‰
```57:66:apis/recovery_routes_simple.py
@recovery_router.get("/stream/{user_id}/{session_id}")
async def smart_stream_output(user_id: str, session_id: str):
    """
    æ™ºèƒ½æµå¼è¾“å‡ºæ¥å£ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒæ··åˆæ¨¡å¼ï¼‰
    - å‰ç«¯é¡µé¢åŠ è½½æ—¶è°ƒç”¨
    - åç«¯è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ”¾æ–­ç‚¹åçš„äº‹ä»¶
    - ğŸ¯ æ–°å¢ï¼šæ”¯æŒ"å›æ”¾+å®æ—¶æµ"æ··åˆæ¨¡å¼
    - å¦‚æœä»»åŠ¡å·²å®Œæˆï¼šçº¯å›æ”¾æ¨¡å¼
    - å¦‚æœä»»åŠ¡è¿›è¡Œä¸­ï¼šå›æ”¾å†å² â†’ åˆ‡æ¢åˆ°å®æ—¶æ¥æ”¶
    """
```
å†³ç­–æµç¨‹ï¼š
1) `check_need_replay(session_id)` åˆ¤æ–­æ˜¯å¦æœ‰æœªå›æ”¾äº‹ä»¶  
2) `check_task_status(session_id)` åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä»åœ¨è¿›è¡Œ  
- æ— éœ€å›æ”¾ï¼š
  - è‹¥ä»»åŠ¡è¿›è¡Œä¸­ â†’ è¿›å…¥å®æ—¶æµ `_start_realtime_stream`
  - è‹¥ä»»åŠ¡å·²å®Œæˆ â†’ ç®€å•è¿”å› `no_replay` å¹¶å‘é€æ ‡å‡†ç»“æŸä¿¡å· `[DONE]`
- éœ€è¦å›æ”¾ï¼š
  - è‹¥ä»»åŠ¡è¿›è¡Œä¸­ â†’ æ··åˆæ¨¡å¼ `_start_hybrid_stream`ï¼ˆå…ˆå›æ”¾å†å²ï¼Œå†åˆ‡å®æ—¶ï¼‰
  - è‹¥ä»»åŠ¡å·²å®Œæˆ â†’ çº¯å›æ”¾ `_start_replay_only_stream`

### è°ƒè¯•æ¥å£
- `/debug/status/{session_id}`ï¼šæŸ¥çœ‹ `recovery_info`
- `/debug/disconnect/{session_id}`ï¼šæ–­ç½‘äº‹ä»¶è¯Šæ–­
- `/debug/completion/{session_id}`ï¼šä¼šè¯å®ŒæˆçŠ¶æ€è¯Šæ–­ + ä»»åŠ¡çŠ¶æ€

### ä¸‰ç§æµæ¨¡å¼çš„å†…éƒ¨å®ç°ï¼ˆSSEï¼‰
æ‰€æœ‰æ¨¡å¼éƒ½é€šè¿‡ `StreamingResponse` é€æ¡ `yield`ï¼Œå¹¶åœ¨å®Œæˆæˆ–å¼‚å¸¸æ—¶è¾“å‡ºæ ‡å‡†ç»“æŸä¿¡å· `[DONE]`ï¼Œheaders è®¾ç½®äº† `Cache-Control: no-cache` ä¸ `Connection: keep-alive`ã€‚

- å®æ—¶æµ `_start_realtime_stream`
  - å¯åŠ¨å‰å†æ¬¡ç¡®è®¤ä»»åŠ¡ä»åœ¨è¿è¡Œï¼Œå¦åˆ™ç›´æ¥ `[DONE]`
  - è½®è¯¢æ–°äº‹ä»¶ `get_events_after_timestamp(session_id, last_check)`
  - åŠ¨æ€è½®è¯¢é—´éš”ï¼šåŸºç¡€ 2sï¼Œé€æ­¥å›é€€åˆ°æœ€å¤š 10sï¼›è¶…æ—¶ 600s ä¿æŠ¤
  - æ¯æ‰¹æ–°äº‹ä»¶ç«‹å³â€œæ ‡è®°ä¸ºå·²å›æ”¾â€ï¼ˆé˜²æ­¢é‡å¤ï¼‰ï¼š`mark_specific_events_replayed`
  - è¿ç»­é”™è¯¯ä¸Šé™ 5 æ¬¡è§¦å‘åœæ­¢ï¼Œå¼‚å¸¸ä¹Ÿä¼šå‘é€ `[DONE]`
  - ç»“æŸæ¡ä»¶ï¼š`check_task_status` è¿”å›ä¸åœ¨è¿è¡Œ â†’ å‘é€ `task_complete` + `[DONE]`

- æ··åˆæµ `_start_hybrid_stream`
  - Phase 1ï¼ˆå›æ”¾å†å²ï¼‰ï¼šæŒ‰é¡ºåºå›æ”¾ `recovery_info['events']`ï¼Œä¸ºæ¯æ¡äº‹ä»¶è¡¥å……å…ƒæ•°æ®ï¼š
    - `is_replay: True`ã€`replay_progress: "i/total"`ã€`is_after_disconnect`ã€`hybrid_phase: "replay"`
  - å›æ”¾å®Œæˆåï¼š`mark_events_replayed(session_id)`
  - Phase 2ï¼ˆå®æ—¶æµï¼‰ï¼šè½¬å…¥ä¸å®æ—¶æµç›¸åŒçš„è½®è¯¢é€»è¾‘ï¼Œå¹¶è¿½åŠ  `hybrid_phase: "realtime"`

- çº¯å›æ”¾ `_start_replay_only_stream`
  - é¡ºåºå›æ”¾æ‰€æœ‰å†å²äº‹ä»¶ï¼Œè¡¥å…… `is_replay: True`ã€`replay_progress`ã€`is_after_disconnect`
  - å®Œæˆå `mark_events_replayed` å¹¶è¾“å‡º `replay_complete` + `[DONE]`

### äº‹ä»¶æ ¼å¼ï¼ˆä¸ `apis/schemas.py` å¯¹é½ï¼‰
æ¯æ¡è¾“å‡ºäº‹ä»¶è¢«æ„é€ æˆç»Ÿä¸€ç»“æ„ï¼Œå‰ç«¯å¯ç›´æ¥æŒ‰ `StreamEvent` è§£æï¼š
```340:356:apis/recovery_routes_simple.py
stream_event = {
    "event_type": event['event_type'],
    "agent_source": event['agent_source'],
    "timestamp": event['created_at'],
    "payload": {
        "id": event.get('id') or event.get('event_id'),
        "content_type": event['content_type'],
        "data": event_data,            # å¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–ç»“æ„åŒ–åˆ—è¡¨
        "metadata": {
            **event_metadata,
            "is_replay": True/False,
            "is_realtime": True/False,
            "hybrid_phase": "replay"/"realtime",
            ...
        }
    }
}
```
- `event_data`/`event_metadata` è‹¥ä¸ºå­—ç¬¦ä¸²ä¼šå°è¯• JSON è§£æï¼Œå¤±è´¥åˆ™é€ä¼ å­—ç¬¦ä¸²ã€‚
- ç»Ÿä¸€è¡¥å……æ ‡å¿—ä½ï¼Œä¾¿äºå‰ç«¯æ¸²æŸ“ä¸ç»Ÿè®¡ã€‚

### ä¸æŒä¹…åŒ–å±‚çš„äº¤äº’
- å¿ƒè·³ï¼š`update_user_heartbeat`ã€`get_last_heartbeat`
- å›æ”¾åˆ¤å®šï¼š`check_need_replay`
- ä»»åŠ¡çŠ¶æ€ï¼š`check_task_status`
- æ‹‰å–äº‹ä»¶ï¼š`get_events_after_timestamp`
- å›æ”¾æ ‡è®°ï¼š`mark_events_replayed`ã€`mark_specific_events_replayed`
- è¯Šæ–­ï¼š`diagnose_disconnect_events`ã€`diagnose_session_completion`

### å…³é”®è¾¹ç•Œä¸é²æ£’æ€§
- æ—¶åŒºä¸€è‡´æ€§ï¼šå¿ƒè·³æ£€æµ‹å¼ºåˆ¶ä½¿ç”¨ UTC naive æ—¶é—´åšæ¯”è¾ƒï¼Œé¿å…æ—¶åŒºè¯¯åˆ¤ï¼ˆ120s æ— å¿ƒè·³è§†ä¸ºä¸æ´»è·ƒï¼‰ã€‚
- èµ„æºä¿æŠ¤ï¼šå®æ—¶/æ··åˆå®æ—¶é˜¶æ®µ 10 åˆ†é’Ÿè¶…æ—¶ä¸Šé™ï¼›åŠ¨æ€é€€é¿ã€è¿ç»­é”™è¯¯ç†”æ–­ã€‚
- å®Œæ•´ç»“æŸä¿¡å·ï¼šæ‰€æœ‰åˆ†æ”¯ï¼ˆå«å¼‚å¸¸ï¼‰éƒ½ä¼šè¾“å‡º `[DONE]`ï¼Œé¿å…å‰ç«¯æµæ‚¬æŒ‚ã€‚

### å‰ç«¯ä½¿ç”¨å»ºè®®
- æ¯ 5s è°ƒç”¨ `/api/loomi/heartbeat`ï¼›æ–­çº¿é‡è¿æˆ–é¡µé¢æ¢å¤å¯è°ƒç”¨ `/api/loomi/stream/{user_id}/{session_id}`ã€‚
- å¤„ç†äº‹ä»¶æ—¶è¯†åˆ« `payload.metadata.is_replay/is_realtime/hybrid_phase`ï¼Œå¹¶åœ¨æ”¶åˆ° `[DONE]` åå…³é—­ SSEã€‚

- å°ç»“
  - é€šè¿‡â€œæ™ºèƒ½åˆ¤å®š + å›æ”¾æ ‡è®° + åŠ¨æ€è½®è¯¢â€ï¼Œè¯¥æ–‡ä»¶ä¿è¯äº†æ–­çº¿åç”¨æˆ·èƒ½è¡¥é½ä¸¢å¤±çš„æµå¼äº‹ä»¶ï¼Œå¹¶å¹³æ»‘åˆ‡æ¢åˆ°å®æ—¶æ¥æ”¶ï¼Œä¸”å…·å¤‡å¯è§‚æµ‹æ€§ä¸è¶…æ—¶/ç†”æ–­ä¿æŠ¤ã€‚
