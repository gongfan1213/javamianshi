Redis **哨兵（Sentinel）** 是 Redis 提供的 **高可用解决方案**，它用来**监控 Redis 主从架构**，并在主节点故障时**自动完成故障转移**。

下面我会用 **概念 → 核心功能 → 工作原理 → 流程细节 → 配置要点 → 业务应用 → 常见问题** 逐步帮你完整梳理。

---

## ✅ **1. 什么是 Redis Sentinel？**

* **定义**：Sentinel 是一个运行在独立进程中的 Redis 组件，用于监控主从节点的健康状态，并在主节点不可用时，自动将一个从节点提升为新的主节点，同时通知客户端更新。
* **解决的问题**：

  * 单点故障（主节点宕机导致不可写）
  * 自动故障恢复（不需要人工干预）
  * 服务发现（客户端通过 Sentinel 获取当前主节点地址）

**一句话理解**：Sentinel 是 Redis 架构的“守护天使”，负责监控、报警、救援，还帮客户端指路。

---

## ✅ **2. Sentinel 的核心功能**

1. **监控（Monitoring）**
   Sentinel 会周期性发送 PING，监控主节点和从节点是否正常。
2. **通知（Notification）**
   当节点状态发生变化时，Sentinel 会通过发布订阅等机制通知管理员或其他应用。
3. **故障转移（Failover）**
   当主节点挂了，Sentinel 会把某个从节点升级为主节点，并让其他从节点改为复制新主。
4. **服务发现（Configuration Provider）**
   客户端可以向 Sentinel 查询当前的主节点地址，而不用自己维护。

---

## ✅ **3. Sentinel 的工作原理**

### **（1）基本概念**

* **主观下线（Subjective Down，SDOWN）**：某个 Sentinel 判断某个 Redis 实例不可达。
* **客观下线（Objective Down，ODOWN）**：多个 Sentinel 达成共识，认为某个实例挂了。
* **投票选举**：当主节点确实挂掉，需要选出一个 Sentinel 来执行故障转移。

---

### **（2）三个核心机制**

#### **① 健康检查**

* Sentinel 定期发送 `PING` 命令给主、从节点。
* 如果在 `down-after-milliseconds` 时间内没有收到有效回复，则标记为 **SDOWN**。
* 如果多数 Sentinel 都认为主节点 SDOWN → 进入 **ODOWN** 状态。

#### **② 故障转移**

* Sentinel 通过 **Raft 类似的投票机制**选举一个 Leader 来执行故障转移。
* Leader 执行以下动作：

  * 选出一个最佳的从节点作为新主节点（优先级、复制偏移量、延迟等因素）。
  * 向其他从节点发送 `replicaof` 新主的命令。
  * 更新 Sentinel 自身的配置。

#### **③ 客户端服务发现**

* 客户端连接 Sentinel，而不是直接连接 Redis 主节点。
* 当主节点切换后，Sentinel 会告诉客户端新的主节点 IP 和端口。

---

## ✅ **4. Sentinel 故障转移完整流程**

1. **Sentinel 检测到主节点 PING 超时 → 标记 SDOWN**。
2. **多个 Sentinel 交换信息 → 达成 ODOWN 共识**。
3. **Sentinel 开始选举 Leader**（基于投票，谁先提出谁更有可能当 Leader）。
4. **Leader Sentinel 执行故障转移**：

   * 选取一个最合适的从节点作为新主节点（判断条件：优先级最高、复制最完整、延迟最小）。
   * 发送命令给其他从节点，让它们复制新主节点。
5. **更新配置 & 通知客户端**。

---

## ✅ **5. Sentinel 的部署要求**

* **奇数个 Sentinel 节点**，至少 **3 个**（避免投票僵局）。
* Sentinel 节点最好和 Redis 实例分布在不同的服务器（避免同机风险）。
* 主节点 + 从节点 + 多个 Sentinel 组成高可用集群。

---

## ✅ **6. Sentinel 常用配置**

配置文件示例：

```conf
# Sentinel 运行端口（默认 26379）
port 26379

# 监控主节点：名字 mymaster，IP 和端口 127.0.0.1 6379，至少 2 个 Sentinel 同意才算 ODOWN
sentinel monitor mymaster 127.0.0.1 6379 2

# 主节点密码
sentinel auth-pass mymaster yourpassword

# 主观下线超时时间（毫秒）
sentinel down-after-milliseconds mymaster 5000

# 故障转移超时时间（毫秒）
sentinel failover-timeout mymaster 60000

# 从节点优先级、复制顺序影响选举
```

---

## ✅ **7. 业务场景应用**

### **（1）高可用架构**

* 一个 Master，多个 Slave，多个 Sentinel。
* 当 Master 挂掉，Sentinel 自动切换，客户端通过 Sentinel 获取最新主节点。

**示例架构：**

```
客户端 → Sentinel 集群（3台） → Redis 主从集群（1主2从）
```

### **（2）结合读写分离**

* 客户端通过 Sentinel 获取新主节点写请求。
* 读请求走从节点，但注意一致性问题。

### **（3）结合 Keepalived / VIP**

* Sentinel 切换后，VIP 指向新主节点，部分老应用不用改代码。

---

## ✅ **8. Sentinel 常见问题**

**Q1：Sentinel 自身是否是高可用的？**

* 是的，Sentinel 本身也可以多节点部署（推荐至少 3 个），通过投票共识保证。

**Q2：故障转移过程会丢数据吗？**

* 有可能！因为主从复制是异步的，主节点挂掉后，最新数据可能还没同步到从节点。
* 可用 `min-replicas-to-write` 降低风险，但不能完全避免。

**Q3：Sentinel 是否管理客户端连接？**

* 不会，Sentinel 只是“指路”，客户端要主动切换连接。
* Redis 官方推荐用客户端库支持 Sentinel（如 Jedis、Lettuce）。

**Q4：Sentinel 和 Cluster 有啥区别？**

* Sentinel 提供**高可用**，但不支持**数据分片**。
* Cluster 提供**高可用 + 水平扩展**。

---

如果你要面试，我可以帮你画一张 **Sentinel 架构图 + 故障转移流程图**，这样一眼就能记住重点。要我帮你画吗？
