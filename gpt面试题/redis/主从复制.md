Redis 主从复制是 Redis 提供的高可用和读写分离的核心机制之一。它可以让一个 Redis 实例（**主节点 Master**）的数据复制到一个或多个 Redis 实例（**从节点 Slave/Replica**），保证数据的冗余和扩展能力。

下面我会**从概念→工作原理→流程细节→常见问题→实际场景应用**，详细、通俗地帮你梳理。

---

## ✅ **1. 什么是 Redis 主从复制？**

* **定义**：主节点（Master）负责写操作，从节点（Slave）同步主节点的数据，通常只提供读操作。
* **目标**：

  * 数据冗余（防止单点故障）
  * 读写分离（提升性能）
  * 为后续的 **高可用（Sentinel）** 和 **分布式集群（Cluster）** 做基础。

**简单理解**：主节点是“老师”，从节点是“学生”，老师讲一遍，学生抄笔记，学生不会自己写，只会跟着老师。

---

## ✅ **2. 主从复制的工作原理**

复制分为**全量复制**和**部分复制**两种。

### **（1）第一次建立复制关系 → 全量复制**

当一个从节点第一次连接主节点时，通常会执行一次 **全量复制**，过程如下：

**步骤：**

1. **Slave 发送 `PSYNC` 或 `SYNC`** 命令请求复制。
2. **Master 执行 RDB 快照**，并生成一个 **复制缓冲区** 来记录此期间的新写命令。
3. Master 将 **RDB 文件** 发送给 Slave。
4. **Slave 清空旧数据，加载 RDB 文件**。
5. Master 将**复制缓冲区**的命令发送给 Slave（让 Slave 补齐在 RDB 生成过程中遗漏的写操作）。
6. **后续进入命令传播阶段**（实时复制）。

**特点**：

* 消耗大：需要生成 RDB、网络传输、加载文件。
* 在数据量大时会有卡顿风险。

---

### **（2）日常同步 → 命令传播**

全量复制完成后，进入**命令传播阶段**。

* 主节点会**异步**地把写命令通过网络发送给所有从节点。
* 从节点执行这些命令，保证数据一致。

---

### **（3）断线重连 → 部分复制**

如果网络闪断或从节点挂掉：

* Redis 使用 **复制偏移量** 和 **复制积压缓冲区** 来支持部分复制。
* 如果断开时间短，且缓冲区还保留着缺失的命令，就直接从上次的偏移量继续同步。
* 如果断开时间太长，缓冲区数据被覆盖，就只能**重新全量复制**（开销大）。

---

### **（4）核心机制**

* **复制偏移量**：每个节点记录同步到哪里了。
* **复制积压缓冲区**：Master 用一个环形缓冲区保存最近一段时间的写命令（默认 1MB，可调大）。
* **Run ID**：主节点的唯一标识，防止切换后出错。

---

## ✅ **3. 主从复制的关键配置**

常见配置项：

```conf
# 主节点配置
replica-serve-stale-data yes   # 从节点落后时是否响应请求
repl-backlog-size 1mb          # 复制积压缓冲区大小

# 从节点配置
replicaof <master-ip> <master-port>
masterauth <password>          # 如果主节点设置了密码
```

Redis 5.0 后建议用 **replicaof** 而不是 slaveof，官方逐步去掉 “slave” 这个词。

---

## ✅ **4. 主从复制的问题与优化**

### **（1）常见问题**

* **数据一致性问题**：复制是异步的，从节点会有延迟（通常毫秒级，但高峰期可能显著）。
* **主节点压力大**：全量复制时，RDB 生成和传输很耗 CPU 和网络。
* **网络问题**：断线时间长会导致频繁全量复制。

### **（2）优化方案**

* **增大复制缓冲区**，减少断线回退到全量复制。
* **避免频繁全量复制**：通过 `repl-diskless-sync yes` 启用无盘复制（直接通过 socket 发送 RDB，不落地磁盘）。
* **主从链**：从节点太多时，可以挂二级从节点，降低主节点压力。
* **Lazy Free**：在 Slave 清空数据时使用异步清理，减少阻塞。

---

## ✅ **5. 业务场景应用**

### **（1）读写分离**

* 主节点处理写请求，从节点处理读请求，缓解压力。
* 适用于读多写少的场景（电商商品详情页、用户查询）。

**注意**：因为复制是异步的，读到的数据可能是旧的（**最终一致性**）。

* 如果读写一致性要求高，可以：

  * 读主节点（增加压力）
  * 延迟队列 + 缓存预热策略

---

### **（2）高可用**

* 结合 **Redis Sentinel** 实现主从自动切换。
* 当主节点挂掉，Sentinel 会把一个从节点提升为新的主节点。

---

### **（3）防止数据丢失**

* 开启 `min-replicas-to-write` 和 `min-replicas-max-lag`：

  * 只有足够的从节点、且延迟不大时，主节点才执行写操作。
* 避免主节点“自嗨”写入导致数据丢失。

---

## ✅ **6. 面试常见问题**

**Q1：Redis 主从复制默认是同步还是异步？**

* **异步复制**，主节点不等待从节点确认就返回成功。
* Redis 6.0 引入 `WAIT` 命令，可以实现“半同步复制”。

**Q2：全量复制和部分复制的区别？**

* 全量复制：重新传输整个 RDB + 命令传播，开销大。
* 部分复制：基于偏移量和缓冲区补数据，开销小。

**Q3：为什么主从复制不保证强一致性？**

* 因为异步复制，主节点写成功后即返回，可能从节点还没同步到。

**Q4：断线重连时怎么避免全量复制？**

* 依赖复制偏移量和复制积压缓冲区。

**Q5：主从复制在电商场景怎么用？**

* 读请求走从库，写请求走主库。
* 结合 Sentinel 实现高可用。

---

⚠️ 如果你想要，我可以帮你画一张\*\*“Redis 主从复制完整流程图”\*\*，让你记忆更牢固。要不要我帮你画？
