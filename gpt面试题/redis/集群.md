Redis **集群（Cluster）**是 Redis 官方提供的**分布式解决方案**，用来解决**单机容量限制**、**高可用性**和**负载均衡**的问题。在面试中，这个是必考点，因为它结合了数据分片、故障转移、复制、通信协议等多个核心知识点。

我会从 **为什么需要集群 → 基本架构 → 数据分片 → 通信机制 → 故障转移 → 优缺点 → 业务场景 → 高频面试题** 详细帮你复习，并结合图示逻辑解释。

---

## ✅ **1. 为什么需要 Redis 集群？**

* **单机问题**：

  * **容量有限**：Redis 单机最多支撑几十 GB 内存，业务增长后容易瓶颈。
  * **并发瓶颈**：单线程处理请求，CPU 核心利用有限。
  * **高可用性差**：主从复制可以做读写分离，但主节点挂了仍需人工干预。
* **集群解决方案**：

  * **数据分片（水平扩展）**：把数据分布到多个节点，突破单机内存限制。
  * **高可用性**：自动故障转移，节点挂掉不影响集群服务。
  * **负载均衡**：多个主节点并行处理请求，提升吞吐。

---

## ✅ **2. Redis 集群架构概览**

* **最少 6 个节点**（官方建议）：3 个 Master + 3 个 Slave。
* **每个 Master 负责一部分数据槽（hash slots）**。
* **每个 Master 配有至少一个 Slave**，保证高可用。
* **无中心节点**，所有节点互相通信（Gossip 协议）。

示例：

```
Master1 —— Slave1
Master2 —— Slave2
Master3 —— Slave3
```

---

## ✅ **3. 数据分片（核心机制）**

Redis 集群采用 **哈希槽（Hash Slot）分片机制**：

* **总共 16384 个槽（slot）**。
* 每个 key 通过 `CRC16(key) % 16384` 计算槽号。
* 每个 Master 负责一部分槽，比如：

  * Master1：0-5460
  * Master2：5461-10922
  * Master3：10923-16383
* **请求路由**：

  * 客户端根据 key 计算槽号，直接找到对应的 Master。
  * 如果请求发错节点，Redis 返回 `MOVED` 重定向信息。

**好处**：

* 插槽数量固定，迁移数据时只需要迁移对应槽的数据，迁移更高效。

---

## ✅ **4. 节点间通信协议**

Redis 集群节点之间通过 **Gossip 协议** 进行信息交换，保持集群状态一致。

* **端口**：每个节点有两个端口：

  * Redis 服务端口（如 6379）
  * 集群通信端口 = 服务端口 + 10000（如 16379）
* **消息类型**：

  * `PING`、`PONG`：心跳检测。
  * `MEET`：加入集群。
  * `FAIL`：节点故障广播。

---

## ✅ **5. 高可用与故障转移**

* **故障检测**：

  * 每个节点定期 `PING` 其他节点。
  * 如果半数以上 Master 认为某节点失联 → 标记为 **FAIL**。
* **故障转移**：

  * Slave 自动升级为 Master。
  * 重新分配槽。
* **选举规则**（类似哨兵）：

  * 优先选择复制偏移量最大的 Slave。
  * 如果多个 Slave 竞争，通过投票选举。

---

## ✅ **6. 集群读写规则**

* **写操作**：只能发给 Master。
* **读操作**：

  * 默认也走 Master。
  * 如果配置 `replica-read-only yes` 并且客户端支持，可以读 Slave。
* **多键操作限制**：

  * **跨槽事务不支持**。
  * 如果多键在同一槽，可以支持事务（通过哈希标签 `{}`）。

---

## ✅ **7. 集群的优缺点**

### **优点**

✔ 解决单机内存限制，支持水平扩展。
✔ 自动分片，客户端直连，无需中间代理（相比 Twemproxy）。
✔ 高可用，自动故障转移。

### **缺点**

✘ **不支持多键跨槽事务**（只能使用哈希标签）。
✘ **不支持多数据库**（只有 `db0`）。
✘ **运维复杂度高**，节点数量多。
✘ **集群扩容/缩容需要数据迁移**，会影响性能。

---

## ✅ **8. 业务场景选择**

* **适合**：

  * 数据量很大（>10GB），单机撑不住。
  * 高并发访问，读写压力大。
* **不适合**：

  * 强事务场景（需要跨键事务）。
  * 数据量小、运维成本要求低。

---

## ✅ **9. 高频面试问题**

**Q1：Redis 集群为什么是 16384 个槽？**

* 槽越多，迁移越细粒度，但会增加管理开销。
* 16384 = 2^14，兼顾性能和迁移开销。
* Redis Cluster 协议规定 slot 数量不能改。

**Q2：客户端如何知道 key 对应的节点？**

* 通过计算槽号（`CRC16(key) % 16384`）或缓存 `MOVED` 重定向信息。

**Q3：集群模式支持 pipeline 吗？**

* 支持，但需要保证所有 key 在同一槽，否则会 `CROSSSLOT` 错误。

**Q4：集群中一个 Master 挂了会怎么样？**

* 对应的 Slave 会自动升级为 Master。
* 其他节点广播新的拓扑信息。

---

要不要我帮你画一张 **Redis 集群工作原理图（数据分片 + Master-Slave + Gossip 通信）**，并附一张**槽迁移流程图**？
这些图在面试白板题上特别加分。
