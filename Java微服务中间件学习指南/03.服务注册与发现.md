# 服务注册与发现

## 🎯 什么是服务注册与发现？

服务注册与发现是微服务架构中的核心组件，它解决了"服务在哪里"的问题。

### 1. 基本概念
```
服务注册：服务启动时向注册中心报告自己的位置
服务发现：服务调用时从注册中心查找目标服务的位置
```

**简单理解：**
- 就像手机通讯录，保存朋友的联系方式
- 服务启动时"登记"自己的地址
- 其他服务需要调用时"查找"目标服务的地址

### 2. 为什么需要服务注册与发现？

#### 没有服务注册与发现的问题
```
❌ 问题场景：
用户服务需要调用订单服务
订单服务地址：192.168.1.100:8080

如果订单服务换了地址，需要：
1. 修改用户服务的配置
2. 重启用户服务
3. 所有调用订单服务的服务都要修改
```

#### 有了服务注册与发现的好处
```
✅ 解决方案：
1. 订单服务启动时自动注册到注册中心
2. 用户服务通过服务名查找订单服务
3. 订单服务地址变化时，用户服务自动感知
4. 无需重启，无需修改配置
```

## 🏗️ 服务注册与发现架构

### 1. 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    服务注册中心                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  用户服务   │  │  订单服务   │  │  商品服务   │        │
│  │ 192.168.1.1│  │ 192.168.1.2│  │ 192.168.1.3│        │
│  │    8081    │  │    8082    │  │    8083    │        │
│  │    UP      │  │    UP      │  │    UP      │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  用户服务   │ │  订单服务   │ │  商品服务   │
│  (客户端)   │ │  (客户端)   │ │  (客户端)   │
└─────────────┘ └─────────────┘ └─────────────┘
```

### 2. 工作流程
```
1. 服务启动 → 向注册中心注册 → 注册中心保存服务信息
2. 服务调用 → 从注册中心查找 → 获取目标服务地址
3. 服务调用 → 直接调用目标服务 → 返回结果
4. 服务下线 → 注册中心感知 → 从服务列表中移除
```

## 🔧 主流注册中心对比

### 1. 功能对比表
| 特性 | Eureka | Consul | Nacos | ZooKeeper |
|------|--------|--------|-------|-----------|
| 服务注册 | ✅ | ✅ | ✅ | ✅ |
| 服务发现 | ✅ | ✅ | ✅ | ✅ |
| 配置管理 | ❌ | ✅ | ✅ | ❌ |
| 健康检查 | ✅ | ✅ | ✅ | ✅ |
| 多数据中心 | ❌ | ✅ | ✅ | ❌ |
| 配置推送 | ❌ | ✅ | ✅ | ❌ |
| 易用性 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |

### 2. 选择建议
- **Eureka**：Spring Cloud集成好，简单易用
- **Consul**：功能丰富，支持多数据中心
- **Nacos**：阿里巴巴开源，功能最全面
- **ZooKeeper**：成熟稳定，但功能相对简单

## 🚀 Nacos 服务注册与发现

### 1. 为什么选择Nacos？
- **功能全面**：服务注册、配置管理、动态DNS
- **易用性好**：提供Web控制台，操作简单
- **性能优秀**：支持大规模服务注册
- **生态丰富**：Spring Cloud Alibaba集成

### 2. Nacos安装和启动
```bash
# 下载Nacos
wget https://github.com/alibaba/nacos/releases/download/2.2.3/nacos-server-2.2.3.tar.gz

# 解压
tar -xzf nacos-server-2.2.3.tar.gz
cd nacos

# 启动（单机模式）
bin/startup.sh -m standalone

# 访问控制台
http://localhost:8848/nacos
# 默认账号密码：nacos/nacos
```

### 3. Maven依赖配置
```xml
<!-- 父POM中的依赖管理 -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2021.0.5.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<!-- 服务模块中的依赖 -->
<dependencies>
    <!-- Nacos服务发现 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    
    <!-- Nacos配置中心（可选） -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
</dependencies>
```

## 💻 服务注册实现

### 1. 服务提供者配置
```yaml
# application.yml
spring:
  application:
    name: user-service  # 服务名称
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos服务器地址
        namespace: public            # 命名空间
        group: DEFAULT_GROUP         # 分组
        cluster-name: DEFAULT        # 集群名称
        username: nacos              # 用户名
        password: nacos              # 密码
        # 可选配置
        enabled: true                # 启用服务发现
        register-enabled: true       # 启用服务注册
        ephemeral: true             # 临时实例（默认）
        weight: 1                    # 权重
        metadata:                    # 元数据
          version: 1.0
          region: us-east-1
```

### 2. 服务提供者启动类
```java
package com.example.userservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient  // 启用服务发现
public class UserServiceApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

### 3. 服务提供者控制器
```java
package com.example.userservice.controller;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/user")
public class UserController {
    
    @Value("${spring.application.name}")
    private String serviceName;
    
    @Value("${server.port}")
    private String serverPort;
    
    private final DiscoveryClient discoveryClient;
    
    public UserController(DiscoveryClient discoveryClient) {
        this.discoveryClient = discoveryClient;
    }
    
    @GetMapping("/info/{id}")
    public String getUserInfo(@PathVariable String id) {
        return String.format("用户信息: %s, 服务: %s, 端口: %s", id, serviceName, serverPort);
    }
    
    @GetMapping("/discovery")
    public List<ServiceInstance> getDiscoveryInfo() {
        return discoveryClient.getInstances(serviceName);
    }
    
    @GetMapping("/health")
    public String health() {
        return "用户服务运行正常";
    }
}
```

### 4. 服务提供者启动
```bash
# 启动用户服务
mvn spring-boot:run

# 查看日志，确认注册成功
# 访问Nacos控制台，查看服务列表
```

## 🔍 服务发现实现

### 1. 服务消费者配置
```yaml
# application.yml
spring:
  application:
    name: order-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public
        group: DEFAULT_GROUP
        cluster-name: DEFAULT
        username: nacos
        password: nacos
```

### 2. 服务消费者启动类
```java
package com.example.orderservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClient;

@SpringBootApplication
@EnableDiscoveryClient  // 启用服务发现
@EnableFeignClient      // 启用Feign客户端
public class OrderServiceApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}
```

### 3. 使用DiscoveryClient发现服务
```java
package com.example.orderservice.service;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@Service
public class UserServiceClient {
    
    private final DiscoveryClient discoveryClient;
    private final RestTemplate restTemplate;
    
    public UserServiceClient(DiscoveryClient discoveryClient, RestTemplate restTemplate) {
        this.discoveryClient = discoveryClient;
        this.restTemplate = restTemplate;
    }
    
    public String getUserInfo(String userId) {
        // 通过服务名查找服务实例
        List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
        
        if (instances.isEmpty()) {
            throw new RuntimeException("用户服务不可用");
        }
        
        // 选择第一个可用实例（实际项目中应该实现负载均衡）
        ServiceInstance instance = instances.get(0);
        String url = String.format("http://%s:%s/user/info/%s", 
                                 instance.getHost(), instance.getPort(), userId);
        
        // 调用用户服务
        return restTemplate.getForObject(url, String.class);
    }
    
    public List<ServiceInstance> getServiceInstances() {
        return discoveryClient.getInstances("user-service");
    }
}
```

### 4. 使用OpenFeign调用服务
```java
package com.example.orderservice.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(name = "user-service")  // 指定服务名
public interface UserFeignClient {
    
    @GetMapping("/user/info/{id}")
    String getUserInfo(@PathVariable("id") String id);
    
    @GetMapping("/user/health")
    String health();
}
```

### 5. 服务消费者控制器
```java
package com.example.orderservice.controller;

import com.example.orderservice.client.UserFeignClient;
import com.example.orderservice.service.UserServiceClient;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/order")
public class OrderController {
    
    private final UserServiceClient userServiceClient;
    private final UserFeignClient userFeignClient;
    
    public OrderController(UserServiceClient userServiceClient, UserFeignClient userFeignClient) {
        this.userServiceClient = userServiceClient;
        this.userFeignClient = userFeignClient;
    }
    
    @GetMapping("/create/{userId}")
    public String createOrder(@PathVariable String userId) {
        // 方式1：使用DiscoveryClient
        String userInfo1 = userServiceClient.getUserInfo(userId);
        
        // 方式2：使用OpenFeign
        String userInfo2 = userFeignClient.getUserInfo(userId);
        
        return String.format("订单创建成功，用户信息1: %s, 用户信息2: %s", userInfo1, userInfo2);
    }
    
    @GetMapping("/services")
    public String getServices() {
        return userServiceClient.getServiceInstances().toString();
    }
}
```

### 6. 配置RestTemplate
```java
package com.example.orderservice.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // 启用负载均衡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

## 🔄 服务健康检查

### 1. 健康检查机制
```java
package com.example.userservice.health;

import org.springframework.boot.actuator.health.Health;
import org.springframework.boot.actuator.health.HealthIndicator;
import org.springframework.stereotype.Component;

@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // 自定义健康检查逻辑
        try {
            // 检查数据库连接
            // 检查外部服务
            // 检查系统资源
            
            return Health.up()
                    .withDetail("database", "connected")
                    .withDetail("memory", "normal")
                    .build();
        } catch (Exception e) {
            return Health.down()
                    .withDetail("error", e.getMessage())
                    .build();
        }
    }
}
```

### 2. 健康检查配置
```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,info,discovery
  endpoint:
    health:
      show-details: always
      show-components: always
  health:
    defaults:
      enabled: true
```

## 🚨 常见问题和解决方案

### 1. 服务注册失败
**问题：** 服务无法注册到Nacos
**解决方案：**
```yaml
# 检查配置
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # 确认Nacos地址
        enabled: true                # 确认启用服务发现
        register-enabled: true       # 确认启用服务注册

# 检查网络连接
ping localhost:8848
telnet localhost 8848

# 检查Nacos服务状态
curl http://localhost:8848/nacos/v1/ns/operator/metrics
```

### 2. 服务发现失败
**问题：** 无法发现目标服务
**解决方案：**
```java
// 检查服务名是否一致
@FeignClient(name = "user-service")  // 确保服务名正确

// 检查命名空间和分组
spring:
  cloud:
    nacos:
      discovery:
        namespace: public      # 确认命名空间
        group: DEFAULT_GROUP  # 确认分组

// 使用DiscoveryClient调试
List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
System.out.println("发现的服务实例: " + instances);
```

### 3. 服务调用超时
**问题：** 服务间调用超时
**解决方案：**
```yaml
# 配置超时时间
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000

# 配置重试
ribbon:
  ConnectTimeout: 5000
  ReadTimeout: 5000
  MaxAutoRetries: 1
  MaxAutoRetriesNextServer: 1
```

## 💡 最佳实践

### 1. 服务命名规范
```
✅ 推荐命名：
- user-service
- order-service
- payment-service
- inventory-service

❌ 避免命名：
- UserService
- user_service
- userService
```

### 2. 服务版本管理
```yaml
# 使用元数据管理版本
spring:
  cloud:
    nacos:
      discovery:
        metadata:
          version: 1.0.0
          environment: production
          region: us-east-1
```

### 3. 服务分组管理
```yaml
# 按环境分组
spring:
  cloud:
    nacos:
      discovery:
        group: ${spring.profiles.active}

# 按业务分组
spring:
  cloud:
    nacos:
      discovery:
        group: business-group
```

### 4. 服务健康检查
```java
// 实现自定义健康检查
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // 检查数据库连接
        // 检查关键业务指标
        return Health.up().build();
    }
}
```

## 🔗 下一步学习

- [配置中心](./04.配置中心.md) - 学习配置管理
- [服务网关](./05.服务网关.md) - 学习网关服务
- [负载均衡](./06.负载均衡.md) - 学习负载均衡

---

**记住：服务注册与发现是微服务的基础，掌握它就能实现服务的动态治理！** 🎯
