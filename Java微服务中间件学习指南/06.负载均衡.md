# è´Ÿè½½å‡è¡¡

## ğŸ¯ ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡ï¼Ÿ

è´Ÿè½½å‡è¡¡æ˜¯å°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªæœåŠ¡å®ä¾‹çš„æŠ€æœ¯ï¼Œç›®çš„æ˜¯æé«˜ç³»ç»Ÿçš„å¯ç”¨æ€§ã€æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚

### 1. åŸºæœ¬æ¦‚å¿µ
```
è´Ÿè½½å‡è¡¡ = è¯·æ±‚åˆ†å‘ + å¥åº·æ£€æŸ¥ + æ•…éšœè½¬ç§» + æ€§èƒ½ä¼˜åŒ–
```

**ç®€å•ç†è§£ï¼š**
- å°±åƒé“¶è¡Œçš„å¤šçª—å£æœåŠ¡ï¼Œå®¢æˆ·å¯ä»¥åˆ°ä»»æ„çª—å£åŠç†ä¸šåŠ¡
- å°†å¤§é‡è¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªæœåŠ¡å™¨ä¸Š
- é¿å…å•ä¸ªæœåŠ¡å™¨è¿‡è½½
- æé«˜ç³»ç»Ÿçš„æ•´ä½“å¤„ç†èƒ½åŠ›

### 2. ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡ï¼Ÿ

#### æ²¡æœ‰è´Ÿè½½å‡è¡¡çš„é—®é¢˜
```
âŒ é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·æœåŠ¡åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼š192.168.1.100:8081
æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°è¿™ä¸€ä¸ªå®ä¾‹ä¸Š

é—®é¢˜ï¼š
1. å•ç‚¹æ•…éšœï¼šå®ä¾‹æŒ‚äº†ï¼Œæ•´ä¸ªæœåŠ¡ä¸å¯ç”¨
2. æ€§èƒ½ç“¶é¢ˆï¼šè¯·æ±‚é‡å¤§æ—¶ï¼Œå•ä¸ªå®ä¾‹å¤„ç†ä¸è¿‡æ¥
3. æ— æ³•æ‰©å±•ï¼šæ— æ³•åŠ¨æ€å¢åŠ æœåŠ¡å®ä¾‹
```

#### æœ‰äº†è´Ÿè½½å‡è¡¡çš„å¥½å¤„
```
âœ… è§£å†³æ–¹æ¡ˆï¼š
1. é«˜å¯ç”¨æ€§ï¼šä¸€ä¸ªå®ä¾‹æŒ‚äº†ï¼Œå…¶ä»–å®ä¾‹ç»§ç»­æœåŠ¡
2. é«˜æ€§èƒ½ï¼šè¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªå®ä¾‹ï¼Œæé«˜å¤„ç†èƒ½åŠ›
3. å¯æ‰©å±•æ€§ï¼šå¯ä»¥åŠ¨æ€å¢åŠ æˆ–å‡å°‘å®ä¾‹
4. æ•…éšœéš”ç¦»ï¼šå•ä¸ªå®ä¾‹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
```

## ğŸ—ï¸ è´Ÿè½½å‡è¡¡æ¶æ„

### 1. æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´Ÿè½½å‡è¡¡å™¨                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è¯·æ±‚æ¥æ”¶   â”‚  â”‚  è´Ÿè½½ç®—æ³•   â”‚  â”‚  å¥åº·æ£€æŸ¥   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹1      â”‚ â”‚  å®ä¾‹2      â”‚ â”‚  å®ä¾‹3      â”‚
â”‚ 192.168.1.1 â”‚ â”‚ 192.168.1.2 â”‚ â”‚ 192.168.1.3 â”‚
â”‚    8081     â”‚ â”‚    8081     â”‚ â”‚    8081     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å·¥ä½œæµç¨‹
```
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨
2. è´Ÿè½½å‡è¡¡å™¨æ¥æ”¶è¯·æ±‚ â†’ é€‰æ‹©ç›®æ ‡å®ä¾‹
3. è½¬å‘è¯·æ±‚ â†’ ç›®æ ‡å®ä¾‹å¤„ç†
4. å®ä¾‹è¿”å›å“åº” â†’ è´Ÿè½½å‡è¡¡å™¨
5. è´Ÿè½½å‡è¡¡å™¨è¿”å›å“åº” â†’ å®¢æˆ·ç«¯
```

## ğŸ”§ è´Ÿè½½å‡è¡¡åˆ†ç±»

### 1. æŒ‰ä½ç½®åˆ†ç±»

#### å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è´Ÿè½½å‡è¡¡   â”‚  â”‚  æœåŠ¡å‘ç°   â”‚  â”‚  è¯·æ±‚å‘é€   â”‚        â”‚
â”‚  â”‚   ç®—æ³•      â”‚  â”‚   å®¢æˆ·ç«¯    â”‚  â”‚   å®¢æˆ·ç«¯    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹1      â”‚ â”‚  å®ä¾‹2      â”‚ â”‚  å®ä¾‹3      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹ï¼š**
- å®¢æˆ·ç«¯è´Ÿè´£é€‰æ‹©æœåŠ¡å®ä¾‹
- å‡å°‘ç½‘ç»œè·³è½¬
- é€‚åˆå¾®æœåŠ¡æ¶æ„

#### æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´Ÿè½½å‡è¡¡å™¨                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è¯·æ±‚æ¥æ”¶   â”‚  â”‚  è´Ÿè½½ç®—æ³•   â”‚  â”‚  è¯·æ±‚è½¬å‘   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹1      â”‚ â”‚  å®ä¾‹2      â”‚ â”‚  å®ä¾‹3      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹ï¼š**
- ä¸“é—¨çš„è´Ÿè½½å‡è¡¡å™¨
- é›†ä¸­ç®¡ç†
- é€‚åˆä¼ ç»Ÿæ¶æ„

### 2. æŒ‰ç®—æ³•åˆ†ç±»

#### è½®è¯¢ï¼ˆRound Robinï¼‰
```
è¯·æ±‚1 â†’ å®ä¾‹1
è¯·æ±‚2 â†’ å®ä¾‹2
è¯·æ±‚3 â†’ å®ä¾‹3
è¯·æ±‚4 â†’ å®ä¾‹1
è¯·æ±‚5 â†’ å®ä¾‹2
...
```

**ç‰¹ç‚¹ï¼š**
- ç®€å•å…¬å¹³
- é€‚åˆå®ä¾‹æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯
- ä¸è€ƒè™‘å®ä¾‹è´Ÿè½½æƒ…å†µ

#### éšæœºï¼ˆRandomï¼‰
```
è¯·æ±‚1 â†’ éšæœºé€‰æ‹©å®ä¾‹
è¯·æ±‚2 â†’ éšæœºé€‰æ‹©å®ä¾‹
è¯·æ±‚3 â†’ éšæœºé€‰æ‹©å®ä¾‹
...
```

**ç‰¹ç‚¹ï¼š**
- å®ç°ç®€å•
- é€‚åˆå®ä¾‹æ€§èƒ½ç›¸è¿‘çš„åœºæ™¯
- è´Ÿè½½åˆ†å¸ƒç›¸å¯¹å‡åŒ€

#### åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰
```
å®ä¾‹1æƒé‡=3ï¼Œå®ä¾‹2æƒé‡=2ï¼Œå®ä¾‹3æƒé‡=1

è¯·æ±‚1-3 â†’ å®ä¾‹1
è¯·æ±‚4-5 â†’ å®ä¾‹2
è¯·æ±‚6 â†’ å®ä¾‹3
è¯·æ±‚7-9 â†’ å®ä¾‹1
...
```

**ç‰¹ç‚¹ï¼š**
- è€ƒè™‘å®ä¾‹æ€§èƒ½å·®å¼‚
- é«˜æ€§èƒ½å®ä¾‹å¤„ç†æ›´å¤šè¯·æ±‚
- é€‚åˆå®ä¾‹æ€§èƒ½å·®å¼‚è¾ƒå¤§çš„åœºæ™¯

#### æœ€å°‘è¿æ¥ï¼ˆLeast Connectionsï¼‰
```
è¯·æ±‚1 â†’ é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„å®ä¾‹
è¯·æ±‚2 â†’ é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„å®ä¾‹
...
```

**ç‰¹ç‚¹ï¼š**
- è€ƒè™‘å®ä¾‹å½“å‰è´Ÿè½½
- é€‚åˆé•¿è¿æ¥åœºæ™¯
- éœ€è¦å®æ—¶ç»Ÿè®¡è¿æ¥æ•°

#### å“åº”æ—¶é—´ï¼ˆResponse Timeï¼‰
```
è¯·æ±‚1 â†’ é€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„å®ä¾‹
è¯·æ±‚2 â†’ é€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„å®ä¾‹
...
```

**ç‰¹ç‚¹ï¼š**
- è€ƒè™‘å®ä¾‹æ€§èƒ½
- é€‚åˆå¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„åœºæ™¯
- éœ€è¦å®æ—¶ç›‘æ§å“åº”æ—¶é—´

## ğŸš€ Spring Cloud è´Ÿè½½å‡è¡¡

### 1. è´Ÿè½½å‡è¡¡ç»„ä»¶

#### Ribbonï¼ˆå·²åœæ­¢ç»´æŠ¤ï¼‰
```xml
<!-- æ—§ç‰ˆæœ¬ä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
</dependency>
```

#### Spring Cloud LoadBalancerï¼ˆæ¨èï¼‰
```xml
<!-- æ–°ç‰ˆæœ¬ä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

### 2. è‡ªåŠ¨é…ç½®
```java
package com.example.userservice.config;

import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class LoadBalancerConfig {
    
    @Bean
    @LoadBalanced  // å¯ç”¨è´Ÿè½½å‡è¡¡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

### 3. è´Ÿè½½å‡è¡¡ç­–ç•¥é…ç½®
```yaml
# application.yml
spring:
  cloud:
    loadbalancer:
      ribbon:
        enabled: false  # ç¦ç”¨Ribbon
      configurations:
        default:
          load-balancer-class-name: org.springframework.cloud.loadbalancer.core.RandomLoadBalancer
        user-service:
          load-balancer-class-name: org.springframework.cloud.loadbalancer.core.RoundRobinLoadBalancer
```

## ğŸ’» è´Ÿè½½å‡è¡¡å®ç°

### 1. ä½¿ç”¨RestTemplate
```java
package com.example.orderservice.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@Service
public class UserServiceClient {
    
    @Autowired
    @LoadBalanced
    private RestTemplate restTemplate;
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    // ä½¿ç”¨è´Ÿè½½å‡è¡¡çš„RestTemplate
    public String getUserInfoWithLoadBalancer(String userId) {
        // ç›´æ¥ä½¿ç”¨æœåŠ¡åï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šè‡ªåŠ¨é€‰æ‹©å®ä¾‹
        String url = "http://user-service/user/info/" + userId;
        return restTemplate.getForObject(url, String.class);
    }
    
    // æ‰‹åŠ¨å®ç°è´Ÿè½½å‡è¡¡
    public String getUserInfoManual(String userId) {
        List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
        
        if (instances.isEmpty()) {
            throw new RuntimeException("ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨");
        }
        
        // ç®€å•çš„è½®è¯¢ç®—æ³•
        ServiceInstance instance = instances.get(0); // è¿™é‡Œåº”è¯¥å®ç°è½®è¯¢é€»è¾‘
        String url = String.format("http://%s:%s/user/info/%s", 
                                 instance.getHost(), instance.getPort(), userId);
        
        return restTemplate.getForObject(url, String.class);
    }
}
```

### 2. ä½¿ç”¨OpenFeign
```java
package com.example.orderservice.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(name = "user-service")  // è‡ªåŠ¨å¯ç”¨è´Ÿè½½å‡è¡¡
public interface UserFeignClient {
    
    @GetMapping("/user/info/{id}")
    String getUserInfo(@PathVariable("id") String id);
    
    @GetMapping("/user/health")
    String health();
}
```

### 3. è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥
```java
package com.example.orderservice.config;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.loadbalancer.annotation.LoadBalancerClient;
import org.springframework.cloud.loadbalancer.core.RandomLoadBalancer;
import org.springframework.cloud.loadbalancer.core.ReactorLoadBalancer;
import org.springframework.cloud.loadbalancer.core.ServiceInstanceListSupplier;
import org.springframework.cloud.loadbalancer.support.LoadBalancerClientFactory;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.env.Environment;

@Configuration
@LoadBalancerClient(value = "user-service", configuration = CustomLoadBalancerConfig.class)
public class CustomLoadBalancerConfig {
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> randomLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        return new RandomLoadBalancer(loadBalancerClientFactory
                .getLazyProvider(name, ServiceInstanceListSupplier.class),
                name);
    }
}
```

## ğŸ”„ è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°

### 1. è½®è¯¢ç®—æ³•
```java
package com.example.orderservice.loadbalancer;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

@Component
public class RoundRobinLoadBalancer {
    
    private final AtomicInteger position = new AtomicInteger(0);
    
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        int pos = Math.abs(position.incrementAndGet() % instances.size());
        return instances.get(pos);
    }
}
```

### 2. éšæœºç®—æ³•
```java
package com.example.orderservice.loadbalancer;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Random;

@Component
public class RandomLoadBalancer {
    
    private final Random random = new Random();
    
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        int index = random.nextInt(instances.size());
        return instances.get(index);
    }
}
```

### 3. åŠ æƒè½®è¯¢ç®—æ³•
```java
package com.example.orderservice.loadbalancer;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.concurrent.atomic.AtomicInteger;

@Component
public class WeightedRoundRobinLoadBalancer {
    
    private final AtomicInteger position = new AtomicInteger(0);
    
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        // è®¡ç®—æ€»æƒé‡
        int totalWeight = instances.stream()
                .mapToInt(instance -> getWeight(instance))
                .sum();
        
        if (totalWeight <= 0) {
            return instances.get(0);
        }
        
        // åŠ æƒè½®è¯¢
        int currentWeight = position.incrementAndGet() % totalWeight;
        for (ServiceInstance instance : instances) {
            int weight = getWeight(instance);
            if (currentWeight < weight) {
                return instance;
            }
            currentWeight -= weight;
        }
        
        return instances.get(0);
    }
    
    private int getWeight(ServiceInstance instance) {
        // ä»å…ƒæ•°æ®ä¸­è·å–æƒé‡ï¼Œé»˜è®¤ä¸º1
        String weightStr = instance.getMetadata().get("weight");
        if (weightStr != null) {
            try {
                return Integer.parseInt(weightStr);
            } catch (NumberFormatException e) {
                // å¿½ç•¥å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤æƒé‡
            }
        }
        return 1;
    }
}
```

### 4. æœ€å°‘è¿æ¥ç®—æ³•
```java
package com.example.orderservice.loadbalancer;

import org.springframework.cloud.client.ServiceInstance;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;

@Component
public class LeastConnectionsLoadBalancer {
    
    // è®°å½•æ¯ä¸ªå®ä¾‹çš„è¿æ¥æ•°
    private final ConcurrentHashMap<String, AtomicInteger> connectionCounts = new ConcurrentHashMap<>();
    
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        
        ServiceInstance selectedInstance = null;
        int minConnections = Integer.MAX_VALUE;
        
        for (ServiceInstance instance : instances) {
            String instanceId = getInstanceId(instance);
            AtomicInteger count = connectionCounts.computeIfAbsent(instanceId, k -> new AtomicInteger(0));
            
            if (count.get() < minConnections) {
                minConnections = count.get();
                selectedInstance = instance;
            }
        }
        
        if (selectedInstance != null) {
            String instanceId = getInstanceId(selectedInstance);
            connectionCounts.computeIfAbsent(instanceId, k -> new AtomicInteger(0)).incrementAndGet();
        }
        
        return selectedInstance;
    }
    
    public void releaseConnection(ServiceInstance instance) {
        String instanceId = getInstanceId(instance);
        AtomicInteger count = connectionCounts.get(instanceId);
        if (count != null) {
            count.decrementAndGet();
        }
    }
    
    private String getInstanceId(ServiceInstance instance) {
        return instance.getHost() + ":" + instance.getPort();
    }
}
```

## ğŸš¦ å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»

### 1. å¥åº·æ£€æŸ¥é…ç½®
```yaml
# application.yml
spring:
  cloud:
    loadbalancer:
      health-check:
        initial-delay: 0
        interval: 25s
        timeout: 5s
        retry-count: 3
```

### 2. å¥åº·æ£€æŸ¥å®ç°
```java
package com.example.orderservice.health;

import org.springframework.boot.actuator.health.Health;
import org.springframework.boot.actuator.health.HealthIndicator;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

@Component
public class ServiceHealthIndicator implements HealthIndicator {
    
    private final DiscoveryClient discoveryClient;
    private final RestTemplate restTemplate;
    
    public ServiceHealthIndicator(DiscoveryClient discoveryClient, RestTemplate restTemplate) {
        this.discoveryClient = discoveryClient;
        this.restTemplate = restTemplate;
    }
    
    @Override
    public Health health() {
        try {
            // æ£€æŸ¥ç”¨æˆ·æœåŠ¡å¥åº·çŠ¶æ€
            List<ServiceInstance> userInstances = discoveryClient.getInstances("user-service");
            if (userInstances.isEmpty()) {
                return Health.down()
                        .withDetail("user-service", "no instances available")
                        .build();
            }
            
            // æ£€æŸ¥è®¢å•æœåŠ¡å¥åº·çŠ¶æ€
            List<ServiceInstance> orderInstances = discoveryClient.getInstances("order-service");
            if (orderInstances.isEmpty()) {
                return Health.down()
                        .withDetail("order-service", "no instances available")
                        .build();
            }
            
            return Health.up()
                    .withDetail("user-service", userInstances.size() + " instances")
                    .withDetail("order-service", orderInstances.size() + " instances")
                    .build();
            
        } catch (Exception e) {
            return Health.down()
                    .withDetail("error", e.getMessage())
                    .build();
        }
    }
}
```

### 3. æ•…éšœè½¬ç§»å®ç°
```java
package com.example.orderservice.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.discovery.DiscoveryClient;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.List;

@Service
public class FaultTolerantUserServiceClient {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    @Autowired
    private RestTemplate restTemplate;
    
    public String getUserInfoWithFallback(String userId) {
        List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
        
        if (instances.isEmpty()) {
            throw new RuntimeException("ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨");
        }
        
        // å°è¯•æ¯ä¸ªå®ä¾‹ï¼Œç›´åˆ°æˆåŠŸ
        for (ServiceInstance instance : instances) {
            try {
                String url = String.format("http://%s:%s/user/info/%s", 
                                         instance.getHost(), instance.getPort(), userId);
                return restTemplate.getForObject(url, String.class);
            } catch (Exception e) {
                System.err.println("å®ä¾‹ " + instance.getInstanceId() + " è°ƒç”¨å¤±è´¥: " + e.getMessage());
                // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹
            }
        }
        
        throw new RuntimeException("æ‰€æœ‰ç”¨æˆ·æœåŠ¡å®ä¾‹éƒ½ä¸å¯ç”¨");
    }
}
```

## ğŸ“Š è´Ÿè½½å‡è¡¡ç›‘æ§

### 1. ç›‘æ§æŒ‡æ ‡
```java
package com.example.orderservice.metrics;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.stereotype.Component;

@Component
public class LoadBalancerMetrics {
    
    private final Counter totalRequestsCounter;
    private final Counter successRequestsCounter;
    private final Counter failureRequestsCounter;
    
    public LoadBalancerMetrics(MeterRegistry meterRegistry) {
        this.totalRequestsCounter = Counter.builder("loadbalancer_requests_total")
                .description("è´Ÿè½½å‡è¡¡æ€»è¯·æ±‚æ•°")
                .register(meterRegistry);
        
        this.successRequestsCounter = Counter.builder("loadbalancer_success_total")
                .description("è´Ÿè½½å‡è¡¡æˆåŠŸè¯·æ±‚æ•°")
                .register(meterRegistry);
        
        this.failureRequestsCounter = Counter.builder("loadbalancer_failure_total")
                .description("è´Ÿè½½å‡è¡¡å¤±è´¥è¯·æ±‚æ•°")
                .register(meterRegistry);
    }
    
    public void incrementTotalRequests() {
        totalRequestsCounter.increment();
    }
    
    public void incrementSuccessRequests() {
        successRequestsCounter.increment();
    }
    
    public void incrementFailureRequests() {
        failureRequestsCounter.increment();
    }
}
```

### 2. ç›‘æ§ç«¯ç‚¹
```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. è´Ÿè½½ä¸å‡è¡¡
**é—®é¢˜ï¼š** è¯·æ±‚æ²¡æœ‰å‡åŒ€åˆ†å¸ƒåˆ°å„ä¸ªå®ä¾‹
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# æ£€æŸ¥è´Ÿè½½å‡è¡¡ç­–ç•¥é…ç½®
spring:
  cloud:
    loadbalancer:
      configurations:
        default:
          load-balancer-class-name: org.springframework.cloud.loadbalancer.core.RoundRobinLoadBalancer
```

### 2. å®ä¾‹é€‰æ‹©å¤±è´¥
**é—®é¢˜ï¼š** æ— æ³•é€‰æ‹©åˆ°å¯ç”¨çš„æœåŠ¡å®ä¾‹
**è§£å†³æ–¹æ¡ˆï¼š**
```java
// æ£€æŸ¥æœåŠ¡å‘ç°çŠ¶æ€
List<ServiceInstance> instances = discoveryClient.getInstances("user-service");
if (instances.isEmpty()) {
    // è®°å½•æ—¥å¿—ï¼Œå‘é€å‘Šè­¦
    System.err.println("ç”¨æˆ·æœåŠ¡æ²¡æœ‰å¯ç”¨å®ä¾‹");
}

// å®ç°é‡è¯•æœºåˆ¶
@Retryable(value = Exception.class, maxAttempts = 3)
public String getUserInfo(String userId) {
    // ä¸šåŠ¡é€»è¾‘
}
```

### 3. æ€§èƒ½é—®é¢˜
**é—®é¢˜ï¼š** è´Ÿè½½å‡è¡¡å™¨æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ä½¿ç”¨ç¼“å­˜å‡å°‘æœåŠ¡å‘ç°è°ƒç”¨
@Service
public class CachedLoadBalancer {
    
    private final Cache<String, List<ServiceInstance>> instanceCache = Caffeine.newBuilder()
            .maximumSize(100)
            .expireAfterWrite(30, TimeUnit.SECONDS)
            .build();
    
    public ServiceInstance choose(String serviceId) {
        List<ServiceInstance> instances = instanceCache.get(serviceId, k -> 
            discoveryClient.getInstances(serviceId));
        
        if (instances.isEmpty()) {
            return null;
        }
        
        // å®ç°è´Ÿè½½å‡è¡¡ç®—æ³•
        return instances.get(0);
    }
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©
```
âœ… æ¨èç­–ç•¥ï¼š
- è½®è¯¢ï¼šå®ä¾‹æ€§èƒ½ç›¸è¿‘ï¼Œè¯·æ±‚å¤„ç†æ—¶é—´ç›¸è¿‘
- åŠ æƒè½®è¯¢ï¼šå®ä¾‹æ€§èƒ½å·®å¼‚è¾ƒå¤§
- æœ€å°‘è¿æ¥ï¼šé•¿è¿æ¥åœºæ™¯
- å“åº”æ—¶é—´ï¼šå¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„åœºæ™¯

âŒ é¿å…ç­–ç•¥ï¼š
- éšæœºï¼šç”Ÿäº§ç¯å¢ƒä¸æ¨è
- å›ºå®šï¼šæ— æ³•å®ç°è´Ÿè½½å‡è¡¡
```

### 2. å¥åº·æ£€æŸ¥é…ç½®
```yaml
# åˆç†çš„å¥åº·æ£€æŸ¥é…ç½®
spring:
  cloud:
    loadbalancer:
      health-check:
        initial-delay: 10s      # å¯åŠ¨å»¶è¿Ÿ
        interval: 30s           # æ£€æŸ¥é—´éš”
        timeout: 5s             # è¶…æ—¶æ—¶é—´
        retry-count: 2          # é‡è¯•æ¬¡æ•°
```

### 3. ç›‘æ§å‘Šè­¦
```java
// ç›‘æ§å…³é”®æŒ‡æ ‡
@Component
public class LoadBalancerMonitor {
    
    @EventListener
    public void handleInstanceChange(InstanceRegisteredEvent event) {
        // è®°å½•å®ä¾‹æ³¨å†Œäº‹ä»¶
        System.out.println("å®ä¾‹æ³¨å†Œ: " + event.getInstanceId());
    }
    
    @EventListener
    public void handleInstanceChange(InstanceDeregisteredEvent event) {
        // è®°å½•å®ä¾‹æ³¨é”€äº‹ä»¶
        System.out.println("å®ä¾‹æ³¨é”€: " + event.getInstanceId());
    }
}
```

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [æœåŠ¡è°ƒç”¨](./07.æœåŠ¡è°ƒç”¨.md) - å­¦ä¹ æœåŠ¡é—´è°ƒç”¨
- [ç†”æ–­å™¨](./08.ç†”æ–­å™¨.md) - å­¦ä¹ ç†”æ–­é™çº§
- [åˆ†å¸ƒå¼äº‹åŠ¡](./09.åˆ†å¸ƒå¼äº‹åŠ¡.md) - å­¦ä¹ äº‹åŠ¡ç®¡ç†

---

**è®°ä½ï¼šè´Ÿè½½å‡è¡¡æ˜¯å¾®æœåŠ¡é«˜å¯ç”¨çš„åŸºç¡€ï¼ŒæŒæ¡å®ƒå°±èƒ½å®ç°ç³»ç»Ÿçš„å¼¹æ€§æ‰©å±•ï¼** ğŸ¯
