# é…ç½®ä¸­å¿ƒ

## ğŸ¯ ä»€ä¹ˆæ˜¯é…ç½®ä¸­å¿ƒï¼Ÿ

é…ç½®ä¸­å¿ƒæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­é›†ä¸­ç®¡ç†é…ç½®ä¿¡æ¯çš„ç»„ä»¶ï¼Œå®ƒè§£å†³äº†"é…ç½®åœ¨å“ªé‡Œ"å’Œ"é…ç½®å¦‚ä½•æ›´æ–°"çš„é—®é¢˜ã€‚

### 1. åŸºæœ¬æ¦‚å¿µ
```
é…ç½®ä¸­å¿ƒ = é…ç½®å­˜å‚¨ + é…ç½®åˆ†å‘ + é…ç½®æ›´æ–° + é…ç½®ç‰ˆæœ¬ç®¡ç†
```

**ç®€å•ç†è§£ï¼š**
- å°±åƒå…¬å¸çš„è§„ç« åˆ¶åº¦ï¼Œç»Ÿä¸€ç®¡ç†ï¼Œç»Ÿä¸€å‘å¸ƒ
- æ‰€æœ‰æœåŠ¡çš„é…ç½®éƒ½é›†ä¸­å­˜å‚¨
- é…ç½®æ›´æ–°æ—¶ï¼Œæ‰€æœ‰æœåŠ¡è‡ªåŠ¨æ„ŸçŸ¥
- æ”¯æŒä¸åŒç¯å¢ƒçš„é…ç½®éš”ç¦»

### 2. ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒï¼Ÿ

#### æ²¡æœ‰é…ç½®ä¸­å¿ƒçš„é—®é¢˜
```
âŒ é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·æœåŠ¡é…ç½®ï¼šæ•°æ®åº“è¿æ¥ã€Redisé…ç½®ã€ä¸šåŠ¡å‚æ•°
è®¢å•æœåŠ¡é…ç½®ï¼šæ•°æ®åº“è¿æ¥ã€Redisé…ç½®ã€ä¸šåŠ¡å‚æ•°
å•†å“æœåŠ¡é…ç½®ï¼šæ•°æ®åº“è¿æ¥ã€Redisé…ç½®ã€ä¸šåŠ¡å‚æ•°

å¦‚æœæ•°æ®åº“åœ°å€å˜äº†ï¼Œéœ€è¦ï¼š
1. ä¿®æ”¹æ¯ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶
2. é‡æ–°æ‰“åŒ…æ¯ä¸ªæœåŠ¡
3. é‡å¯æ¯ä¸ªæœåŠ¡
4. å®¹æ˜“é—æ¼ï¼Œå®¹æ˜“å‡ºé”™
```

#### æœ‰äº†é…ç½®ä¸­å¿ƒçš„å¥½å¤„
```
âœ… è§£å†³æ–¹æ¡ˆï¼š
1. æ‰€æœ‰é…ç½®é›†ä¸­åœ¨é…ç½®ä¸­å¿ƒ
2. é…ç½®æ›´æ–°æ—¶è‡ªåŠ¨æ¨é€ç»™æ‰€æœ‰æœåŠ¡
3. æ— éœ€é‡å¯ï¼Œæ— éœ€é‡æ–°æ‰“åŒ…
4. æ”¯æŒé…ç½®ç‰ˆæœ¬ç®¡ç†ï¼Œå¯ä»¥å›æ»š
5. æ”¯æŒç¯å¢ƒéš”ç¦»ï¼Œä¸åŒç¯å¢ƒä¸åŒé…ç½®
```

## ğŸ—ï¸ é…ç½®ä¸­å¿ƒæ¶æ„

### 1. æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é…ç½®ä¸­å¿ƒ                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ç”¨æˆ·æœåŠ¡é…ç½®â”‚  â”‚ è®¢å•æœåŠ¡é…ç½®â”‚  â”‚ å•†å“æœåŠ¡é…ç½®â”‚        â”‚
â”‚  â”‚ ç¯å¢ƒ:dev    â”‚  â”‚ ç¯å¢ƒ:dev    â”‚  â”‚ ç¯å¢ƒ:dev    â”‚        â”‚
â”‚  â”‚ ç‰ˆæœ¬:v1.0   â”‚  â”‚ ç‰ˆæœ¬:v1.0   â”‚  â”‚ ç‰ˆæœ¬:v1.0   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡   â”‚ â”‚  è®¢å•æœåŠ¡   â”‚ â”‚  å•†å“æœåŠ¡   â”‚
â”‚  æ‹‰å–é…ç½®   â”‚ â”‚  æ‹‰å–é…ç½®   â”‚ â”‚  æ‹‰å–é…ç½®   â”‚
â”‚  ç›‘å¬å˜åŒ–   â”‚ â”‚  ç›‘å¬å˜åŒ–   â”‚ â”‚  ç›‘å¬å˜åŒ–   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å·¥ä½œæµç¨‹
```
1. æœåŠ¡å¯åŠ¨ â†’ ä»é…ç½®ä¸­å¿ƒæ‹‰å–é…ç½® â†’ åº”ç”¨é…ç½®
2. é…ç½®æ›´æ–° â†’ é…ç½®ä¸­å¿ƒæ¨é€é€šçŸ¥ â†’ æœåŠ¡æ¥æ”¶é€šçŸ¥
3. é…ç½®æ›´æ–° â†’ æœåŠ¡é‡æ–°æ‹‰å–é…ç½® â†’ åº”ç”¨æ–°é…ç½®
4. é…ç½®å›æ»š â†’ é€‰æ‹©å†å²ç‰ˆæœ¬ â†’ æœåŠ¡åº”ç”¨å›æ»šé…ç½®
```

## ğŸ”§ ä¸»æµé…ç½®ä¸­å¿ƒå¯¹æ¯”

### 1. åŠŸèƒ½å¯¹æ¯”è¡¨
| ç‰¹æ€§ | Spring Cloud Config | Nacos Config | Apollo | Consul KV |
|------|-------------------|--------------|--------|-----------|
| é…ç½®å­˜å‚¨ | Git/SVN | å†…ç½®å­˜å‚¨ | å†…ç½®å­˜å‚¨ | å†…ç½®å­˜å‚¨ |
| é…ç½®æ¨é€ | æ‰‹åŠ¨åˆ·æ–° | è‡ªåŠ¨æ¨é€ | è‡ªåŠ¨æ¨é€ | æ‰‹åŠ¨åˆ·æ–° |
| ç‰ˆæœ¬ç®¡ç† | Gitç‰ˆæœ¬ | å†…ç½®ç‰ˆæœ¬ | å†…ç½®ç‰ˆæœ¬ | å†…ç½®ç‰ˆæœ¬ |
| ç¯å¢ƒéš”ç¦» | Profile | Namespace | Environment | Datacenter |
| é…ç½®åŠ å¯† | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ | æ”¯æŒ |
| æ˜“ç”¨æ€§ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

### 2. é€‰æ‹©å»ºè®®
- **Spring Cloud Config**ï¼šSpring Cloudå®˜æ–¹ï¼ŒGité›†æˆå¥½
- **Nacos Config**ï¼šé˜¿é‡Œå·´å·´å¼€æºï¼ŒåŠŸèƒ½å…¨é¢ï¼Œæ˜“ç”¨æ€§å¥½
- **Apollo**ï¼šæºç¨‹å¼€æºï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œé…ç½®æ¨é€åŠæ—¶
- **Consul KV**ï¼šConsulçš„é”®å€¼å­˜å‚¨ï¼ŒåŠŸèƒ½ç›¸å¯¹ç®€å•

## ğŸš€ Nacos é…ç½®ä¸­å¿ƒ

### 1. ä¸ºä»€ä¹ˆé€‰æ‹©Nacosï¼Ÿ
- **åŠŸèƒ½å…¨é¢**ï¼šé…ç½®ç®¡ç†ã€æœåŠ¡æ³¨å†Œã€åŠ¨æ€DNS
- **æ˜“ç”¨æ€§å¥½**ï¼šæä¾›Webæ§åˆ¶å°ï¼Œæ“ä½œç®€å•
- **æ€§èƒ½ä¼˜ç§€**ï¼šæ”¯æŒå¤§è§„æ¨¡é…ç½®ç®¡ç†
- **ç”Ÿæ€ä¸°å¯Œ**ï¼šSpring Cloud Alibabaé›†æˆ

### 2. Mavenä¾èµ–é…ç½®
```xml
<!-- çˆ¶POMä¸­çš„ä¾èµ–ç®¡ç† -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2021.0.5.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<!-- æœåŠ¡æ¨¡å—ä¸­çš„ä¾èµ– -->
<dependencies>
    <!-- Nacosé…ç½®ä¸­å¿ƒ -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
    
    <!-- NacosæœåŠ¡å‘ç°ï¼ˆå¯é€‰ï¼‰ -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
</dependencies>
```

## ğŸ’» é…ç½®ä¸­å¿ƒä½¿ç”¨

### 1. é…ç½®æ–‡ä»¶ç»“æ„
```
bootstrap.yml (å¯åŠ¨é…ç½®)
â”œâ”€â”€ é…ç½®ä¸­å¿ƒåœ°å€
â”œâ”€â”€ å‘½åç©ºé—´
â”œâ”€â”€ åˆ†ç»„
â””â”€â”€ æ–‡ä»¶æ‰©å±•å

application.yml (åº”ç”¨é…ç½®)
â”œâ”€â”€ åº”ç”¨åç§°
â”œâ”€â”€ æœåŠ¡ç«¯å£
â””â”€â”€ å…¶ä»–é…ç½®
```

### 2. å¯åŠ¨é…ç½® (bootstrap.yml)
```yaml
spring:
  application:
    name: user-service
  cloud:
    nacos:
      config:
        server-addr: localhost:8848      # NacosæœåŠ¡å™¨åœ°å€
        namespace: public                # å‘½åç©ºé—´
        group: DEFAULT_GROUP             # åˆ†ç»„
        file-extension: yaml             # é…ç½®æ–‡ä»¶æ‰©å±•å
        username: nacos                  # ç”¨æˆ·å
        password: nacos                  # å¯†ç 
        # å¯é€‰é…ç½®
        enabled: true                    # å¯ç”¨é…ç½®ä¸­å¿ƒ
        refresh-enabled: true            # å¯ç”¨é…ç½®åˆ·æ–°
        shared-configs:                  # å…±äº«é…ç½®
          - data-id: common-config.yaml
            group: DEFAULT_GROUP
            refresh: true
        extension-configs:               # æ‰©å±•é…ç½®
          - data-id: ${spring.application.name}-${spring.profiles.active}.yaml
            group: DEFAULT_GROUP
            refresh: true
```

### 3. åº”ç”¨é…ç½® (application.yml)
```yaml
server:
  port: 8081

spring:
  profiles:
    active: dev  # æ¿€æ´»çš„ç¯å¢ƒ

# æ•°æ®åº“é…ç½®
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/user_db
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver

# Redisé…ç½®
spring:
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0

# ä¸šåŠ¡é…ç½®
app:
  user:
    default-avatar: /images/default-avatar.png
    max-login-attempts: 5
    session-timeout: 3600
```

### 4. å¯åŠ¨ç±»é…ç½®
```java
package com.example.userservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.context.config.annotation.RefreshScope;

@SpringBootApplication
@RefreshScope  // å¯ç”¨é…ç½®åˆ·æ–°
public class UserServiceApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

### 5. é…ç½®ä½¿ç”¨ç¤ºä¾‹
```java
package com.example.userservice.controller;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/user")
@RefreshScope  // å¯ç”¨é…ç½®åˆ·æ–°
public class UserController {
    
    @Value("${app.user.default-avatar}")
    private String defaultAvatar;
    
    @Value("${app.user.max-login-attempts}")
    private Integer maxLoginAttempts;
    
    @Value("${app.user.session-timeout}")
    private Integer sessionTimeout;
    
    @GetMapping("/config")
    public String getConfig() {
        return String.format("é»˜è®¤å¤´åƒ: %s, æœ€å¤§ç™»å½•å°è¯•æ¬¡æ•°: %d, ä¼šè¯è¶…æ—¶: %dç§’", 
                           defaultAvatar, maxLoginAttempts, sessionTimeout);
    }
    
    @GetMapping("/avatar/{userId}")
    public String getUserAvatar(@PathVariable String userId) {
        // ä½¿ç”¨é…ç½®çš„é»˜è®¤å¤´åƒ
        return String.format("ç”¨æˆ· %s çš„å¤´åƒ: %s", userId, defaultAvatar);
    }
}
```

### 6. é…ç½®ç›‘å¬å™¨
```java
package com.example.userservice.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.context.annotation.Configuration;

import javax.annotation.PostConstruct;

@Configuration
@RefreshScope
public class AppConfig {
    
    @Value("${app.user.default-avatar}")
    private String defaultAvatar;
    
    @Value("${app.user.max-login-attempts}")
    private Integer maxLoginAttempts;
    
    @PostConstruct
    public void init() {
        System.out.println("åº”ç”¨é…ç½®åˆå§‹åŒ–å®Œæˆ");
        System.out.println("é»˜è®¤å¤´åƒ: " + defaultAvatar);
        System.out.println("æœ€å¤§ç™»å½•å°è¯•æ¬¡æ•°: " + maxLoginAttempts);
    }
    
    // Getteræ–¹æ³•
    public String getDefaultAvatar() {
        return defaultAvatar;
    }
    
    public Integer getMaxLoginAttempts() {
        return maxLoginAttempts;
    }
}
```

## ğŸ”„ é…ç½®åŠ¨æ€æ›´æ–°

### 1. è‡ªåŠ¨é…ç½®åˆ·æ–°
```java
package com.example.userservice.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.stereotype.Service;

@Service
@RefreshScope
public class UserService {
    
    @Value("${app.user.session-timeout}")
    private Integer sessionTimeout;
    
    @Value("${app.user.max-login-attempts}")
    private Integer maxLoginAttempts;
    
    public boolean validateLoginAttempts(int attempts) {
        return attempts < maxLoginAttempts;
    }
    
    public int getSessionTimeout() {
        return sessionTimeout;
    }
    
    public void setSessionTimeout(int sessionTimeout) {
        this.sessionTimeout = sessionTimeout;
    }
}
```

### 2. æ‰‹åŠ¨é…ç½®åˆ·æ–°
```java
package com.example.userservice.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.context.refresh.ContextRefresher;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/config")
public class ConfigController {
    
    @Autowired
    private ContextRefresher contextRefresher;
    
    @PostMapping("/refresh")
    public String refreshConfig() {
        // æ‰‹åŠ¨åˆ·æ–°é…ç½®
        contextRefresher.refresh();
        return "é…ç½®åˆ·æ–°æˆåŠŸ";
    }
}
```

### 3. é…ç½®å˜æ›´ç›‘å¬
```java
package com.example.userservice.listener;

import com.alibaba.nacos.api.config.annotation.NacosConfigListener;
import org.springframework.stereotype.Component;

@Component
public class ConfigChangeListener {
    
    @NacosConfigListener(dataId = "user-service.yaml", groupId = "DEFAULT_GROUP")
    public void onConfigChange(String newConfig) {
        System.out.println("é…ç½®å‘ç”Ÿå˜æ›´: " + newConfig);
        // å¤„ç†é…ç½®å˜æ›´é€»è¾‘
    }
}
```

## ğŸ” é…ç½®åŠ å¯†

### 1. æ•æ„Ÿä¿¡æ¯åŠ å¯†
```yaml
# æ•°æ®åº“å¯†ç åŠ å¯†
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/user_db
    username: root
    password: ENC(encrypted_password_here)
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### 2. åŠ å¯†å·¥å…·ç±»
```java
package com.example.userservice.util;

import org.springframework.util.StringUtils;
import javax.crypto.Cipher;
import javax.crypto.spec.SecretKeySpec;
import java.util.Base64;

public class ConfigEncryptUtil {
    
    private static final String ALGORITHM = "AES";
    private static final String SECRET_KEY = "your-secret-key-16"; // 16ä½å¯†é’¥
    
    public static String encrypt(String value) {
        try {
            SecretKeySpec key = new SecretKeySpec(SECRET_KEY.getBytes(), ALGORITHM);
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            cipher.init(Cipher.ENCRYPT_MODE, key);
            byte[] encryptedBytes = cipher.doFinal(value.getBytes());
            return Base64.getEncoder().encodeToString(encryptedBytes);
        } catch (Exception e) {
            throw new RuntimeException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    public static String decrypt(String encryptedValue) {
        try {
            SecretKeySpec key = new SecretKeySpec(SECRET_KEY.getBytes(), ALGORITHM);
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            cipher.init(Cipher.DECRYPT_MODE, key);
            byte[] decryptedBytes = cipher.doFinal(Base64.getDecoder().decode(encryptedValue));
            return new String(decryptedBytes);
        } catch (Exception e) {
            throw new RuntimeException("è§£å¯†å¤±è´¥", e);
        }
    }
    
    public static boolean isEncrypted(String value) {
        return StringUtils.hasText(value) && value.startsWith("ENC(") && value.endsWith(")");
    }
    
    public static String resolveEncryptedValue(String value) {
        if (isEncrypted(value)) {
            String encryptedContent = value.substring(4, value.length() - 1);
            return decrypt(encryptedContent);
        }
        return value;
    }
}
```

## ğŸŒ ç¯å¢ƒéš”ç¦»

### 1. å‘½åç©ºé—´éš”ç¦»
```yaml
# å¼€å‘ç¯å¢ƒ
spring:
  cloud:
    nacos:
      config:
        namespace: dev
        group: DEFAULT_GROUP

# æµ‹è¯•ç¯å¢ƒ
spring:
  cloud:
    nacos:
      config:
        namespace: test
        group: DEFAULT_GROUP

# ç”Ÿäº§ç¯å¢ƒ
spring:
  cloud:
    nacos:
      config:
        namespace: prod
        group: DEFAULT_GROUP
```

### 2. åˆ†ç»„éš”ç¦»
```yaml
# ä¸šåŠ¡Aç»„
spring:
  cloud:
    nacos:
      config:
        namespace: public
        group: business-a

# ä¸šåŠ¡Bç»„
spring:
  cloud:
    nacos:
      config:
        namespace: public
        group: business-b
```

### 3. é…ç½®æ–‡ä»¶å‘½åè§„èŒƒ
```
# å¼€å‘ç¯å¢ƒ
user-service-dev.yaml

# æµ‹è¯•ç¯å¢ƒ
user-service-test.yaml

# ç”Ÿäº§ç¯å¢ƒ
user-service-prod.yaml

# å…¬å…±é…ç½®
common-config.yaml

# ä¸šåŠ¡é…ç½®
business-config.yaml
```

## ğŸ“Š é…ç½®ç‰ˆæœ¬ç®¡ç†

### 1. ç‰ˆæœ¬å›æ»š
```java
package com.example.userservice.controller;

import com.alibaba.nacos.api.config.ConfigService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/config")
public class ConfigVersionController {
    
    @Autowired
    private ConfigService configService;
    
    @PostMapping("/rollback/{version}")
    public String rollbackConfig(@PathVariable String version) {
        try {
            // å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
            boolean success = configService.publishConfig(
                "user-service.yaml", 
                "DEFAULT_GROUP", 
                getConfigByVersion(version)
            );
            return success ? "é…ç½®å›æ»šæˆåŠŸ" : "é…ç½®å›æ»šå¤±è´¥";
        } catch (Exception e) {
            return "é…ç½®å›æ»šå¼‚å¸¸: " + e.getMessage();
        }
    }
    
    private String getConfigByVersion(String version) {
        // æ ¹æ®ç‰ˆæœ¬è·å–é…ç½®å†…å®¹
        // è¿™é‡Œéœ€è¦å®ç°å…·ä½“çš„ç‰ˆæœ¬ç®¡ç†é€»è¾‘
        return "é…ç½®å†…å®¹";
    }
}
```

### 2. é…ç½®å†å²è®°å½•
```java
package com.example.userservice.service;

import com.alibaba.nacos.api.config.ConfigService;
import com.alibaba.nacos.api.config.listener.Listener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.concurrent.Executor;

@Service
public class ConfigHistoryService {
    
    @Autowired
    private ConfigService configService;
    
    public void addConfigChangeListener() {
        try {
            configService.addListener("user-service.yaml", "DEFAULT_GROUP", new Listener() {
                @Override
                public void receiveConfigInfo(String configInfo) {
                    System.out.println("é…ç½®å˜æ›´: " + configInfo);
                    // è®°å½•é…ç½®å˜æ›´å†å²
                    saveConfigHistory(configInfo);
                }
                
                @Override
                public Executor getExecutor() {
                    return null;
                }
            });
        } catch (Exception e) {
            System.err.println("æ·»åŠ é…ç½®ç›‘å¬å™¨å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void saveConfigHistory(String configInfo) {
        // ä¿å­˜é…ç½®å˜æ›´å†å²åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶
        System.out.println("ä¿å­˜é…ç½®å†å²: " + configInfo);
    }
}
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. é…ç½®æ— æ³•åˆ·æ–°
**é—®é¢˜ï¼š** é…ç½®æ›´æ–°åæœåŠ¡æ— æ³•æ„ŸçŸ¥
**è§£å†³æ–¹æ¡ˆï¼š**
```java
// 1. ç¡®ä¿ä½¿ç”¨@RefreshScopeæ³¨è§£
@RefreshScope
public class UserController {
    // ...
}

// 2. æ£€æŸ¥é…ç½®æ¨é€æ˜¯å¦å¯ç”¨
spring:
  cloud:
    nacos:
      config:
        refresh-enabled: true

// 3. æ‰‹åŠ¨åˆ·æ–°é…ç½®
@PostMapping("/refresh")
public String refresh() {
    contextRefresher.refresh();
    return "åˆ·æ–°æˆåŠŸ";
}
```

### 2. é…ç½®åŠ è½½å¤±è´¥
**é—®é¢˜ï¼š** æœåŠ¡å¯åŠ¨æ—¶æ— æ³•åŠ è½½é…ç½®
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# æ£€æŸ¥é…ç½®ä¸­å¿ƒåœ°å€
spring:
  cloud:
    nacos:
      config:
        server-addr: localhost:8848

# æ£€æŸ¥å‘½åç©ºé—´å’Œåˆ†ç»„
spring:
  cloud:
    nacos:
      config:
        namespace: public
        group: DEFAULT_GROUP

# æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
spring:
  cloud:
    nacos:
      config:
        file-extension: yaml
```

### 3. é…ç½®å†²çª
**é—®é¢˜ï¼š** å¤šä¸ªé…ç½®æ–‡ä»¶å­˜åœ¨å†²çª
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# ä½¿ç”¨ä¼˜å…ˆçº§é…ç½®
spring:
  cloud:
    nacos:
      config:
        shared-configs:
          - data-id: common-config.yaml
            group: DEFAULT_GROUP
            refresh: true
            priority: 1
          - data-id: business-config.yaml
            group: DEFAULT_GROUP
            refresh: true
            priority: 2
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é…ç½®æ–‡ä»¶ç»„ç»‡
```
é…ç½®ä¸­å¿ƒ/
â”œâ”€â”€ å…¬å…±é…ç½®/
â”‚   â”œâ”€â”€ common-config.yaml
â”‚   â”œâ”€â”€ database-config.yaml
â”‚   â””â”€â”€ redis-config.yaml
â”œâ”€â”€ ä¸šåŠ¡é…ç½®/
â”‚   â”œâ”€â”€ user-service.yaml
â”‚   â”œâ”€â”€ order-service.yaml
â”‚   â””â”€â”€ product-service.yaml
â””â”€â”€ ç¯å¢ƒé…ç½®/
    â”œâ”€â”€ dev/
    â”œâ”€â”€ test/
    â””â”€â”€ prod/
```

### 2. é…ç½®å‘½åè§„èŒƒ
```
âœ… æ¨èå‘½åï¼š
- user-service-dev.yaml
- common-config.yaml
- database-config.yaml

âŒ é¿å…å‘½åï¼š
- userService-dev.yaml
- user_service_dev.yaml
- config.yaml
```

### 3. é…ç½®æ›´æ–°ç­–ç•¥
- **å…³é”®é…ç½®**ï¼šä½¿ç”¨@RefreshScopeï¼Œæ”¯æŒçƒ­æ›´æ–°
- **å¯åŠ¨é…ç½®**ï¼šæ”¾åœ¨bootstrap.ymlï¼Œå¯åŠ¨æ—¶åŠ è½½
- **ä¸šåŠ¡é…ç½®**ï¼šæ”¾åœ¨application.ymlï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
- **æ•æ„Ÿé…ç½®**ï¼šä½¿ç”¨åŠ å¯†ï¼Œé¿å…æ˜æ–‡å­˜å‚¨

### 4. é…ç½®ç›‘æ§
```java
// ç›‘æ§é…ç½®å˜æ›´
@Component
public class ConfigMonitor {
    
    @EventListener
    public void handleConfigChange(RefreshScopeRefreshedEvent event) {
        System.out.println("é…ç½®å·²åˆ·æ–°: " + event.getSource());
        // è®°å½•é…ç½®å˜æ›´æ—¥å¿—
        // å‘é€é…ç½®å˜æ›´é€šçŸ¥
        // æ›´æ–°ç›‘æ§æŒ‡æ ‡
    }
}
```

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [æœåŠ¡ç½‘å…³](./05.æœåŠ¡ç½‘å…³.md) - å­¦ä¹ ç½‘å…³æœåŠ¡
- [è´Ÿè½½å‡è¡¡](./06.è´Ÿè½½å‡è¡¡.md) - å­¦ä¹ è´Ÿè½½å‡è¡¡
- [æœåŠ¡è°ƒç”¨](./07.æœåŠ¡è°ƒç”¨.md) - å­¦ä¹ æœåŠ¡é—´è°ƒç”¨

---

**è®°ä½ï¼šé…ç½®ä¸­å¿ƒè®©é…ç½®ç®¡ç†å˜å¾—ç®€å•ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°å’Œç‰ˆæœ¬ç®¡ç†ï¼** ğŸ¯
