# æœåŠ¡ç½‘å…³

## ğŸ¯ ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘å…³ï¼Ÿ

æœåŠ¡ç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„ç»Ÿä¸€å…¥å£ï¼Œå®ƒè´Ÿè´£è·¯ç”±ã€è®¤è¯ã€é™æµã€ç›‘æ§ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚

### 1. åŸºæœ¬æ¦‚å¿µ
```
æœåŠ¡ç½‘å…³ = ç»Ÿä¸€å…¥å£ + è·¯ç”±è½¬å‘ + æ¨ªåˆ‡å…³æ³¨ç‚¹å¤„ç† + æµé‡æ§åˆ¶
```

**ç®€å•ç†è§£ï¼š**
- å°±åƒå…¬å¸çš„å‰å°ï¼Œæ‰€æœ‰è®¿å®¢éƒ½è¦å…ˆç»è¿‡å‰å°
- ç»Ÿä¸€å¤„ç†è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰å…¬å…±é€»è¾‘
- æ ¹æ®è§„åˆ™å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„æœåŠ¡
- ä¿æŠ¤å†…éƒ¨æœåŠ¡ï¼Œæä¾›ç»Ÿä¸€çš„APIæ¥å£

### 2. ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç½‘å…³ï¼Ÿ

#### æ²¡æœ‰æœåŠ¡ç½‘å…³çš„é—®é¢˜
```
âŒ é—®é¢˜åœºæ™¯ï¼š
å®¢æˆ·ç«¯éœ€è¦çŸ¥é“æ‰€æœ‰æœåŠ¡çš„åœ°å€
æ¯ä¸ªæœåŠ¡éƒ½è¦å®ç°è®¤è¯ã€é™æµã€æ—¥å¿—
æœåŠ¡åœ°å€å˜åŒ–æ—¶ï¼Œå®¢æˆ·ç«¯éœ€è¦ä¿®æ”¹
æ— æ³•ç»Ÿä¸€ç®¡ç†APIæ¥å£
```

#### æœ‰äº†æœåŠ¡ç½‘å…³çš„å¥½å¤„
```
âœ… è§£å†³æ–¹æ¡ˆï¼š
1. å®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“ç½‘å…³åœ°å€
2. ç»Ÿä¸€å¤„ç†è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰
3. æœåŠ¡åœ°å€å˜åŒ–å¯¹å®¢æˆ·ç«¯é€æ˜
4. ç»Ÿä¸€ç®¡ç†APIæ¥å£å’Œæ–‡æ¡£
5. æä¾›ç»Ÿä¸€çš„ç›‘æ§å’Œå‘Šè­¦
```

## ğŸ—ï¸ æœåŠ¡ç½‘å…³æ¶æ„

### 1. æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®¢æˆ·ç«¯                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    Web      â”‚  â”‚   Mobile    â”‚  â”‚   Third     â”‚        â”‚
â”‚  â”‚   Client    â”‚  â”‚   Client    â”‚  â”‚   Party     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡ç½‘å…³                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   è·¯ç”±      â”‚  â”‚   è®¤è¯      â”‚  â”‚   é™æµ      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   æ—¥å¿—      â”‚  â”‚   ç›‘æ§      â”‚  â”‚   ç†”æ–­      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡   â”‚ â”‚  è®¢å•æœåŠ¡   â”‚ â”‚  å•†å“æœåŠ¡   â”‚
â”‚  ç«¯å£:8081  â”‚ â”‚  ç«¯å£:8082  â”‚ â”‚  ç«¯å£:8083  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å·¥ä½œæµç¨‹
```
1. å®¢æˆ·ç«¯è¯·æ±‚ â†’ åˆ°è¾¾ç½‘å…³
2. ç½‘å…³å¤„ç† â†’ è®¤è¯ã€é™æµã€æ—¥å¿—
3. è·¯ç”±è½¬å‘ â†’ æ ¹æ®è§„åˆ™è½¬å‘åˆ°ç›®æ ‡æœåŠ¡
4. æœåŠ¡å¤„ç† â†’ ä¸šåŠ¡é€»è¾‘å¤„ç†
5. å“åº”è¿”å› â†’ ç½‘å…³è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```

## ğŸ”§ ä¸»æµç½‘å…³å¯¹æ¯”

### 1. åŠŸèƒ½å¯¹æ¯”è¡¨
| ç‰¹æ€§ | Spring Cloud Gateway | Zuul | Kong | Nginx |
|------|---------------------|------|------|-------|
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| åŠŸèƒ½ä¸°å¯Œåº¦ | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­ |
| æ˜“ç”¨æ€§ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­ |
| Springé›†æˆ | â­â­â­â­â­ | â­â­â­â­ | â­â­ | â­â­ |
| ç¤¾åŒºæ´»è·ƒåº¦ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |

### 2. é€‰æ‹©å»ºè®®
- **Spring Cloud Gateway**ï¼šSpring Cloudå®˜æ–¹ï¼Œæ€§èƒ½å¥½ï¼ŒåŠŸèƒ½ä¸°å¯Œ
- **Zuul**ï¼šNetflixå¼€æºï¼Œç®€å•æ˜“ç”¨ï¼ˆå·²åœæ­¢ç»´æŠ¤ï¼‰
- **Kong**ï¼šåŠŸèƒ½æœ€ä¸°å¯Œï¼Œé€‚åˆå¤æ‚åœºæ™¯
- **Nginx**ï¼šæ€§èƒ½æœ€å¥½ï¼Œä½†åŠŸèƒ½ç›¸å¯¹ç®€å•

## ğŸš€ Spring Cloud Gateway

### 1. ä¸ºä»€ä¹ˆé€‰æ‹©Spring Cloud Gatewayï¼Ÿ
- **æ€§èƒ½ä¼˜ç§€**ï¼šåŸºäºWebFluxï¼Œæ”¯æŒå¼‚æ­¥éé˜»å¡
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šè·¯ç”±ã€è¿‡æ»¤ã€é™æµã€ç†”æ–­ç­‰
- **Springé›†æˆ**ï¼šä¸Spring Cloudç”Ÿæ€å®Œç¾é›†æˆ
- **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒè‡ªå®šä¹‰è¿‡æ»¤å™¨

### 2. Mavenä¾èµ–é…ç½®
```xml
<!-- çˆ¶POMä¸­çš„ä¾èµ–ç®¡ç† -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>2021.0.8</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<!-- ç½‘å…³æ¨¡å—ä¸­çš„ä¾èµ– -->
<dependencies>
    <!-- Spring Cloud Gateway -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    
    <!-- NacosæœåŠ¡å‘ç° -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    
    <!-- Spring Boot Actuator -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
</dependencies>
```

## ğŸ’» ç½‘å…³åŸºç¡€é…ç½®

### 1. å¯åŠ¨ç±»é…ç½®
```java
package com.example.gateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class GatewayApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
}
```

### 2. åŸºç¡€é…ç½®æ–‡ä»¶
```yaml
# application.yml
server:
  port: 8080

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true  # å¯ç”¨æœåŠ¡å‘ç°
          lower-case-service-id: true  # æœåŠ¡åè½¬å°å†™
      routes:
        # ç”¨æˆ·æœåŠ¡è·¯ç”±
        - id: user-service
          uri: lb://user-service  # lb://è¡¨ç¤ºè´Ÿè½½å‡è¡¡
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix=1  # å»æ‰è·¯å¾„å‰ç¼€
            - name: RequestRateLimiter  # é™æµè¿‡æ»¤å™¨
              args:
                redis-rate-limiter.replenishRate: 10  # æ¯ç§’å…è®¸å¤„ç†çš„è¯·æ±‚æ•°é‡
                redis-rate-limiter.burstCapacity: 20  # æ¯ç§’æœ€å¤§å¤„ç†çš„è¯·æ±‚æ•°é‡
                key-resolver: "#{@userKeyResolver}"  # é™æµç­–ç•¥ï¼Œå¯¹åº”ç­–ç•¥Bean
        
        # è®¢å•æœåŠ¡è·¯ç”±
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
          filters:
            - StripPrefix=1
        
        # å•†å“æœåŠ¡è·¯ç”±
        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/product/**
          filters:
            - StripPrefix=1

# Nacosé…ç½®
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public
        group: DEFAULT_GROUP

# ç›‘æ§ç«¯ç‚¹
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    gateway:
      enabled: true
```

## ğŸ›£ï¸ è·¯ç”±é…ç½®è¯¦è§£

### 1. è·¯ç”±é…ç½®æ–¹å¼

#### æ–¹å¼1ï¼šé…ç½®æ–‡ä»¶é…ç½®
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service-route
          uri: lb://user-service
          predicates:
            - Path=/user/**
            - Method=GET
            - Header=X-Request-Id, \d+
            - Query=name, .+
            - After=2023-01-01T00:00:00+08:00[Asia/Shanghai]
          filters:
            - StripPrefix=1
            - AddRequestHeader=X-Response-Time, ${timestamp}
            - AddResponseHeader=X-Response-Time, ${timestamp}
```

#### æ–¹å¼2ï¼šJavaä»£ç é…ç½®
```java
package com.example.gateway.config;

import org.springframework.cloud.gateway.route.RouteLocator;
import org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
                .route("user-service-route", r -> r
                        .path("/user/**")
                        .filters(f -> f
                                .stripPrefix(1)
                                .addRequestHeader("X-Response-Time", String.valueOf(System.currentTimeMillis()))
                                .addResponseHeader("X-Response-Time", String.valueOf(System.currentTimeMillis())))
                        .uri("lb://user-service"))
                .route("order-service-route", r -> r
                        .path("/order/**")
                        .filters(f -> f.stripPrefix(1))
                        .uri("lb://order-service"))
                .build();
    }
}
```

### 2. æ–­è¨€ï¼ˆPredicatesï¼‰è¯¦è§£

#### è·¯å¾„æ–­è¨€
```yaml
predicates:
  - Path=/user/**        # è·¯å¾„åŒ¹é…
  - Path=/user/{segment} # è·¯å¾„å˜é‡
  - Path=/user/{segment}/** # è·¯å¾„å˜é‡ + é€šé…ç¬¦
```

#### æ—¶é—´æ–­è¨€
```yaml
predicates:
  - After=2023-01-01T00:00:00+08:00[Asia/Shanghai]  # æŒ‡å®šæ—¶é—´ä¹‹å
  - Before=2023-12-31T23:59:59+08:00[Asia/Shanghai] # æŒ‡å®šæ—¶é—´ä¹‹å‰
  - Between=2023-01-01T00:00:00+08:00[Asia/Shanghai], 2023-12-31T23:59:59+08:00[Asia/Shanghai] # æ—¶é—´èŒƒå›´
```

#### è¯·æ±‚æ–¹æ³•æ–­è¨€
```yaml
predicates:
  - Method=GET           # GETè¯·æ±‚
  - Method=GET,POST      # GETæˆ–POSTè¯·æ±‚
  - Method=GET,POST,PUT  # GETã€POSTæˆ–PUTè¯·æ±‚
```

#### è¯·æ±‚å¤´æ–­è¨€
```yaml
predicates:
  - Header=X-Request-Id, \d+     # è¯·æ±‚å¤´å­˜åœ¨ä¸”åŒ¹é…æ­£åˆ™
  - Header=X-Request-Id          # è¯·æ±‚å¤´å­˜åœ¨
  - Header=!X-Request-Id         # è¯·æ±‚å¤´ä¸å­˜åœ¨
```

#### æŸ¥è¯¢å‚æ•°æ–­è¨€
```yaml
predicates:
  - Query=name, .+               # æŸ¥è¯¢å‚æ•°å­˜åœ¨ä¸”åŒ¹é…æ­£åˆ™
  - Query=name                   # æŸ¥è¯¢å‚æ•°å­˜åœ¨
  - Query=!name                  # æŸ¥è¯¢å‚æ•°ä¸å­˜åœ¨
```

#### è¿œç¨‹åœ°å€æ–­è¨€
```yaml
predicates:
  - RemoteAddr=192.168.1.1/24    # è¿œç¨‹åœ°å€åŒ¹é…
  - RemoteAddr=192.168.1.1       # è¿œç¨‹åœ°å€åŒ¹é…
```

### 3. è¿‡æ»¤å™¨ï¼ˆFiltersï¼‰è¯¦è§£

#### å†…ç½®è¿‡æ»¤å™¨
```yaml
filters:
  # è·¯å¾„è¿‡æ»¤å™¨
  - StripPrefix=1                # å»æ‰è·¯å¾„å‰ç¼€
  - PrefixPath=/api              # æ·»åŠ è·¯å¾„å‰ç¼€
  
  # è¯·æ±‚å¤´è¿‡æ»¤å™¨
  - AddRequestHeader=X-Request-Id, ${uuid}
  - AddRequestHeader=X-Response-Time, ${timestamp}
  - RemoveRequestHeader=X-Request-Id
  
  # å“åº”å¤´è¿‡æ»¤å™¨
  - AddResponseHeader=X-Response-Time, ${timestamp}
  - RemoveResponseHeader=X-Response-Time
  
  # è¯·æ±‚å‚æ•°è¿‡æ»¤å™¨
  - AddRequestParameter=name, value
  - RemoveRequestParameter=name
  
  # çŠ¶æ€ç è¿‡æ»¤å™¨
  - SetStatus=401
  
  # é‡å®šå‘è¿‡æ»¤å™¨
  - RedirectTo=302, https://example.com
```

#### è‡ªå®šä¹‰è¿‡æ»¤å™¨
```java
package com.example.gateway.filter;

import org.springframework.cloud.gateway.filter.GatewayFilter;
import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
import org.springframework.stereotype.Component;

@Component
public class CustomFilter extends AbstractGatewayFilterFactory<CustomFilter.Config> {
    
    public CustomFilter() {
        super(Config.class);
    }
    
    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            // å‰ç½®å¤„ç†
            System.out.println("è¯·æ±‚å¼€å§‹æ—¶é—´: " + System.currentTimeMillis());
            
            return chain.filter(exchange)
                    .then(Mono.fromRunnable(() -> {
                        // åç½®å¤„ç†
                        System.out.println("è¯·æ±‚ç»“æŸæ—¶é—´: " + System.currentTimeMillis());
                    }));
        };
    }
    
    public static class Config {
        // é…ç½®å±æ€§
        private String name;
        
        public String getName() {
            return name;
        }
        
        public void setName(String name) {
            this.name = name;
        }
    }
}
```

## ğŸ” è®¤è¯æˆæƒ

### 1. JWTè®¤è¯è¿‡æ»¤å™¨
```java
package com.example.gateway.filter;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.HttpStatus;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
public class JwtAuthFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getPath().value();
        
        // è·³è¿‡ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
        if (isSkipAuth(path)) {
            return chain.filter(exchange);
        }
        
        // è·å–JWT Token
        String token = getToken(request);
        if (!StringUtils.hasText(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        
        // éªŒè¯JWT Token
        if (!validateToken(token)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        
        // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
        ServerHttpRequest modifiedRequest = request.mutate()
                .header("X-User-Id", getUserIdFromToken(token))
                .build();
        
        return chain.filter(exchange.mutate().request(modifiedRequest).build());
    }
    
    @Override
    public int getOrder() {
        return -100; // ä¼˜å…ˆçº§ï¼Œè¶Šå°è¶Šé«˜
    }
    
    private boolean isSkipAuth(String path) {
        return path.startsWith("/auth/") || 
               path.startsWith("/public/") || 
               path.equals("/health");
    }
    
    private String getToken(ServerHttpRequest request) {
        String bearerToken = request.getHeaders().getFirst("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
    
    private boolean validateToken(String token) {
        // å®ç°JWT TokenéªŒè¯é€»è¾‘
        try {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨JWTå·¥å…·ç±»éªŒè¯Token
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    private String getUserIdFromToken(String token) {
        // ä»Tokenä¸­æå–ç”¨æˆ·ID
        // è¿™é‡Œåº”è¯¥è°ƒç”¨JWTå·¥å…·ç±»è§£æToken
        return "user123";
    }
}
```

### 2. è®¤è¯é…ç½®
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/auth/**
          filters:
            - StripPrefix=1
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:
            - StripPrefix=1
            - name: JwtAuth  # è‡ªå®šä¹‰è®¤è¯è¿‡æ»¤å™¨
```

## ğŸš¦ é™æµç†”æ–­

### 1. é™æµé…ç½®
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10  # æ¯ç§’å…è®¸å¤„ç†çš„è¯·æ±‚æ•°é‡
                redis-rate-limiter.burstCapacity: 20  # æ¯ç§’æœ€å¤§å¤„ç†çš„è¯·æ±‚æ•°é‡
                key-resolver: "#{@userKeyResolver}"  # é™æµç­–ç•¥
```

### 2. é™æµç­–ç•¥
```java
package com.example.gateway.config;

import org.springframework.cloud.gateway.filter.ratelimit.KeyResolver;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import reactor.core.publisher.Mono;

@Configuration
public class RateLimiterConfig {
    
    @Bean
    public KeyResolver userKeyResolver() {
        return exchange -> {
            // æ ¹æ®ç”¨æˆ·IDé™æµ
            String userId = exchange.getRequest().getHeaders().getFirst("X-User-Id");
            if (userId != null) {
                return Mono.just(userId);
            }
            // æ ¹æ®IPé™æµ
            String ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();
            return Mono.just(ip);
        };
    }
    
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> {
            String ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();
            return Mono.just(ip);
        };
    }
}
```

### 3. ç†”æ–­é…ç½®
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:
            - name: CircuitBreaker
              args:
                name: user-service-circuit-breaker
                fallbackUri: forward:/fallback/user-service
```

### 4. ç†”æ–­å›é€€
```java
package com.example.gateway.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/fallback")
public class FallbackController {
    
    @GetMapping("/user-service")
    public String userServiceFallback() {
        return "ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•";
    }
    
    @GetMapping("/order-service")
    public String orderServiceFallback() {
        return "è®¢å•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•";
    }
}
```

## ğŸ“Š ç›‘æ§æ—¥å¿—

### 1. è®¿é—®æ—¥å¿—è¿‡æ»¤å™¨
```java
package com.example.gateway.filter;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

@Component
public class AccessLogFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        long startTime = System.currentTimeMillis();
        String path = exchange.getRequest().getPath().value();
        String method = exchange.getRequest().getMethod().name();
        String remoteAddr = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();
        
        return chain.filter(exchange)
                .then(Mono.fromRunnable(() -> {
                    long endTime = System.currentTimeMillis();
                    long duration = endTime - startTime;
                    int status = exchange.getResponse().getStatusCode().value();
                    
                    System.out.printf("è®¿é—®æ—¥å¿—: %s %s %s %d %dms%n", 
                                    remoteAddr, method, path, status, duration);
                }));
    }
    
    @Override
    public int getOrder() {
        return Ordered.LOWEST_PRECEDENCE; // æœ€ä½ä¼˜å…ˆçº§ï¼Œæœ€åæ‰§è¡Œ
    }
}
```

### 2. ç›‘æ§ç«¯ç‚¹é…ç½®
```yaml
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

### 3. è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡
```java
package com.example.gateway.metrics;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import org.springframework.stereotype.Component;

@Component
public class GatewayMetrics {
    
    private final Counter requestCounter;
    private final Counter errorCounter;
    
    public GatewayMetrics(MeterRegistry meterRegistry) {
        this.requestCounter = Counter.builder("gateway_requests_total")
                .description("ç½‘å…³æ€»è¯·æ±‚æ•°")
                .register(meterRegistry);
        
        this.errorCounter = Counter.builder("gateway_errors_total")
                .description("ç½‘å…³é”™è¯¯è¯·æ±‚æ•°")
                .register(meterRegistry);
    }
    
    public void incrementRequestCount() {
        requestCounter.increment();
    }
    
    public void incrementErrorCount() {
        errorCounter.increment();
    }
}
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. è·¯ç”±ä¸ç”Ÿæ•ˆ
**é—®é¢˜ï¼š** é…ç½®çš„è·¯ç”±æ— æ³•æ­£å¸¸è½¬å‘
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# æ£€æŸ¥è·¯ç”±é…ç½®
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service  # ç¡®ä¿æœåŠ¡åæ­£ç¡®
          predicates:
            - Path=/user/**        # ç¡®ä¿è·¯å¾„åŒ¹é…æ­£ç¡®
          filters:
            - StripPrefix=1

# æ£€æŸ¥æœåŠ¡å‘ç°
spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
```

### 2. è¿‡æ»¤å™¨ä¸æ‰§è¡Œ
**é—®é¢˜ï¼š** è‡ªå®šä¹‰è¿‡æ»¤å™¨æ²¡æœ‰æ‰§è¡Œ
**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ç¡®ä¿è¿‡æ»¤å™¨å®ç°äº†æ­£ç¡®çš„æ¥å£
@Component
public class CustomFilter implements GlobalFilter, Ordered {
    
    @Override
    public int getOrder() {
        return -100; // è®¾ç½®åˆé€‚çš„ä¼˜å…ˆçº§
    }
}

// æ£€æŸ¥è¿‡æ»¤å™¨æ˜¯å¦è¢«Springæ‰«æåˆ°
@SpringBootApplication
@ComponentScan(basePackages = "com.example.gateway")
public class GatewayApplication {
    // ...
}
```

### 3. é™æµä¸ç”Ÿæ•ˆ
**é—®é¢˜ï¼š** é…ç½®çš„é™æµæ²¡æœ‰ç”Ÿæ•ˆ
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# æ£€æŸ¥é™æµé…ç½®
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                key-resolver: "#{@userKeyResolver}"

# ç¡®ä¿Rediså¯ç”¨
spring:
  redis:
    host: localhost
    port: 6379
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. è·¯ç”±è®¾è®¡åŸåˆ™
```
âœ… æ¨èè®¾è®¡ï¼š
- æŒ‰ä¸šåŠ¡æ¨¡å—åˆ’åˆ†è·¯ç”±
- ä½¿ç”¨RESTfulé£æ ¼çš„è·¯å¾„
- ç»Ÿä¸€è·¯å¾„å‰ç¼€ç®¡ç†
- åˆç†çš„è·¯å¾„å±‚çº§

âŒ é¿å…è®¾è®¡ï¼š
- è·¯å¾„è¿‡äºå¤æ‚
- ç¡¬ç¼–ç æœåŠ¡åœ°å€
- ç¼ºå°‘è·¯å¾„å‰ç¼€
```

### 2. è¿‡æ»¤å™¨ä½¿ç”¨åŸåˆ™
```
âœ… æ¨èä½¿ç”¨ï¼š
- å…¨å±€è¿‡æ»¤å™¨å¤„ç†é€šç”¨é€»è¾‘
- è·¯ç”±è¿‡æ»¤å™¨å¤„ç†ç‰¹å®šé€»è¾‘
- åˆç†çš„è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº
- é¿å…è¿‡æ»¤å™¨é—´çš„å¾ªç¯ä¾èµ–

âŒ é¿å…ä½¿ç”¨ï¼š
- è¿‡æ»¤å™¨é€»è¾‘è¿‡äºå¤æ‚
- è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ··ä¹±
- è¿‡æ»¤å™¨æŠ›å‡ºå¼‚å¸¸
```

### 3. æ€§èƒ½ä¼˜åŒ–
```java
// ä½¿ç”¨å¼‚æ­¥å¤„ç†
@Component
public class AsyncFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        return Mono.defer(() -> {
            // å¼‚æ­¥å¤„ç†é€»è¾‘
            return chain.filter(exchange);
        });
    }
}

// ä½¿ç”¨ç¼“å­˜
@Component
public class CacheFilter implements GlobalFilter, Ordered {
    
    private final Cache<String, String> cache = Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(1, TimeUnit.HOURS)
            .build();
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String key = exchange.getRequest().getPath().value();
        String cached = cache.getIfPresent(key);
        
        if (cached != null) {
            exchange.getResponse().setStatusCode(HttpStatus.OK);
            return exchange.getResponse().writeWith(
                Mono.just(exchange.getResponse().bufferFactory().wrap(cached.getBytes()))
            );
        }
        
        return chain.filter(exchange);
    }
}
```

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [è´Ÿè½½å‡è¡¡](./06.è´Ÿè½½å‡è¡¡.md) - å­¦ä¹ è´Ÿè½½å‡è¡¡
- [æœåŠ¡è°ƒç”¨](./07.æœåŠ¡è°ƒç”¨.md) - å­¦ä¹ æœåŠ¡é—´è°ƒç”¨
- [ç†”æ–­å™¨](./08.ç†”æ–­å™¨.md) - å­¦ä¹ ç†”æ–­é™çº§

---

**è®°ä½ï¼šæœåŠ¡ç½‘å…³æ˜¯å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼ŒæŒæ¡å®ƒå°±èƒ½å®ç°ç»Ÿä¸€çš„æµé‡æ§åˆ¶ï¼** ğŸ¯
