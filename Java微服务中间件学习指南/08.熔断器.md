# ç†”æ–­å™¨

## ğŸ¯ ä»€ä¹ˆæ˜¯ç†”æ–­å™¨ï¼Ÿ

ç†”æ–­å™¨æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ï¼Œå½“æœåŠ¡è°ƒç”¨å¤±è´¥ç‡è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œä¼šå¿«é€Ÿå¤±è´¥ï¼Œé¿å…çº§è”æ•…éšœã€‚

### åŸºæœ¬æ¦‚å¿µ
```
ç†”æ–­å™¨ = æ•…éšœæ£€æµ‹ + å¿«é€Ÿå¤±è´¥ + è‡ªåŠ¨æ¢å¤ + é™çº§å¤„ç†
```

**ç®€å•ç†è§£ï¼š**
- å°±åƒå®¶é‡Œçš„ä¿é™©ä¸ï¼Œç”µæµè¿‡å¤§æ—¶ä¼šè‡ªåŠ¨æ–­å¼€
- å½“æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œå¿«é€Ÿè¿”å›å¤±è´¥ï¼Œä¸ç­‰å¾…è¶…æ—¶
- ä¿æŠ¤ç³»ç»Ÿä¸è¢«æ•…éšœæœåŠ¡æ‹–å®
- æä¾›é™çº§æ–¹æ¡ˆï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨

## ğŸ”§ ä¸»æµç†”æ–­å™¨å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”è¡¨
| ç‰¹æ€§ | Hystrix | Sentinel | Resilience4j | Circuit Breaker |
|------|---------|----------|---------------|-----------------|
| çŠ¶æ€ | åœæ­¢ç»´æŠ¤ | æ´»è·ƒ | æ´»è·ƒ | æ´»è·ƒ |
| æ˜“ç”¨æ€§ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| åŠŸèƒ½ä¸°å¯Œåº¦ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| Springé›†æˆ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |

### é€‰æ‹©å»ºè®®
- **Hystrix**ï¼šå·²åœæ­¢ç»´æŠ¤ï¼Œä¸æ¨èæ–°é¡¹ç›®ä½¿ç”¨
- **Sentinel**ï¼šé˜¿é‡Œå·´å·´å¼€æºï¼ŒåŠŸèƒ½æœ€å…¨é¢
- **Resilience4j**ï¼šæ–°ä¸€ä»£ç†”æ–­å™¨ï¼ŒSpring Cloudæ¨è
- **Circuit Breaker**ï¼šSpring Cloudå®˜æ–¹ï¼ŒåŠŸèƒ½ç›¸å¯¹ç®€å•

## ğŸš€ Resilience4j ç†”æ–­å™¨

### åŸºæœ¬é…ç½®
```xml
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot2</artifactId>
</dependency>
```

### ç†”æ–­å™¨é…ç½®
```yaml
resilience4j:
  circuitbreaker:
    instances:
      user-service:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 5s
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
```

### åŸºç¡€ä½¿ç”¨
```java
@Service
public class UserServiceClient {
    
    @CircuitBreaker(name = "user-service", fallbackMethod = "getUserInfoFallback")
    public String getUserInfo(String userId) {
        // è°ƒç”¨ç”¨æˆ·æœåŠ¡
        String url = "http://user-service/user/info/" + userId;
        return restTemplate.getForObject(url, String.class);
    }
    
    public String getUserInfoFallback(String userId, Exception e) {
        return "ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œç”¨æˆ·ID: " + userId;
    }
}
```

## ğŸš€ Sentinel ç†”æ–­å™¨

### åŸºæœ¬é…ç½®
```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

### ç†”æ–­å™¨é…ç½®
```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080
      datasource:
        ds:
          nacos:
            server-addr: localhost:8848
            dataId: sentinel-rules
            groupId: DEFAULT_GROUP
            rule-type: flow
```

### åŸºç¡€ä½¿ç”¨
```java
@Service
public class UserServiceClient {
    
    @SentinelResource(
        value = "getUserInfo",
        fallback = "getUserInfoFallback",
        blockHandler = "getUserInfoBlockHandler"
    )
    public String getUserInfo(String userId) {
        String url = "http://user-service/user/info/" + userId;
        return restTemplate.getForObject(url, String.class);
    }
    
    public String getUserInfoFallback(String userId, Throwable e) {
        return "ç”¨æˆ·æœåŠ¡å¼‚å¸¸ï¼Œç”¨æˆ·ID: " + userId;
    }
    
    public String getUserInfoBlockHandler(String userId, BlockException e) {
        return "ç”¨æˆ·æœåŠ¡è¢«é™æµï¼Œç”¨æˆ·ID: " + userId;
    }
}
```

## ğŸš¦ ç†”æ–­å™¨çŠ¶æ€

### ä¸‰ç§çŠ¶æ€
```
å…³é—­çŠ¶æ€ï¼ˆClosedï¼‰
â”œâ”€â”€ æ­£å¸¸è°ƒç”¨æœåŠ¡
â”œâ”€â”€ ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
â””â”€â”€ å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶è½¬ä¸ºå¼€å¯çŠ¶æ€

å¼€å¯çŠ¶æ€ï¼ˆOpenï¼‰
â”œâ”€â”€ å¿«é€Ÿå¤±è´¥ï¼Œä¸è°ƒç”¨æœåŠ¡
â”œâ”€â”€ ç­‰å¾…æ—¶é—´åè½¬ä¸ºåŠå¼€çŠ¶æ€
â””â”€â”€ æä¾›é™çº§å“åº”

åŠå¼€çŠ¶æ€ï¼ˆHalf-Openï¼‰
â”œâ”€â”€ å…è®¸å°‘é‡è¯·æ±‚è°ƒç”¨æœåŠ¡
â”œâ”€â”€ æˆåŠŸç‡é«˜æ—¶è½¬ä¸ºå…³é—­çŠ¶æ€
â””â”€â”€ å¤±è´¥ç‡é«˜æ—¶è½¬ä¸ºå¼€å¯çŠ¶æ€
```

### çŠ¶æ€è½¬æ¢
```
å…³é—­ â†’ å¼€å¯ï¼šå¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼
å¼€å¯ â†’ åŠå¼€ï¼šç­‰å¾…æ—¶é—´åˆ°è¾¾
åŠå¼€ â†’ å…³é—­ï¼šæˆåŠŸç‡é«˜
åŠå¼€ â†’ å¼€å¯ï¼šå¤±è´¥ç‡é«˜
```

## ğŸ’» ç†”æ–­å™¨å®ç°

### 1. åŸºç¡€ç†”æ–­å™¨
```java
@Component
public class CircuitBreakerService {
    
    @CircuitBreaker(name = "user-service", fallbackMethod = "fallback")
    public String callUserService(String userId) {
        // æ¨¡æ‹ŸæœåŠ¡è°ƒç”¨
        if (Math.random() < 0.3) {
            throw new RuntimeException("æœåŠ¡è°ƒç”¨å¤±è´¥");
        }
        return "ç”¨æˆ·ä¿¡æ¯: " + userId;
    }
    
    public String fallback(String userId, Exception e) {
        return "é™çº§å“åº”: ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨ï¼Œç”¨æˆ·ID: " + userId;
    }
}
```

### 2. è¶…æ—¶ç†”æ–­å™¨
```java
@Component
public class TimeoutCircuitBreakerService {
    
    @TimeLimiter(name = "user-service")
    @CircuitBreaker(name = "user-service", fallbackMethod = "fallback")
    public CompletableFuture<String> callUserServiceWithTimeout(String userId) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                Thread.sleep(2000); // æ¨¡æ‹Ÿæ…¢è°ƒç”¨
                return "ç”¨æˆ·ä¿¡æ¯: " + userId;
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        });
    }
    
    public CompletableFuture<String> fallback(String userId, Exception e) {
        return CompletableFuture.completedFuture("è¶…æ—¶é™çº§: ç”¨æˆ·æœåŠ¡å“åº”è¶…æ—¶");
    }
}
```

### 3. é‡è¯•ç†”æ–­å™¨
```java
@Component
public class RetryCircuitBreakerService {
    
    @Retry(name = "user-service", fallbackMethod = "fallback")
    @CircuitBreaker(name = "user-service", fallbackMethod = "fallback")
    public String callUserServiceWithRetry(String userId) {
        // æ¨¡æ‹ŸæœåŠ¡è°ƒç”¨
        if (Math.random() < 0.5) {
            throw new RuntimeException("æœåŠ¡è°ƒç”¨å¤±è´¥");
        }
        return "ç”¨æˆ·ä¿¡æ¯: " + userId;
    }
    
    public String fallback(String userId, Exception e) {
        return "é‡è¯•é™çº§: ç”¨æˆ·æœåŠ¡å¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥";
    }
}
```

## ğŸ”„ é™çº§ç­–ç•¥

### 1. é™æ€é™çº§
```java
@Service
public class StaticFallbackService {
    
    @CircuitBreaker(name = "user-service", fallbackMethod = "staticFallback")
    public String getUserInfo(String userId) {
        String url = "http://user-service/user/info/" + userId;
        return restTemplate.getForObject(url, String.class);
    }
    
    public String staticFallback(String userId, Exception e) {
        // è¿”å›é™æ€æ•°æ®
        return "{\"userId\":\"" + userId + "\",\"username\":\"é»˜è®¤ç”¨æˆ·\",\"status\":\"é™çº§\"}";
    }
}
```

### 2. ç¼“å­˜é™çº§
```java
@Service
public class CacheFallbackService {
    
    private final Map<String, String> cache = new ConcurrentHashMap<>();
    
    @CircuitBreaker(name = "user-service", fallbackMethod = "cacheFallback")
    public String getUserInfo(String userId) {
        String url = "http://user-service/user/info/" + userId;
        String result = restTemplate.getForObject(url, String.class);
        cache.put(userId, result);
        return result;
    }
    
    public String cacheFallback(String userId, Exception e) {
        // è¿”å›ç¼“å­˜æ•°æ®
        return cache.getOrDefault(userId, "ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨");
    }
}
```

### 3. å¼‚æ­¥é™çº§
```java
@Service
public class AsyncFallbackService {
    
    @Async
    @CircuitBreaker(name = "user-service", fallbackMethod = "asyncFallback")
    public CompletableFuture<String> getUserInfoAsync(String userId) {
        String url = "http://user-service/user/info/" + userId;
        String result = restTemplate.getForObject(url, String.class);
        return CompletableFuture.completedFuture(result);
    }
    
    public CompletableFuture<String> asyncFallback(String userId, Exception e) {
        // å¼‚æ­¥é™çº§å¤„ç†
        return CompletableFuture.supplyAsync(() -> {
            // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
            try {
                Thread.sleep(100);
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
            }
            return "å¼‚æ­¥é™çº§: ç”¨æˆ·æœåŠ¡ä¸å¯ç”¨";
        });
    }
}
```

## ğŸ“Š ç›‘æ§å’ŒæŒ‡æ ‡

### 1. ç†”æ–­å™¨æŒ‡æ ‡
```java
@Component
public class CircuitBreakerMetrics {
    
    private final MeterRegistry meterRegistry;
    
    public CircuitBreakerMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }
    
    public void recordMetrics(String circuitBreakerName, CircuitBreaker.State state) {
        Counter.builder("circuitbreaker_state_changes")
                .tag("name", circuitBreakerName)
                .tag("state", state.name())
                .register(meterRegistry)
                .increment();
    }
}
```

### 2. å¥åº·æ£€æŸ¥
```java
@Component
public class CircuitBreakerHealthIndicator implements HealthIndicator {
    
    private final CircuitBreakerRegistry circuitBreakerRegistry;
    
    public CircuitBreakerHealthIndicator(CircuitBreakerRegistry circuitBreakerRegistry) {
        this.circuitBreakerRegistry = circuitBreakerRegistry;
    }
    
    @Override
    public Health health() {
        Map<String, Object> details = new HashMap<>();
        
        circuitBreakerRegistry.getAllCircuitBreakers().forEach((name, circuitBreaker) -> {
            details.put(name + ".state", circuitBreaker.getState());
            details.put(name + ".failureRate", circuitBreaker.getMetrics().getFailureRate());
        });
        
        return Health.up()
                .withDetails(details)
                .build();
    }
}
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. ç†”æ–­å™¨ä¸ç”Ÿæ•ˆ
**é—®é¢˜ï¼š** ç†”æ–­å™¨é…ç½®ä¸ç”Ÿæ•ˆ
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# æ£€æŸ¥é…ç½®
resilience4j:
  circuitbreaker:
    instances:
      user-service:
        sliding-window-size: 10
        failure-rate-threshold: 50
```

### 2. é™çº§æ–¹æ³•ä¸æ‰§è¡Œ
**é—®é¢˜ï¼š** é™çº§æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨
**è§£å†³æ–¹æ¡ˆï¼š**
```java
// ç¡®ä¿æ–¹æ³•ç­¾åæ­£ç¡®
@CircuitBreaker(name = "user-service", fallbackMethod = "fallback")
public String getUserInfo(String userId) {
    // ä¸šåŠ¡é€»è¾‘
}

// é™çº§æ–¹æ³•ç­¾åå¿…é¡»åŒ¹é…
public String fallback(String userId, Exception e) {
    return "é™çº§å“åº”";
}
```

### 3. ç†”æ–­å™¨çŠ¶æ€å¼‚å¸¸
**é—®é¢˜ï¼š** ç†”æ–­å™¨çŠ¶æ€è½¬æ¢å¼‚å¸¸
**è§£å†³æ–¹æ¡ˆï¼š**
```yaml
# è°ƒæ•´é…ç½®å‚æ•°
resilience4j:
  circuitbreaker:
    instances:
      user-service:
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ç†”æ–­å™¨é…ç½®
```
âœ… æ¨èé…ç½®ï¼š
- åˆç†çš„å¤±è´¥ç‡é˜ˆå€¼ï¼ˆ20-50%ï¼‰
- é€‚å½“çš„æ»‘åŠ¨çª—å£å¤§å°ï¼ˆ10-100ï¼‰
- åˆç†çš„ç­‰å¾…æ—¶é—´ï¼ˆ5-30ç§’ï¼‰
- å¯ç”¨è‡ªåŠ¨çŠ¶æ€è½¬æ¢

âŒ é¿å…é…ç½®ï¼š
- è¿‡ä½çš„å¤±è´¥ç‡é˜ˆå€¼
- è¿‡å°çš„æ»‘åŠ¨çª—å£
- è¿‡é•¿çš„ç­‰å¾…æ—¶é—´
```

### 2. é™çº§ç­–ç•¥
```
âœ… æ¨èç­–ç•¥ï¼š
- é™æ€é™çº§ï¼šè¿”å›é»˜è®¤æ•°æ®
- ç¼“å­˜é™çº§ï¼šè¿”å›ç¼“å­˜æ•°æ®
- å¼‚æ­¥é™çº§ï¼šå¼‚æ­¥å¤„ç†é™çº§é€»è¾‘
- å¤šçº§é™çº§ï¼šæä¾›å¤šä¸ªé™çº§æ–¹æ¡ˆ

âŒ é¿å…ç­–ç•¥ï¼š
- ç©ºé™çº§ï¼šä»€ä¹ˆéƒ½ä¸è¿”å›
- å¼‚å¸¸é™çº§ï¼šé™çº§æ–¹æ³•æŠ›å‡ºå¼‚å¸¸
- å¤æ‚é™çº§ï¼šé™çº§é€»è¾‘è¿‡äºå¤æ‚
```

### 3. ç›‘æ§å‘Šè­¦
```
âœ… æ¨èç›‘æ§ï¼š
- ç†”æ–­å™¨çŠ¶æ€å˜åŒ–
- å¤±è´¥ç‡ç»Ÿè®¡
- å“åº”æ—¶é—´ç›‘æ§
- é™çº§æ¬¡æ•°ç»Ÿè®¡

âŒ é¿å…ç›‘æ§ï¼š
- å¿½ç•¥ç†”æ–­å™¨æŒ‡æ ‡
- ç¼ºå°‘å‘Šè­¦æœºåˆ¶
- ä¸è®°å½•é™çº§æ—¥å¿—
```

## ğŸ”— ä¸‹ä¸€æ­¥å­¦ä¹ 

- [åˆ†å¸ƒå¼äº‹åŠ¡](./09.åˆ†å¸ƒå¼äº‹åŠ¡.md) - å­¦ä¹ äº‹åŠ¡ç®¡ç†
- [æ¶ˆæ¯é˜Ÿåˆ—](./10.æ¶ˆæ¯é˜Ÿåˆ—.md) - å­¦ä¹ å¼‚æ­¥é€šä¿¡
- [é“¾è·¯è¿½è¸ª](./11.é“¾è·¯è¿½è¸ª.md) - å­¦ä¹ åˆ†å¸ƒå¼è¿½è¸ª

---

**è®°ä½ï¼šç†”æ–­å™¨æ˜¯å¾®æœåŠ¡å®¹é”™çš„åŸºç¡€ï¼ŒæŒæ¡å®ƒå°±èƒ½æé«˜ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼** ğŸ¯
