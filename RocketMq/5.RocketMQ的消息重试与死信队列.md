å¥½çš„ï¼æ¥ä¸‹æ¥æˆ‘ä¼šè¯¦ç»†è®²è§£ **"RocketMQçš„æ¶ˆæ¯é‡è¯•ä¸æ­»ä¿¡é˜Ÿåˆ—"** â€”â€” è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨å®é™…å¼€å‘ä¸­éå¸¸é‡è¦ï¼Œå°¤å…¶å¤„ç†æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥åœºæ™¯æ—¶ã€‚æˆ‘ä¼šç”¨ç”µå•†ç³»ç»Ÿä¸­çš„è®¢å•è¶…æ—¶å–æ¶ˆæ¡ˆä¾‹æ¥è¯´æ˜ï¼Œä¿è¯é€šä¿—æ˜“æ‡‚ï¼

---

### ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é‡è¯•ï¼Ÿ
æƒ³è±¡å¿«é€’å‘˜ç»™ä½ é€å¿«é€’çš„åœºæ™¯ï¼š
1. ç¬¬ä¸€æ¬¡é€è´§ï¼ˆ11:00ï¼‰ğŸ‘‰ ä½ ä¸åœ¨å®¶ï¼ˆæ¶ˆè´¹å¤±è´¥ï¼‰
2. 30åˆ†é’Ÿåç¬¬äºŒæ¬¡é€è´§ï¼ˆ11:30ï¼‰ğŸ‘‰ ä½ è¿˜åœ¨å¼€ä¼šï¼ˆåˆå¤±è´¥ï¼‰
3. 1å°æ—¶åç¬¬ä¸‰æ¬¡é€è´§ï¼ˆ12:30ï¼‰ğŸ‘‰ ç»ˆäºæˆåŠŸç­¾æ”¶

æ¶ˆæ¯é˜Ÿåˆ—åŒæ ·éœ€è¦è¿™ç§"é‡è¯•æœºåˆ¶"æ¥å¤„ç†ä¸´æ—¶æ€§æ•…éšœï¼ˆå¦‚ç½‘ç»œæŠ–åŠ¨ã€æ•°æ®åº“ç¹å¿™ç­‰ï¼‰ã€‚

---

### äºŒã€RocketMQçš„é‡è¯•æœºåˆ¶
#### 1. æ™®é€šæ¶ˆæ¯çš„é‡è¯•ï¼ˆéé¡ºåºæ¶ˆæ¯ï¼‰
```java
// æ¶ˆè´¹è€…è¿”å›RECONSUME_LATERè§¦å‘é‡è¯•
consumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -> {
    try {
        // ä¸šåŠ¡å¤„ç†...
        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
    } catch (Exception e) {
        return ConsumeConcurrentlyStatus.RECONSUME_LATER; // è§¦å‘é‡è¯•
    }
});
```
- **é‡è¯•é—´éš”**ï¼š2sã€5sã€10sã€30s... é€æ¸å»¶é•¿ï¼ˆå…±16æ¬¡ï¼‰
- **é‡è¯•é˜Ÿåˆ—**ï¼šè‡ªåŠ¨åˆ›å»º`%RETRY%+æ¶ˆè´¹è€…ç»„å`çš„Topic

#### 2. é¡ºåºæ¶ˆæ¯çš„é‡è¯•
```java
// é¡ºåºæ¶ˆæ¯è¦æŠ›å‡ºå¼‚å¸¸æ‰ä¼šé‡è¯•
consumer.registerMessageListener(new MessageListenerOrderly() {
    @Override
    public ConsumeOrderlyStatus consumeMessage(List<MessageExt> msgs, ConsumeOrderlyContext context) {
        throw new RuntimeException("æ¨¡æ‹Ÿæ¶ˆè´¹å¤±è´¥"); // è‡ªåŠ¨é‡è¯•
    }
});
```
- **ç‰¹ç‚¹**ï¼šä¼šé˜»å¡è¯¥é˜Ÿåˆ—å…¶ä»–æ¶ˆæ¯ï¼ˆä¿è¯é¡ºåºæ€§ï¼‰

---

### ä¸‰ã€æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead Letter Queueï¼‰
å½“æ¶ˆæ¯é‡è¯•16æ¬¡ä»å¤±è´¥åï¼Œä¼šè¿›å…¥"æ­»ä¿¡é˜Ÿåˆ—"ï¼ˆDLQï¼‰ï¼Œå°±åƒå¿«é€’æœ€ç»ˆè¢«é€€å›ä»“åº“ï¼š

#### æ­»ä¿¡é˜Ÿåˆ—ç‰¹æ€§
1. å‘½åè§„åˆ™ï¼š`%DLQ%+æ¶ˆè´¹è€…ç»„å`
2. ä¸ä¼šè‡ªåŠ¨æ¶ˆè´¹ï¼Œéœ€è¦äººå·¥å¤„ç†
3. å­˜å‚¨æ‰€æœ‰å½»åº•å¤±è´¥çš„æ¶ˆæ¯

#### æŸ¥çœ‹æ­»ä¿¡æ¶ˆæ¯ä»£ç ç¤ºä¾‹
```java
// åˆ›å»ºæ­»ä¿¡æ¶ˆè´¹è€…
DefaultMQPushConsumer dlqConsumer = new DefaultMQPushConsumer("dlq_inspect_group");
dlqConsumer.subscribe("%DLQ%order_consumer_group", "*"); // è®¢é˜…æ­»ä¿¡Topic

dlqConsumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -> {
    for (MessageExt msg : msgs) {
        System.out.println("æ­»ä¿¡æ¶ˆæ¯å†…å®¹: " + new String(msg.getBody()));
        System.out.println("åŸå§‹Topic: " + msg.getProperty("ORIGIN_TOPIC"));
        System.out.println("å¤±è´¥åŸå› : " + msg.getProperty("RETRY_TOPIC"));
    }
    return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
});
dlqConsumer.start();
```

---

### å››ã€ç”µå•†æ¡ˆä¾‹å®æˆ˜ï¼ˆè®¢å•è¶…æ—¶å–æ¶ˆï¼‰

#### åœºæ™¯è¯´æ˜
1. ç”¨æˆ·ä¸‹å•åå‘é€å»¶æ—¶æ¶ˆæ¯ï¼š"30åˆ†é’Ÿåæ£€æŸ¥æœªæ”¯ä»˜åˆ™å–æ¶ˆè®¢å•"
2. å¦‚æœæ£€æŸ¥æ—¶æ”¯ä»˜ç³»ç»Ÿç¹å¿™ï¼Œéœ€è¦é‡è¯•
3. æœ€ç»ˆå¤±è´¥åˆ™è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—äººå·¥å¤„ç†

#### ç”Ÿäº§è€…å‘é€å»¶æ—¶æ¶ˆæ¯
```java
Message msg = new Message("OrderTimeoutTopic", orderId.getBytes());
// è®¾ç½®å»¶æ—¶çº§åˆ«ï¼ˆå¯¹åº”30åˆ†é’Ÿï¼‰
msg.setDelayTimeLevel(16); // RocketMQé¢„è®¾çš„16ä¸ªçº§åˆ«ä¹‹ä¸€
producer.send(msg);
```

#### æ¶ˆè´¹è€…å¤„ç†ï¼ˆå¸¦é‡è¯•é€»è¾‘ï¼‰
```java
consumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -> {
    try {
        String orderId = new String(msgs.get(0).getBody());
        if(!paymentService.checkPaid(orderId)) {
            orderService.cancelOrder(orderId); // å–æ¶ˆè®¢å•
            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        }
    } catch (PaymentSystemBusyException e) { 
        // æ”¯ä»˜ç³»ç»Ÿç¹å¿™æ—¶é‡è¯•
        return ConsumeConcurrentlyStatus.RECONSUME_LATER;
    } catch (Exception e) {
        // å…¶ä»–å¼‚å¸¸ä¹Ÿé‡è¯•
        return ConsumeConcurrentlyStatus.RECONSUME_LATER;
    }
});
```

---

### äº”ã€æ ¸å¿ƒåŸç†å›¾

```
Producer â†’ æ™®é€šTopic â†’ Consumer(å¤±è´¥)
                    â†“
                   é‡è¯•Topicï¼ˆ%RETRY%...ï¼‰â†’ 16æ¬¡é‡è¯•
                    â†“
                   æ­»ä¿¡Topicï¼ˆ%DLQ%...ï¼‰
```

---

### å…­ã€æœ€ä½³å®è·µ
1. **é‡è¯•ç­–ç•¥**ï¼š
   - å‰å‡ æ¬¡å¿«é€Ÿé‡è¯•ï¼ˆåº”å¯¹ç½‘ç»œæŠ–åŠ¨ï¼‰
   - åæœŸå»¶é•¿é—´éš”ï¼ˆåº”å¯¹ç³»ç»Ÿæ¢å¤ï¼‰

2. **æ­»ä¿¡å¤„ç†**ï¼š
   - ç›‘æ§æ­»ä¿¡é˜Ÿåˆ—å¤§å°ï¼ˆæŠ¥è­¦é˜ˆå€¼ï¼‰
   - äººå·¥å¤„ç†æˆ–è‡ªåŠ¨ä¿®å¤ï¼ˆå¦‚å†™å…¥æ•°æ®åº“å¾…å¤„ç†ï¼‰

3. **å¹‚ç­‰è®¾è®¡**ï¼š
   ```java
   // ä½¿ç”¨Redisè®°å½•å·²å¤„ç†çš„æ¶ˆæ¯ID
   String msgId = msg.getMsgId();
   if(redis.exists("processed:"+msgId)) {
       return ConsumeConcurrentlyStatus.CONSUME_SUCCESS; 
   }
   // å¤„ç†ä¸šåŠ¡...
   redis.setex("processed:"+msgId, 24*3600, "1");
   ```

---

### ä¸ƒã€å¸¸è§é—®é¢˜è§£ç­”
#### Q1ï¼šé‡è¯•æ¬¡æ•°å¯ä»¥ä¿®æ”¹å—ï¼Ÿ
å¯ä»¥ï¼Œä½†éœ€è¦ä¿®æ”¹Brokeré…ç½®ï¼ˆä¸å»ºè®®ï¼‰ï¼š
```properties
# broker.conf
maxReconsumeTimes=5
```

#### Q2ï¼šæ­»ä¿¡æ¶ˆæ¯èƒ½é‡æ–°æ¶ˆè´¹å—ï¼Ÿ
å¯ä»¥ï¼ç”¨æ™®é€šæ¶ˆè´¹è€…è®¢é˜…æ­»ä¿¡Topicå³å¯ã€‚

#### Q3ï¼šKafkaæœ‰ç±»ä¼¼æœºåˆ¶å—ï¼Ÿ
Kafkaé€šè¿‡`retries`å’Œ`dead letter topic`å®ç°ç±»ä¼¼åŠŸèƒ½ï¼Œä½†éœ€è¦è‡ªè¡Œå¼€å‘ã€‚

---

é€šè¿‡è¿™ä¸ªçŸ¥è¯†ç‚¹ä½ å­¦åˆ°äº†ï¼š
1. æ¶ˆæ¯é‡è¯•çš„è§¦å‘æ¡ä»¶å’Œé—´éš”ç­–ç•¥
2. æ­»ä¿¡é˜Ÿåˆ—çš„ä½œç”¨å’Œè®¿é—®æ–¹å¼
3. å¦‚ä½•åœ¨è®¢å•è¶…æ—¶åœºæ™¯åº”ç”¨
4. ä¿è¯æ¶ˆæ¯å¤„ç†å¹‚ç­‰æ€§çš„æ–¹æ³•

æ¥ä¸‹æ¥æƒ³äº†è§£å“ªä¸ªçŸ¥è¯†ç‚¹ï¼Ÿæ¯”å¦‚ï¼š
- æ¶ˆæ¯è½¨è¿¹ï¼ˆMessage Traceï¼‰å®ç°åŸç†
- Brokerä¸»ä»åŒæ­¥æœºåˆ¶
- å¦‚ä½•è®¾è®¡æ¶ˆæ¯Tagå’ŒKeyï¼Ÿ
